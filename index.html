<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>EBS Input v3-18</title>

  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js" async defer></script>

  <style>
    :root{
      --primary:#2c3e50; --accent:#27ae60; --danger:#c0392b; --bg:#f8f9fa;
      --bridge:#2980b9; --cache:#8e44ad; --test:#e67e22;
    }
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      background:var(--bg); margin:0; padding:10px;
    }
    .container{
      max-width:960px; margin:auto; background:#fff; padding:15px;
      border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.1);
    }

    .branding-row{ margin-bottom:10px; font-size:1.1rem; line-height:1.1; color:var(--primary); }
    .branding-row b{ font-weight:800; }
    .branding-row span{ font-weight:500; font-size:0.75rem; color:#7f8c8d; margin-left:6px; }

    .header-wrap{ display:flex; flex-direction:column; margin-bottom:15px; gap:8px; }
    .header-btns{ display:flex; justify-content:space-between; gap:6px; width:100%; }
    .btn-lookup{
      padding:6px; font-size:0.72rem; border-radius:6px; border:none; color:#fff;
      cursor:pointer; font-weight:700; flex:1; height:52px; line-height:1.1; text-align:center;
      display:flex; align-items:center; justify-content:center; min-width:0;
    }
    .btn-pull{ background:var(--cache); }
    .btn-refresh{ background:var(--bridge); }
    .btn-save{ background:var(--accent); }
    .btn-test{ background:var(--test); }
    .btn-reset{ background:var(--danger); }

    label{ font-size:0.7rem; font-weight:800; display:block; margin-bottom:2px; color:var(--primary); }
    input,select,textarea{
      width:100%; padding:8px; border:1px solid #dcdde1; border-radius:6px; font-size:16px;
      box-sizing:border-box; height:38px; -webkit-text-size-adjust:100%; font-family:inherit;
    }

    .date-input-container{
      display:flex; align-items:center; gap:5px; background:#fff; border:1px solid #dcdde1;
      border-radius:6px; padding:0 8px; height:38px;
    }
    .date-input-container input[type="date"]{
      border:none; padding:0; height:100%; font-size:14px; flex-grow:1; outline:none; background:transparent;
    }

    .flow-display{
      font-size:0.85rem; font-weight:800; color:var(--primary); text-align:center;
      height:38px; line-height:36px; border:1px solid #dcdde1; border-radius:6px;
      background:#f1f2f6; box-sizing:border-box;
    }

    .total-box{ background:#e8f5e9; border:2px dashed var(--accent); padding:10px; border-radius:8px; text-align:center; margin:15px 0; }
    .total-val{ font-size:1.3rem; font-weight:900; color:var(--accent); }

    .actions{ display:grid; grid-template-columns:1fr 1fr 1.2fr; gap:8px; }
    button.action-main{
      padding:10px; border:none; border-radius:6px; font-weight:900; cursor:pointer; color:#fff;
      font-size:0.72rem; -webkit-font-smoothing:antialiased;
    }

    .preview-wrap{ width:100%; overflow-x:auto; margin-top:15px; border:1px solid #ddd; border-radius:6px; }
    table{
      min-width:1400px; width:1400px; border-collapse:collapse; font-size:0.58rem; table-layout:fixed; font-family:inherit;
    }
    th,td{ border:1px solid #eee; padding:6px 4px; text-align:left; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    th{ background:#f2f2f2; font-weight:900 !important; color:var(--primary); font-size:0.58rem !important; }

    /* v3-18 sizing in ch units based on longest observed option strings. */
    .w-edit{ width:38px; text-align:center; }
    .w-group{ width:12ch; }
    .w-type{ width:14ch; }
    .w-day{ width:4ch; text-align:center; }
    .w-date{ width:9ch; }
    .w-flow{ width:6ch; text-align:center; }
    .w-cat{ width:22ch; }
    .w-sort{ width:5ch; text-align:center; }
    .w-acc{ width:22ch; }
    .w-note{ width:44px; text-align:center; cursor:pointer; font-size:1rem; }
    .w-freq{ width:14ch; }
    .w-stat{ width:12ch; }
    .w-cur{ width:7ch; text-align:center; }
    .w-tot{ width:10ch; text-align:right; }
    .w-mnth{ width:6ch; text-align:center; }
    .w-who{ width:10ch; }
    .w-del{ width:44px; text-align:center; }

    #auth_status{ font-size:0.75rem; margin-top:10px; text-align:center; color:var(--primary); font-weight:800; }
    #log_btn{ margin-top:15px; width:100%; background:var(--primary); color:#fff; font-size:0.7rem; border-radius:6px; padding:8px; border:none; font-weight:700; display:block; }
    #trace_log{
      display:none; margin-top:15px; padding:10px; background:#2c3e50; color:#00ff00;
      font-family:"Courier New", monospace; font-size:0.6rem; border-radius:6px; max-height:170px; overflow-y:auto;
      white-space:pre-wrap; cursor:pointer;
    }

    .calc-input-wrap{ display:flex; align-items:center; gap:6px; }
    .btn-calc-trigger{
      background:var(--bridge); color:#fff; border:none; border-radius:6px; height:38px; width:34px;
      cursor:pointer; font-weight:900; font-size:1rem; flex:0 0 auto;
    }

    /* v3-18: iPhone sizing‚Äîwiden Each/Fees by shaving Currency/Multiplier and ¬± */
    @media (max-width: 430px){
      .btn-calc-trigger{ width:28px; }
      #row_each_grid{ grid-template-columns: 1.65fr 0.78fr 1.10fr 0.40fr; gap:6px; }
      #row_each_grid .calc-input-wrap{ gap:5px; }
      #colM{ padding-left:6px; padding-right:6px; }
      #colX{ padding-left:6px; padding-right:6px; }
    }

    /* v3-18: modal overlay (Flow + Calculator + Note) */
    .modal{
      display:none; position:fixed; z-index:2000; left:0; top:0; width:100%; height:100%;
      background:rgba(0,0,0,0.5); align-items:center; justify-content:center; padding:16px; box-sizing:border-box;
    }
    .modal-content{
      background:#fff; width:100%; max-width:520px; border-radius:14px; padding:16px;
      box-shadow:0 8px 30px rgba(0,0,0,0.25);
    }
    .modal-title{ font-size:1.2rem; font-weight:900; color:var(--primary); margin:0 0 10px 0; }
    .modal-actions{ display:flex; gap:10px; margin-top:12px; }
    .btn-modal{
      flex:1; border:none; border-radius:10px; padding:12px 10px; font-weight:900; cursor:pointer; font-size:1rem;
      color:#fff;
    }
    .btn-green{ background:var(--accent); }
    .btn-grey{ background:#7f8c8d; }

    /* Calculator */
    #calc_display{
      width:100%; height:46px; font-size:1.4rem; padding:10px 12px; border:1px solid #dcdde1; border-radius:10px;
      box-sizing:border-box; margin-bottom:12px;
    }
    .calc-grid{
      display:grid; grid-template-columns:repeat(4, 1fr); gap:10px;
    }
    .calc-key{
      height:54px; border:none; border-radius:12px; font-size:1.2rem; font-weight:900; cursor:pointer;
      background:#eef2f7; color:#2c3e50;
    }
    .calc-key.op{ background:#e9f0fb; }
    .calc-key.danger{ background:#f7e6e3; color:#8b2f24; }
    .calc-key.eq{ background:#4f7fb8; color:#fff; }
    .calc-spacer{ height:54px; }
  </style>
</head>

<body>
  <div class="container">
    <div class="header-wrap">
      <div class="branding-row"><b>EBS Input</b> <span>v3-18</span></div>
      <div class="header-btns">
        <button class="btn-lookup btn-pull" onclick="checkEditState(() => cachePull())">Pull local<br/>Lookups</button>
        <button class="btn-lookup btn-refresh" id="refresh_btn" onclick="checkEditState(() => initRefresh())">Refresh<br/>Lookups<br/>from Sheets</button>
        <button class="btn-lookup btn-save" onclick="checkEditState(() => cacheSave())">Save to<br/>local Lookups</button>
        <button class="btn-lookup btn-test" onclick="checkEditState(() => useTestData())">Pull test<br/>Lookups</button>
        <button class="btn-lookup btn-reset" id="resetBtn" onclick="handleResetConfirm()">Reset</button>
      </div>
    </div>

    <div style="display:grid; grid-template-columns: 0.8fr 1fr 1.2fr; gap:10px;">
      <div><label>Type</label><select id="colB" onchange="handleManualType()"></select></div>
      <div><label>Grouping</label><select id="colA"></select></div>
      <div>
        <label>Date</label>
        <div class="date-input-container" onclick="document.getElementById('colC').showPicker()">
          <span>üìÖ</span><input type="date" id="colC" onchange="handleDateChange()" />
        </div>
        <div id="colCDisp" style="font-size:0.65rem; color:#7f8c8d; text-align:center; margin-top:2px;"></div>
      </div>
    </div>

    <div style="display:grid; grid-template-columns: 1fr 0.4fr 0.3fr; gap:10px; margin-top:10px;">
      <div><label>Category</label><select id="colF" required onchange="handleCatTrigger()"></select></div>
      <div><label style="text-align:center;">Flow</label><div id="flowDisplay" class="flow-display">--</div></div>
      <div><label>Sort</label><input type="number" id="colG" placeholder="0" /></div>
    </div>

    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
      <div><label>From</label><select id="colH" required onchange="handleAccTrigger()"></select></div>
      <div><label>To</label><select id="colI" required onchange="handleAccTrigger()"></select></div>
    </div>

    <div style="margin-top:10px;"><label>Note</label><textarea id="colK" rows="2" style="font-size:16px;"></textarea></div>

    <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-top:10px;">
      <div><label>Frequency</label><select id="colFreq"></select></div>
      <div><label>Status</label><select id="colStatus"></select></div>
      <div><label>Month</label><select id="colZ"></select></div>
    </div>

    <div id="row_each_grid" style="display:grid; grid-template-columns:1.2fr 1fr 1.2fr 0.8fr; gap:8px; margin-top:10px;">
      <div>
        <label>Each</label>
        <div class="calc-input-wrap">
          <!-- v3-18: Each focus behaviour -->
          <input type="number" id="colT" placeholder="0.00" step="0.01" onfocus="handleEachFocus('colT')" oninput="calc()" />
          <!-- v3-18: Calculator opens only via ¬± button -->
          <button type="button" class="btn-calc-trigger" onclick="openCalculator('colT')">¬±</button>
        </div>
      </div>
      <div><label>Currency</label><select id="colX" onchange="calc()"></select></div>
      <div>
        <label>Fees</label>
        <div class="calc-input-wrap">
          <input type="number" id="colV" placeholder="0.00" step="0.01" onfocus="handleEachFocus('colV')" oninput="calc()" />
          <!-- v3-18: Fees calculator -->
          <button type="button" class="btn-calc-trigger" onclick="openCalculator('colV')">¬±</button>
        </div>
      </div>
      <div><label>Multiplier</label><input type="number" id="colM" value="1" step="0.01" oninput="calc()" /></div>
    </div>

    <div class="total-box"><div class="total-val"><span id="symbol">¬£</span> <span id="totalDisp">0.00</span></div></div>

    <div class="actions">
      <button class="action-main" onclick="handleMainAction()" style="background:var(--accent);">Create Staging record</button>
      <button class="action-main" id="sync_btn" onclick="checkEditState(() => handleSync())" style="background:var(--bridge);">Send Staging records to Sheets</button>
      <button class="action-main" id="wipeBtn" onclick="handleWipeConfirm()" style="background:var(--danger); opacity:0.85;">Clear Staging records</button>
    </div>

    <div class="preview-wrap" id="previewArea"></div>

    <div id="auth_status">iOS Sync Status: Idle</div>
    <button id="log_btn" onclick="toggleLog(true)">Display Trace Log</button>
    <div id="trace_log" onclick="toggleLog(false)">Trace: v3-18 Logic Circuit Breaker active.</div>
  </div>

  <!-- v3-18 Flow modal (forced overlay) -->
  <div id="flow_modal" class="modal">
    <div class="modal-content">
      <div class="modal-title">Flow cannot be determined</div>
      <div style="font-size:0.95rem; color:#5f6b75; margin-bottom:10px; font-weight:700;">Select manually:</div>
      <select id="modal_flow_select" style="margin-bottom:12px;">
        <option value="xfer">xfer</option>
        <option value="In">In</option>
        <option value="zOut">zOut</option>
      </select>
      <div class="modal-actions">
        <button class="btn-modal btn-green" onclick="commitFlowSelection()">OK</button>
        <button class="btn-modal btn-grey" onclick="closeFlowModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Note modal -->
  <div id="note_modal" class="modal">
    <div class="modal-content">
      <div class="modal-title">Edit Transaction Note</div>
      <textarea id="modal_note_text" rows="5"></textarea>
      <div class="modal-actions">
        <button class="btn-modal btn-green" onclick="commitNote()">Save</button>
        <button class="btn-modal btn-grey" onclick="closeNote()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- v3-18 Calculator modal -->
  <div id="calc_modal" class="modal">
    <div class="modal-content">
      <div class="modal-title">Calculator</div>
      <input id="calc_display" inputmode="decimal" />
      <div class="calc-grid">
        <button class="calc-key danger" onclick="calcKey('C')">C</button>
        <button class="calc-key op" onclick="calcKey('BK')">‚å´</button>
        <button class="calc-key op" onclick="calcKey('/')">√∑</button>
        <button class="calc-key op" onclick="calcKey('*')">√ó</button>

        <button class="calc-key" onclick="calcKey('7')">7</button>
        <button class="calc-key" onclick="calcKey('8')">8</button>
        <button class="calc-key" onclick="calcKey('9')">9</button>
        <button class="calc-key op" onclick="calcKey('-')">‚àí</button>

        <button class="calc-key" onclick="calcKey('4')">4</button>
        <button class="calc-key" onclick="calcKey('5')">5</button>
        <button class="calc-key" onclick="calcKey('6')">6</button>
        <button class="calc-key op" onclick="calcKey('+')">+</button>

        <button class="calc-key" onclick="calcKey('1')">1</button>
        <button class="calc-key" onclick="calcKey('2')">2</button>
        <button class="calc-key" onclick="calcKey('3')">3</button>
        <button class="calc-key eq" onclick="calcKey('=')">=</button>

        <button class="calc-key" onclick="calcKey('0')">0</button>
        <button class="calc-key" onclick="calcKey('.')">.</button>
        <button class="calc-key op" onclick="calcKey('%')">%</button>
        <div class="calc-spacer"></div>
      </div>

      <!-- v3-18: Apply then Close -->
      <div class="modal-actions" style="margin-top:14px;">
        <button class="btn-modal btn-green" onclick="applyCalculator()">Apply</button>
        <button class="btn-modal btn-grey" onclick="closeCalculator()">Close</button>
      </div>
    </div>
  </div>

<script>
  const SHEET_ID = "1DdjG4B8wB9llk7yOoRRO72G0XqHEgFkMIlLuusShA6E";
  const SHEET_TAB = "EBSinput";
  const VER = "Excel Budget Sheet Input (v3-18)";

  let AA_LIST = [];
  let coordinateMap = {};
  let rawLookupData = [];
  let tokenClient;

  let editIndex = -1;
  let pendingEdit = -1;
  let activeNoteIdx = -1;

  let wipeConfirmed = false;
  let resetConfirmed = false;
  let isRestoring = false;

  // v3-18: modal resume state (Flow)
  let flowPendingMode = null; // "create" | "edit"
  let flowPendingForced = null;

  // v3-18: Calculator state
  let calcLastApplied = "0";
  let calcTargetId = "colT"; // "colT" (Each) or "colV" (Fees)

  const symbols = { "GBP":"¬£","EUR":"‚Ç¨","USD":"$","ZAR":"R","CHF":"Fr","THB":"‡∏ø","RUR":"‚ÇΩ","COP":"COL$" };

  function logTrace(msg){
    const log = document.getElementById("trace_log");
    const now = new Date().toLocaleTimeString();
    // v3-18: enforce newline separation (works in Firefox/macOS and iOS)
    log.textContent = (log.textContent || "Trace: v3-18 Logic Circuit Breaker active.") + "\n[" + now + "] " + msg;
    log.scrollTop = log.scrollHeight;
    console.log(msg);
  }

  // v3-18: fatal JS visibility
  window.onerror = function(message, source, lineno, colno){
    logTrace("FATAL: " + message + " @ " + (source||"") + ":" + lineno + ":" + colno + " (v3-18)");
  };
  window.onunhandledrejection = function(ev){
    logTrace("FATAL PROMISE: " + (ev && ev.reason ? (ev.reason.message || ev.reason) : "unknown") + " (v3-18)");
  };

  function toggleLog(show){
    document.getElementById("log_btn").style.display = show ? "none" : "block";
    document.getElementById("trace_log").style.display = show ? "block" : "none";
  }

  function updateStatus(label, state){
    const el = document.getElementById("auth_status");
    el.innerText = "iOS Sync Status: " + label;
    const colors = { idle:"#7f8c8d", active:"#27ae60", sync:"#e67e22", error:"#c0392b" };
    el.style.color = colors[state] || colors.idle;
  }

  function checkEditState(onSuccess){
    if (pendingEdit !== -1 || editIndex !== -1){
      alert("Function locked during Edit.");
      return;
    }
    onSuccess();
  }

  function updateDropdown(id, vals, def, prompt){
    const s = document.getElementById(id);
    let h = prompt ? '<option value="" disabled selected>' + prompt + '</option>' : "";
    h += vals.map(v => '<option value="' + v + '">' + v + "</option>").join("");
    s.innerHTML = h;

    if (def){
      const o = Array.from(s.options).find(opt => opt.value.startsWith(def));
      if (o) s.value = o.value;
    }
  }

  function colToIndex(col){
    let idx = 0;
    for (let i=0;i<col.length;i++) idx = idx*26 + (col.charCodeAt(i)-64);
    return idx-1;
  }

  // ---------- Lookups ----------
  function useTestData(){
    if (!confirm("Load test set?")) return;
    AA_LIST = ["Santander P (AA)", "Revolut P (AA)", "Starling B (AA)"];
    coordinateMap = {"Grouping":{val:0},"Type":{val:1},"Category":{val:2},"From":{val:3},"To":{val:4},"Frequency":{val:5},"Status":{val:6},"Month":{val:7},"Currency":{val:8}};
    rawLookupData = [["INIT"]];

    updateDropdown("colA", ["Roy","Peter","Ev","John","Jose"], "Roy");
    updateDropdown("colB", ["v variable","xf transfer","S Support","aj adjustment","zOut"], "v");
    updateDropdown("colF", ["Card payment","Computer consumables","Support rent","Support Samara","Support","Adjustment"], null, "--Select--");
    updateDropdown("colH", AA_LIST.concat(["@HomeStore","Acronis","Adjustment","FNB Smart","FNB Visa","1Password","Fluid MC","Bank AU","Computer Futures extra"]), null, "--Select--");
    updateDropdown("colI", AA_LIST.concat(["@HomeStore","Acronis","Adjustment","FNB Smart","FNB Visa","1Password","Fluid MC","Bank AU","Computer Futures extra"]), null, "--Select--");
    updateDropdown("colFreq", ["A Ad-hoc","W Weekly","K Keep in credit","M Monthly"], "A");
    updateDropdown("colStatus", ["N Pending","P Paid","aj adjustment"], "N");
    updateDropdown("colZ", ["NEW","JAN","FEB"], "NEW");
    updateDropdown("colX", ["GBP","EUR","USD","ZAR"], "GBP");

    localReset();
    logTrace("Test Lookups loaded. (v3-18)");
  }

  function cacheSave(){
    if (rawLookupData.length === 0){ alert("Refresh Lookups First"); return; }
    if (!confirm("Snapshot values?")) return;
    localStorage.setItem("ebs_cache_data", JSON.stringify(rawLookupData));
    localStorage.setItem("ebs_cache_coords", JSON.stringify(coordinateMap));
    localStorage.setItem("ebs_cache_aa", JSON.stringify(AA_LIST));
    logTrace("Lookup cache saved. (v3-18)");
  }

  function cachePull(){
    if (!confirm("Load local Lookups?")) return;
    const cached = localStorage.getItem("ebs_cache_data");
    if (!cached){ alert("No local Lookups found."); return; }
    rawLookupData = JSON.parse(cached);
    coordinateMap = JSON.parse(localStorage.getItem("ebs_cache_coords") || "{}");
    AA_LIST = JSON.parse(localStorage.getItem("ebs_cache_aa") || "[]");
    populateUI(rawLookupData);
    logTrace("Lookup cache pulled. (v3-18)");
  }

  function populateUI(data){
    const pop = (id, key, def, p=null) => {
      const list = data
        .filter(r => r[coordinateMap[key]?.val])
        .map(r => {
          const v = r[coordinateMap[key].val];
          const d = (coordinateMap[key].desc !== null && coordinateMap[key].desc !== undefined)
            ? r[coordinateMap[key].desc]
            : null;
          return d ? (v + " " + d) : v;
        });
      updateDropdown(id, list, def, p);
    };

    pop("colA","Grouping","Roy");
    if (coordinateMap["Type"]) pop("colB","Type","v");
    else pop("colB","F/U","v");

    pop("colF","Category",null,"--Select--");
    pop("colH","From",null,"--Select--");
    pop("colI","To",null,"--Select--");
    pop("colFreq","Frequency","A");
    pop("colStatus","Status","N");
    pop("colZ","Month","NEW");
    pop("colX","Currency","GBP");

    localReset();
  }

  // ---------- Reset / Init ----------
  function localReset(){
    // v3-18: apply defaults on app refresh same as Reset button
    editIndex = -1;
    pendingEdit = -1;

    ["colT","colV","colG","colK"].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.value = "";
    });

    document.getElementById("colM").value = "1";
    document.getElementById("flowDisplay").innerText = "--";

    const rS = (id, def) => {
      const s = document.getElementById(id);
      if (!s) return;
      if (def){
        const o = Array.from(s.options).find(opt => opt.value.startsWith(def));
        if (o) s.value = o.value;
      } else {
        s.selectedIndex = 0;
      }
    };

    rS("colA","Roy");
    rS("colB","v");
    rS("colF",null);
    rS("colH",null);
    rS("colI",null);
    rS("colFreq","A");
    rS("colStatus","N");
    rS("colZ","NEW");
    rS("colX","GBP");

    calc();
    renderPreview();
    logTrace("UI Fields Reset. (v3-18)");
  }

  function handleResetConfirm(){
    const btn = document.getElementById("resetBtn");
    if (!resetConfirmed){
      resetConfirmed = true;
      btn.innerText = "CONFIRM?";
      setTimeout(() => { resetConfirmed = false; btn.innerText = "Reset"; }, 3000);
      return;
    }
    resetConfirmed = false;
    btn.innerText = "Reset";
    localReset();
  }

  function handleWipeConfirm(){
    const btn = document.getElementById("wipeBtn");
    if (!wipeConfirmed){
      wipeConfirmed = true;
      btn.innerText = "CONFIRM?";
      setTimeout(() => { wipeConfirmed = false; btn.innerText = "Clear Staging records"; }, 3000);
      return;
    }
    wipeConfirmed = false;
    btn.innerText = "Clear Staging records";
    localStorage.removeItem("ebs_trf");
    renderPreview();
    logTrace("Staging wiped manually. (v3-18)");
  }

  // ---------- Field logic ----------
  function handleDateChange(){
    const dStr = document.getElementById("colC").value;
    if (!dStr){ document.getElementById("colCDisp").innerText = ""; return; }
    const [y,m,d] = dStr.split("-").map(Number);
    const dt = new Date(y, m-1, d);
    const day = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][dt.getDay()];
    const mon = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][dt.getMonth()];
    document.getElementById("colCDisp").innerText = day + " " + dt.getDate() + " " + mon + " '" + String(dt.getFullYear()).slice(-2);
  }

  function calc(){
    const t = parseFloat(document.getElementById("colT").value) || 0;
    const u = parseFloat(document.getElementById("colM").value) || 1;
    const v = parseFloat(document.getElementById("colV").value) || 0;
    const tot = ((t*u) + v).toFixed(2);

    const curCode = (document.getElementById("colX").value || "GBP").split(" ")[0];
    document.getElementById("symbol").innerText = symbols[curCode] || "¬£";
    document.getElementById("totalDisp").innerText = tot;
    return tot;
  }

  function handleEachFocus(fieldId){
    const el = document.getElementById(fieldId);
    const raw = (el.value || "").trim();
    const num = parseFloat(raw);
    // v3-18: clear if empty OR numeric zero; else keep and move cursor to end
    if (!raw || (!isNaN(num) && Math.abs(num) < 1e-12)){
      el.value = "";
      return;
    }
    setTimeout(() => {
      try{
        const n = el.value.length;
        el.setSelectionRange(n, n);
      }catch(_){}
    }, 0);
  }

  function handleAccTrigger(){
    if (isRestoring) return;

    const from = document.getElementById("colH").value;
    const to = document.getElementById("colI").value;
    if (!from || !to || from.includes("--") || to.includes("--")) return;

    const fAA = AA_LIST.includes(from);
    const tAA = AA_LIST.includes(to);

    let flow = "zOut";
    if (fAA && tAA) flow = "xfer";
    else if (!fAA && tAA) flow = "In";

    document.getElementById("flowDisplay").innerText = flow;

    if (flow === "xfer"){
      const typeSel = document.getElementById("colB");
      const xf = Array.from(typeSel.options).find(o => o.value.toLowerCase().startsWith("xf"));
      if (xf) typeSel.value = xf.value;
      const catSel = document.getElementById("colF");
      const transferOpt = Array.from(catSel.options).find(o => o.value.toLowerCase().includes("transfer"));
      if (transferOpt) catSel.value = transferOpt.value;
    }
  }

  function handleCatTrigger(){
    if (isRestoring) return;

    const cat = document.getElementById("colF").value || "";
    const lower = cat.toLowerCase();

    if (lower.includes("support")){
      const typeSel = document.getElementById("colB");
      const sOpt = Array.from(typeSel.options).find(o => o.value.startsWith("S"));
      if (sOpt) typeSel.value = sOpt.value;

      // v3-18: Support implies Frequency = Ad-hoc
      const freqSel = document.getElementById("colFreq");
      const aOpt = Array.from(freqSel.options).find(o => o.value.startsWith("A"));
      if (aOpt) freqSel.value = aOpt.value;
    }
  }

  function handleManualType(){
    // reserved for future
  }

  // ---------- Edit / Staging ----------
  function buildRecordFromUI(forcedFlow){
    const flowV = forcedFlow || document.getElementById("flowDisplay").innerText;

    const grouping = document.getElementById("colA").value;
    const typeV = document.getElementById("colB").value;
    const dateISO = document.getElementById("colC").value;
    const category = document.getElementById("colF").value;
    const from = document.getElementById("colH").value;
    const to = document.getElementById("colI").value;

    // v3-18: Who only for support categories
    const who = (category || "").toLowerCase().includes("support") ? grouping : "";

    const rec = Array(35).fill("");
    rec[0] = grouping;
    rec[1] = typeV;
    rec[2] = dateISO;
    rec[4] = flowV;
    rec[5] = category;
    rec[6] = document.getElementById("colG").value;
    rec[7] = from;
    rec[8] = to;
    rec[10] = document.getElementById("colK").value;
    rec[11] = document.getElementById("colFreq").value;
    rec[14] = document.getElementById("colStatus").value;

    rec[19] = parseFloat(document.getElementById("colT").value || 0).toFixed(2);
    rec[20] = document.getElementById("colM").value;
    rec[21] = parseFloat(document.getElementById("colV").value || 0).toFixed(2);
    rec[22] = calc();
    rec[23] = document.getElementById("colX").value;
    rec[25] = document.getElementById("colZ").value;

    rec[33] = who;
    rec[34] = VER;

    return rec;
  }

  function ensureLookupsForCreate(){
    if (rawLookupData.length === 0){
      alert("First Pull local Lookups, or Refresh Lookups from Sheets.");
      return false;
    }
    return true;
  }

  function handleMainAction(forcedFlow){
    logTrace("Action Triggered. (v3-18)");

    if (!ensureLookupsForCreate()) return;

    // v3-18: If edit is in confirm ("...") or active ("C"), allow Create to clone that row and abandon edit
    const masterList = JSON.parse(localStorage.getItem("ebs_trf") || "[]");
    if (pendingEdit !== -1 || editIndex !== -1){
      const cloneIdx = (editIndex !== -1) ? editIndex : pendingEdit;
      if (masterList[cloneIdx]){
        masterList.push([...masterList[cloneIdx]]);
        localStorage.setItem("ebs_trf", JSON.stringify(masterList));
        logTrace("Edit abandoned; record cloned into new staged row. (v3-18)");
        localReset();
        return;
      }
    }

    const fv = document.getElementById("colF").value;
    const hv = document.getElementById("colH").value;
    const iv = document.getElementById("colI").value;

    if (!fv || !hv || !iv || fv.includes("--") || hv.includes("--") || iv.includes("--")){
      alert("Missing data.");
      return;
    }

    const flowV = forcedFlow || document.getElementById("flowDisplay").innerText;
    if (flowV === "--"){
      openFlowModal("create");
      return;
    }

    const finalPackage = buildRecordFromUI(flowV);
    masterList.push(finalPackage);

    localStorage.setItem("ebs_trf", JSON.stringify(masterList));
    logTrace("Logic Update: New Record Appended. (v3-18)");
    logTrace("Storage Synced. (v3-18)");

    localReset();
  }

  function initiateEdit(idx){
    if (!ensureLookupsForCreate()) return;

    if (pendingEdit !== idx){
      pendingEdit = idx;
      editIndex = -1;
      renderPreview();
      logTrace("Edit confirm armed for row " + (idx+1) + ". (v3-18)");
      return;
    }

    pendingEdit = -1;
    editIndex = idx;

    const d = JSON.parse(localStorage.getItem("ebs_trf") || "[]")[idx];
    if (!d){ editIndex = -1; renderPreview(); return; }

    isRestoring = true;

    const setDrop = (id, val) => {
      const el = document.getElementById(id);
      if (!el) return;
      const exact = Array.from(el.options).find(o => o.value === val);
      if (exact){ el.value = exact.value; return; }
      const code = (val || "").split(" ")[0];
      const starts = Array.from(el.options).find(o => o.value.startsWith(code));
      if (starts) el.value = starts.value;
    };

    setDrop("colA", d[0]);
    setDrop("colB", d[1]);
    document.getElementById("colC").value = d[2] || document.getElementById("colC").value;
    setDrop("colF", d[5]);
    document.getElementById("colG").value = d[6] || "";
    setDrop("colH", d[7]);
    setDrop("colI", d[8]);
    document.getElementById("colK").value = d[10] || "";
    setDrop("colFreq", d[11] || "A");
    setDrop("colStatus", d[14] || "N");
    setDrop("colZ", d[25] || "NEW");
    setDrop("colX", d[23] || "GBP");
    document.getElementById("colT").value = d[19] || "";
    document.getElementById("colM").value = d[20] || "1";
    document.getElementById("colV").value = d[21] || "";
    document.getElementById("flowDisplay").innerText = d[4] || "--";

    handleDateChange();
    calc();

    isRestoring = false;
    renderPreview();
    logTrace("Active Edit: row " + (idx+1) + ". (v3-18)");
  }

  function commitEdit(forcedFlow){
    if (editIndex === -1) return;

    const fv = document.getElementById("colF").value;
    const hv = document.getElementById("colH").value;
    const iv = document.getElementById("colI").value;

    if (!fv || !hv || !iv || fv.includes("--") || hv.includes("--") || iv.includes("--")){
      alert("Missing data.");
      return;
    }

    const flowV = forcedFlow || document.getElementById("flowDisplay").innerText;
    if (flowV === "--"){
      openFlowModal("edit");
      return;
    }

    const masterList = JSON.parse(localStorage.getItem("ebs_trf") || "[]");
    const existing = masterList[editIndex];

    const updated = buildRecordFromUI(flowV);

    // v3-18: preserve Who on overwrite when category is not support
    if (!(updated[5] || "").toLowerCase().includes("support") && existing){
      updated[33] = existing[33] || "";
    }

    masterList[editIndex] = updated;
    localStorage.setItem("ebs_trf", JSON.stringify(masterList));
    logTrace("Logic Update: Row " + (editIndex+1) + " Overwritten. (v3-18)");

    localReset();
  }

  function renderPreview(){
    const storageData = JSON.parse(localStorage.getItem("ebs_trf") || "[]");

    let h = "<table><tr>"
      + '<th class="w-edit">Edit</th>'
      + '<th class="w-group">Grouping</th>'
      + '<th class="w-type">Type</th>'
      + '<th class="w-day">Day</th>'
      + '<th class="w-date">Date</th>'
      + '<th class="w-flow">Flow</th>'
      + '<th class="w-cat">Category</th>'
      + '<th class="w-sort">Sort</th>'
      + '<th class="w-acc">From</th>'
      + '<th class="w-acc">To</th>'
      + '<th class="w-note">Note</th>'
      + '<th class="w-freq">Frequency</th>'
      + '<th class="w-stat">Status</th>'
      + '<th class="w-cur">Currency</th>'
      + '<th class="w-tot">Total</th>'
      + '<th class="w-mnth">Month</th>'
      + '<th class="w-who">Who</th>'
      + '<th class="w-del">DEL</th>'
      + "</tr>";

    storageData.forEach((r, idx) => {
      const isPending = (pendingEdit === idx);
      const isEditing = (editIndex === idx);

      const bS = isPending ? "background:#c0392b" : (isEditing ? "background:#f39c12" : "background:#3498db");
      const bL = isPending ? "..." : (isEditing ? "C" : "E");
      const clickFn = isEditing ? "commitEdit()" : ("initiateEdit(" + idx + ")");

      let dNam = "";
      let dStr = "";
      if (r[2]){
        const [y, m, dn] = r[2].split("-").map(Number);
        const dt = new Date(y, m-1, dn);
        dNam = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][dt.getDay()];
        dStr = String(dn).padStart(2,"0") + " " + ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][dt.getMonth()] + " '" + String(dt.getFullYear()).slice(-2);
      }

      const curCode = (r[23] || "").split(" ")[0];
      const noteIcon = r[10] ? "üìÑ" : "‚ñ´Ô∏è";

      h += "<tr>"
        + '<td class="w-edit"><button onclick="' + clickFn + '" style="' + bS + ';color:white;border:none;border-radius:6px;padding:4px 0;width:100%;font-size:0.6rem;font-weight:900;">' + bL + "</button></td>"
        + '<td class="w-group">' + (r[0] || "") + "</td>"
        + '<td class="w-type">' + (r[1] || "") + "</td>"
        + '<td class="w-day">' + dNam + "</td>"
        + '<td class="w-date">' + dStr + "</td>"
        + '<td class="w-flow">' + (r[4] || "") + "</td>"
        + '<td class="w-cat">' + (r[5] || "") + "</td>"
        + '<td class="w-sort">' + (r[6] || "") + "</td>"
        + '<td class="w-acc">' + (r[7] || "") + "</td>"
        + '<td class="w-acc">' + (r[8] || "") + "</td>"
        + '<td class="w-note" onclick="openNote(' + idx + ')">' + noteIcon + "</td>"
        + '<td class="w-freq">' + (r[11] || "") + "</td>"
        + '<td class="w-stat">' + (r[14] || "") + "</td>"
        + '<td class="w-cur">' + curCode + "</td>"
        + '<td class="w-tot">' + (r[22] || "") + "</td>"
        + '<td class="w-mnth">' + (r[25] || "") + "</td>"
        + '<td class="w-who">' + (r[33] || "") + "</td>"
        + '<td class="w-del"><button onclick="deleteRow(' + idx + ')" style="background:#c0392b;color:white;border:none;border-radius:6px;padding:4px 6px;font-weight:900;cursor:pointer;">X</button></td>'
        + "</tr>";
    });

    document.getElementById("previewArea").innerHTML = h + "</table>";
    logTrace("Table Rendered. Active Rows: " + storageData.length + " (v3-18)");
  }

  function deleteRow(i){
    const d = JSON.parse(localStorage.getItem("ebs_trf") || "[]");
    d.splice(i, 1);
    localStorage.setItem("ebs_trf", JSON.stringify(d));
    editIndex = -1;
    pendingEdit = -1;
    renderPreview();
    logTrace("Row deleted: " + (i+1) + " (v3-18)");
  }

  // ---------- Note modal ----------
  function openNote(idx){
    activeNoteIdx = idx;
    const d = JSON.parse(localStorage.getItem("ebs_trf") || "[]");
    document.getElementById("modal_note_text").value = (d[idx] && d[idx][10]) ? d[idx][10] : "";
    document.getElementById("note_modal").style.display = "flex";
  }
  function closeNote(){
    document.getElementById("note_modal").style.display = "none";
    activeNoteIdx = -1;
  }
  function commitNote(){
    const d = JSON.parse(localStorage.getItem("ebs_trf") || "[]");
    if (!d[activeNoteIdx]){ closeNote(); return; }
    d[activeNoteIdx][10] = document.getElementById("modal_note_text").value;
    localStorage.setItem("ebs_trf", JSON.stringify(d));
    closeNote();
    renderPreview();
    logTrace("Note updated. (v3-18)");
  }

  // ---------- Flow modal ----------
  function openFlowModal(mode){
    flowPendingMode = mode || "create";
    document.getElementById("flow_modal").style.display = "flex";
  }
  function closeFlowModal(){
    document.getElementById("flow_modal").style.display = "none";
    flowPendingMode = null;
    flowPendingForced = null;
  }
  function commitFlowSelection(){
    const selected = document.getElementById("modal_flow_select").value;
    document.getElementById("flowDisplay").innerText = selected;
    document.getElementById("flow_modal").style.display = "none";

    const mode = flowPendingMode;
    flowPendingMode = null;

    // v3-18: forcedFlow parameter prevents "Flow blank on first commit" edge case
    if (mode === "edit") commitEdit(selected);
    else handleMainAction(selected);
  }

  // ---------- Calculator ----------
  function openCalculator(targetId){
    calcTargetId = targetId || "colT";
    const cur = (document.getElementById(calcTargetId).value || "").trim();
    calcLastApplied = cur ? cur : "0";
    document.getElementById("calc_display").value = calcLastApplied;
    document.getElementById("calc_modal").style.display = "flex";
    logTrace("Calculator opened. Field=" + calcTargetId + " Seed=" + calcLastApplied + " (v3-18)");
  }
  function closeCalculator(){
    document.getElementById("calc_modal").style.display = "none";
  }
  function calcKey(k){
    const el = document.getElementById("calc_display");
    let v = el.value || "";

    if (k === "C"){ el.value = "0"; return; }
    if (k === "BK"){ el.value = v.length > 1 ? v.slice(0,-1) : "0"; return; }
    if (k === "%"){ v = v + "/100"; el.value = v; return; }

    if (k === "="){
      const res = safeEval(el.value);
      if (res === null) return;
      el.value = String(res);
      return;
    }

    if (v === "0" && "0123456789".includes(k)) v = "";
    el.value = v + k;
  }

  function safeEval(expr){
    try{
      const cleaned = (expr || "")
        .replace(/√ó/g,"*")
        .replace(/√∑/g,"/")
        .replace(/[^0-9+\-*/.%(). ]/g,"");
      const out = Function('"use strict"; return (' + cleaned + ')')();
      if (typeof out !== "number" || !isFinite(out)){ alert("Invalid expression."); return null; }
      const fixed = Number(out.toFixed(2));
      logTrace("Calculator = " + fixed + " (v3-18)");
      return fixed;
    }catch(_){
      alert("Invalid expression.");
      return null;
    }
  }

  function applyCalculator(){
    const el = document.getElementById("calc_display");
    const res = safeEval(el.value);
    if (res === null) return;

    const tgt = document.getElementById(calcTargetId || "colT");
    tgt.value = res.toFixed(2);

    calc();
    closeCalculator();
    logTrace("Calculator applied to " + (calcTargetId || "colT") + ": " + res.toFixed(2) + " (v3-18)");
  }

  // ---------- Google auth / sync ----------
  function gapiLoaded(){
    gapi.load("client", async () => {
      await gapi.client.init({ apiKey: "AIzaSyDvZ1XZw5bZgWSB9zaU7h9Vtn7MhDGFMSM" });
      await gapi.client.load("sheets", "v4");
      logTrace("GAPI Ready. (v3-18)");
    });
  }

  function gisLoaded(){
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: "23231735212-jtgur3sn2ndh798ke00pm2a1d5rkd4eu.apps.googleusercontent.com",
      scope: "https://www.googleapis.com/auth/spreadsheets",
      callback: () => {}
    });
    logTrace("GIS Ready. (v3-18)");
  }

  function initRefresh(){
    requestToken(true, () => fetchLookupRefs());
  }

  function requestToken(forcePrompt, onOk){
    tokenClient.callback = (resp) => {
      if (!resp || !resp.access_token) return;
      const issuedAt = Date.now();
      const expiresIn = resp.expires_in ? Number(resp.expires_in) : 3600;
      localStorage.setItem("g_token", resp.access_token);
      localStorage.setItem("g_token_issued_at", String(issuedAt));
      localStorage.setItem("g_token_expires_in", String(expiresIn));

      gapi.client.setToken({ access_token: resp.access_token });
      onOk();
    };

    const args = forcePrompt ? { prompt: "consent" } : { prompt: "" };
    tokenClient.requestAccessToken(args);
  }

  function ensureTokenThen(onOk){
    const tok = localStorage.getItem("g_token");
    const issuedAt = Number(localStorage.getItem("g_token_issued_at") || "0");
    const exp = Number(localStorage.getItem("g_token_expires_in") || "0");
    const age = (Date.now() - issuedAt) / 1000;

    if (tok && issuedAt && exp && age < (exp - 60)){
      gapi.client.setToken({ access_token: tok });
      onOk();
      return;
    }
    requestToken(true, onOk);
  }

  async function fetchLookupRefs(){
    updateStatus("Fetching Refs...", "sync");
    const res = await gapi.client.sheets.spreadsheets.values.get({
      spreadsheetId: SHEET_ID,
      range: "LookupRefs!A2:C15"
    });

    coordinateMap = {};
    (res.result.values || []).forEach(r => {
      coordinateMap[r[0]] = {
        val: colToIndex(String(r[1] || "").toUpperCase().replace(/[0-9]/g,"")),
        desc: (r[2] && String(r[2]).toLowerCase() !== "n/a") ? colToIndex(String(r[2])) : null
      };
    });

    await fetchActiveAccounts();
  }

  async function fetchActiveAccounts(){
    const res = await gapi.client.sheets.spreadsheets.values.get({
      spreadsheetId: SHEET_ID,
      range: "ActiveAccounts!A2:A500"
    });
    AA_LIST = res.result.values ? res.result.values.flat().filter(v => v) : [];
    await fetchActualData();
  }

  async function fetchActualData(){
    const res = await gapi.client.sheets.spreadsheets.values.get({
      spreadsheetId: SHEET_ID,
      range: "Lookups!A2:AC1000"
    });
    rawLookupData = res.result.values || [];
    populateUI(rawLookupData);
    updateStatus("Token Active", "active");
    alert("Refresh complete.");
  }

  async function handleSync(){
    const d = JSON.parse(localStorage.getItem("ebs_trf") || "[]");
    if (!d.length){ alert("No Staging records."); return; }

    updateStatus("Syncing...", "sync");
    logTrace("Sync started. Rows=" + d.length + " Target=" + SHEET_TAB + " (v3-18)");

    ensureTokenThen(async () => {
      try{
        const meta = await gapi.client.sheets.spreadsheets.values.get({
          spreadsheetId: SHEET_ID,
          range: "'" + SHEET_TAB + "'!A2:A"
        });
        const used = meta.result.values ? meta.result.values.length : 0;
        const startRow = 2 + used;

        const vls = d.map(r => {
          const rc = [...r];

          if (rc[2]){
            const dp = rc[2].split("-");
            rc[2] = dp[2] + "/" + dp[1] + "/" + dp[0];
          }

          [1,5,11,14,23,25].forEach(i => { rc[i] = (rc[i] || "").split(" ")[0]; });
          [7,8].forEach(i => { rc[i] = String(rc[i] || "").replace(/ \(AA\)/g, ""); });
          [19,21,22].forEach(i => { rc[i] = parseFloat(rc[i] || 0); });

          return rc;
        });

        await gapi.client.sheets.spreadsheets.values.update({
          spreadsheetId: SHEET_ID,
          range: "'" + SHEET_TAB + "'!A" + startRow + ":AI" + (startRow + vls.length - 1),
          valueInputOption: "USER_ENTERED",
          resource: { values: vls }
        });

        updateStatus("Token Active", "active");
        logTrace("Sync complete. StartRow=" + startRow + " (v3-18)");
        alert("Sync completed.");
      }catch(e){
        updateStatus("Sync error", "error");
        logTrace("Sync error: " + (e && e.message ? e.message : String(e)) + " (v3-18)");
        alert("Sync failed. Trace log contains details.");
      }
    });
  }

  // ---------- Boot ----------
  async function waitFor(cond, timeoutMs){
    const t0 = Date.now();
    return new Promise((resolve, reject) => {
      const tick = () => {
        if (cond()) return resolve(true);
        if (Date.now() - t0 > timeoutMs) return reject(new Error("Timeout"));
        setTimeout(tick, 50);
      };
      tick();
    });
  }

  async function boot(){
    document.getElementById("colC").value = new Date().toISOString().split("T")[0];
    handleDateChange();
    // v3-18: local reset on refresh ensures defaults (Each/Fees cleared, Multiplier=1, etc.)
    localReset();
    renderPreview();

    try{
      await waitFor(() => typeof gapi !== "undefined", 8000);
      gapiLoaded();
    }catch(_){
      logTrace("GAPI not available. (v3-18)");
    }

    try{
      await waitFor(() => typeof google !== "undefined" && google.accounts && google.accounts.oauth2, 8000);
      gisLoaded();
    }catch(_){
      logTrace("GIS not available. (v3-18)");
    }
  }

  window.addEventListener("load", boot);
</script>
</body>
</html>