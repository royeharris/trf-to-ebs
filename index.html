<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>EBS Entry v3-13</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js" async defer></script>
  <style>
    :root { --primary:#2c3e50; --accent:#27ae60; --danger:#c0392b; --bg:#f8f9fa; --bridge:#2980b9; --cache:#8e44ad; --test:#e67e22; }
    body { font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif; background:var(--bg); margin:0; padding:10px; }
    .container { max-width:960px; margin:auto; background:#fff; padding:15px; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.1); }
    .branding-row { margin-bottom:10px; font-size:1.1rem; line-height:1.1; color:var(--primary); }
    .branding-row b { font-weight:700; }
    .branding-row span { font-weight:400; font-size:0.75rem; color:#7f8c8d; margin-left:5px; }
    .header-wrap { display:flex; flex-direction:column; margin-bottom:15px; gap:8px; }
    .header-btns { display:flex; justify-content:space-between; gap:6px; width:100%; }
    .btn-lookup { padding:2px; font-size:0.72rem; border-radius:6px; border:none; color:white; cursor:pointer; font-weight:600; flex:1; height:50px; line-height:1.1; text-align:center; display:flex; align-items:center; justify-content:center; min-width:0; }
    .btn-pull{ background:var(--cache); } .btn-refresh{ background:var(--bridge); } .btn-save{ background:var(--accent); } .btn-test{ background:var(--test); } .btn-reset{ background:var(--danger); }
    label { font-size:0.7rem; font-weight:700; display:block; margin-bottom:2px; color:var(--primary); }
    input, select, textarea { width:100%; padding:8px; border:1px solid #dcdde1; border-radius:6px; font-size:16px; box-sizing:border-box; height:38px; -webkit-text-size-adjust:100%; font-family:inherit; background:#f0f2f5; }
    textarea { height:auto; background:#fff; }
    .date-input-container { display:flex; align-items:center; gap:5px; background:white; border:1px solid #dcdde1; border-radius:6px; padding:0 8px; height:38px; }
    .date-input-container input[type="date"] { border:none; padding:0; height:100%; font-size:14px; flex-grow:1; outline:none; background:transparent; }
    .flow-display { font-size:0.85rem; font-weight:700; color:var(--primary); text-align:center; height:38px; line-height:36px; border:1px solid #dcdde1; border-radius:6px; background:#f1f2f6; box-sizing:border-box; }
    .total-box { background:#e8f5e9; border:2px dashed var(--accent); padding:10px; border-radius:8px; text-align:center; margin:15px 0; }
    .total-val { font-size:1.3rem; font-weight:800; color:var(--accent); }
    .actions { display:grid; grid-template-columns:1fr 1fr 1.2fr; gap:8px; }
    button.action-main { padding:10px; border:none; border-radius:6px; font-weight:800; cursor:pointer; color:white; font-size:0.72rem; }
    .preview-wrap { width:100%; overflow-x:auto; margin-top:15px; border:1px solid #ddd; border-radius:6px; }
    table { width:1400px; border-collapse:collapse; font-size:0.58rem; table-layout:fixed; }
    th, td { border:1px solid #eee; padding:6px 3px; text-align:left; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    th { background:#f2f2f2; font-weight:800; color:var(--primary); font-size:0.58rem; }
    .w-edit{ width:40px; text-align:center; } .w-grp{ width:10.5ch; } .w-type{ width:10ch; }
    .w-day{ width:5ch; text-align:center; } .w-date{ width:10ch; } .w-flow{ width:6ch; text-align:center; }
    .w-cat{ width:20ch; } .w-sort{ width:6ch; text-align:center; }
    .w-from{ width:22ch; } .w-to{ width:22ch; }
    .w-note{ width:6ch; text-align:center; cursor:pointer; font-size:1rem; }
    .w-freq{ width:14ch; } .w-tot{ width:10ch; text-align:right; } .w-who{ width:10ch; } .w-del{ width:6ch; text-align:center; }
    #auth_status { font-size:0.75rem; margin-top:10px; text-align:center; color:var(--primary); font-weight:700; }
    #log_btn { margin-top:15px; width:100%; background:var(--primary); color:white; font-size:0.7rem; border-radius:6px; padding:10px; border:none; font-weight:700; display:block; }
    #trace_log { display:none; margin-top:15px; padding:10px; background:#2c3e50; color:#00ff00; font-family:"Courier New",monospace; font-size:0.6rem; border-radius:6px; max-height:170px; overflow-y:auto; white-space:pre-wrap; cursor:pointer; }
    .calc-input-wrap { display:flex; align-items:center; gap:4px; }
    .btn-calc-trigger { background:var(--bridge); color:white; border:none; border-radius:4px; height:38px; width:30px; cursor:pointer; font-weight:900; }
    .txt-center{ text-align:center; }
    .modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.5); }
    .modal-content { background:white; margin:10% auto; padding:18px; width:88%; max-width:420px; border-radius:12px; box-shadow:0 4px 20px rgba(0,0,0,0.2); }
    .modal-title { font-weight:800; color:var(--primary); margin-bottom:10px; }
    .modal-row { display:flex; gap:8px; margin-top:10px; }
    .modal-row button { flex:1; border:none; border-radius:8px; padding:10px; font-weight:800; cursor:pointer; color:white; }
    .btn-ok{ background:var(--accent); } .btn-cancel{ background:#7f8c8d; }
    #calc_display { width:100%; font-size:18px; height:44px; padding:8px; border:1px solid #dcdde1; border-radius:8px; background:#fff; box-sizing:border-box; }
    #calc_result { margin-top:8px; font-size:0.85rem; color:#7f8c8d; min-height:18px; }
    .calc-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:8px; margin-top:12px; }
    .calc-grid button { border:none; border-radius:10px; padding:12px 0; font-weight:900; cursor:pointer; background:#f1f2f6; color:var(--primary); }
    .calc-grid button.op { background:#e8eef7; }
    .calc-grid button.danger { background:#fdecea; color:#a94442; }
  </style>
</head>
<body>
<div class="container">
  <div class="header-wrap">
    <div class="branding-row"><b>EBS Input</b> <span>v3-13</span></div>
    <div class="header-btns">
      <button class="btn-lookup btn-pull" onclick="checkEditState(() => cachePull())">Pull local<br>Lookups</button>
      <button class="btn-lookup btn-refresh" id="refresh_btn" onclick="checkEditState(() => initRefresh())">Refresh<br>Lookups<br>from Sheets</button>
      <button class="btn-lookup btn-save" onclick="checkEditState(() => cacheSave())">Save to<br>local Lookups</button>
      <button class="btn-lookup btn-test" onclick="checkEditState(() => useTestData())">Pull test<br>Lookups</button>
      <button class="btn-lookup btn-reset" id="resetBtn" onclick="handleResetConfirm()">Reset</button>
    </div>
  </div>

  <div style="display:grid; grid-template-columns:0.8fr 1fr 1.2fr; gap:10px;">
    <div><label>Type</label><select id="colB" onchange="handleManualFU()"></select></div>
    <div><label>Grouping</label><select id="colA"></select></div>
    <div><label>Date</label>
      <div class="date-input-container" onclick="document.getElementById('colC').showPicker()">
        <span>ðŸ“…</span><input type="date" id="colC" onchange="handleDateChange()">
      </div>
      <div id="colCDisp" style="font-size:0.65rem; color:#7f8c8d; text-align:center; margin-top:2px;"></div>
    </div>
  </div>

  <div style="display:grid; grid-template-columns:1fr 0.4fr 0.3fr; gap:10px; margin-top:10px;">
    <div><label>Category</label><select id="colF" required onchange="handleCatTrigger()"></select></div>
    <div><label style="text-align:center;">Flow</label><div id="flowDisplay" class="flow-display">--</div></div>
    <div><label>Sort</label><input type="number" id="colG" placeholder="0" onfocus="this.value=''"></div>
  </div>

  <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;">
    <div><label>From</label><select id="colH" required onchange="handleAccTrigger()"></select></div>
    <div><label>To</label><select id="colI" required onchange="handleAccTrigger()"></select></div>
  </div>

  <div style="margin-top:10px;"><label>Note</label><textarea id="colK" rows="2" style="font-size:16px;"></textarea></div>

  <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-top:10px;">
    <div><label>Frequency</label><select id="colFreq"></select></div>
    <div><label>Status</label><select id="colStatus"></select></div>
    <div><label>Month</label><select id="colZ"></select></div>
  </div>

  <div style="display:grid; grid-template-columns:1.2fr 1fr 1fr 1fr; gap:8px; margin-top:10px;">
    <div><label>Each</label>
      <div class="calc-input-wrap">
        <input type="number" id="colT" placeholder="0.00" step="0.01" onfocus="this.value=''" oninput="calc()">
        <button class="btn-calc-trigger" onclick="openCalculatorHook()">Â±</button>
      </div>
    </div>
    <div><label>Currency</label><select id="colX" onchange="calc()"></select></div>
    <div><label>Fees</label><input type="number" id="colV" placeholder="0.00" step="0.01" onfocus="this.value=''" oninput="calc()"></div>
    <div><label>Multiplier</label><input type="number" id="colM" value="1" step="0.01" oninput="calc()"></div>
  </div>

  <div class="total-box"><div class="total-val"><span id="symbol">Â£</span> <span id="totalDisp">0.00</span></div></div>

  <div class="actions">
    <button class="action-main" onclick="handleMainAction('create')" style="background:var(--accent);">Create Staging record</button>
    <button class="action-main" id="sync_btn" onclick="checkEditState(() => handleSync())" style="background:var(--bridge);">Send Staging records to Sheets</button>
    <button class="action-main" id="wipeBtn" onclick="handleWipeConfirm()" style="background:var(--danger); opacity:0.85;">Clear Staging records</button>
  </div>

  <div class="preview-wrap" id="previewArea"></div>
  <div id="auth_status">iOS Sync Status: Idle</div>
  <button id="log_btn" onclick="toggleLog(true)">Display Trace Log</button>
  <div id="trace_log" onclick="toggleLog(false)">Trace: v3-13 Logic Circuit Breaker active.</div>
</div>

<!-- Note modal -->
<div id="note_modal" class="modal">
  <div class="modal-content">
    <div class="modal-title">Edit Transaction Note</div>
    <textarea id="modal_note_text" rows="4" style="margin-top:6px;"></textarea>
    <div class="modal-row">
      <button class="btn-ok" onclick="commitNote()">Save Note</button>
      <button class="btn-cancel" onclick="closeNote()">Cancel</button>
    </div>
  </div>
</div>

<!-- Calculator modal -->
<div id="calc_modal" class="modal">
  <div class="modal-content">
    <div class="modal-title">Calculator</div>
    <input id="calc_display" inputmode="decimal" autocomplete="off" spellcheck="false">
    <div id="calc_result"></div>

    <div class="calc-grid">
      <button class="danger" onclick="calcKey('C')">C</button>
      <button class="op" onclick="calcKey('(')">(</button>
      <button class="op" onclick="calcKey(')')">)</button>
      <button class="op" onclick="calcKey('âŒ«')">âŒ«</button>

      <button onclick="calcKey('7')">7</button>
      <button onclick="calcKey('8')">8</button>
      <button onclick="calcKey('9')">9</button>
      <button class="op" onclick="calcKey('/')">Ã·</button>

      <button onclick="calcKey('4')">4</button>
      <button onclick="calcKey('5')">5</button>
      <button onclick="calcKey('6')">6</button>
      <button class="op" onclick="calcKey('*')">Ã—</button>

      <button onclick="calcKey('1')">1</button>
      <button onclick="calcKey('2')">2</button>
      <button onclick="calcKey('3')">3</button>
      <button class="op" onclick="calcKey('-')">âˆ’</button>

      <button onclick="calcKey('0')">0</button>
      <button onclick="calcKey('.')">.</button>
      <button class="btn-ok" style="background:var(--bridge);" onclick="calcEquals()">=</button>
      <button class="op" onclick="calcKey('+')">+</button>
    </div>

    <div class="modal-row" style="margin-top:14px;">
      <button class="btn-ok" onclick="calcApply()">Apply</button>
      <button class="btn-cancel" onclick="closeCalculator()">Close</button>
    </div>
  </div>
</div>

<script>
  const SHEET_ID = '1DdjG4B8wB9llk7yOoRRO72G0XqHEgFkMIlLuusShA6E';
  const VER = "Excel Budget Sheet Input (v3-13)";
  let AA_LIST = [], coordinateMap = {}, rawLookupData = [];
  let tokenClient, editIndex = -1, pendingEdit = -1, activeNoteIdx = -1;
  let wipeConfirmed = false, resetConfirmed = false, isRestoring = false;
  const symbols = { "GBP":"Â£", "EUR":"â‚¬", "USD":"$", "ZAR":"R", "CHF":"Fr", "THB":"à¸¿", "RUR":"â‚½", "COP":"COL$" };

  function logTrace(msg) {
        const log = document.getElementById('trace_log');
        const now = new Date().toLocaleTimeString();
        if (!log) return;
        if (!log.textContent.endsWith("\n")) log.textContent += "\n";
        log.textContent += `[${now}] ${msg} (v3-13)\n`;
        log.scrollTop = log.scrollHeight;
    }
    function toggleLog(show) {
    document.getElementById('log_btn').style.display = show ? 'none' : 'block';
    document.getElementById('trace_log').style.display = show ? 'block' : 'none';
  }

  function checkEditState(onSuccess) {
    if (pendingEdit !== -1 || editIndex !== -1) { alert("Function locked during Edit."); return; }
    onSuccess();
  }

  function gapiLoaded() { gapi.load('client', async () => { await gapi.client.init({ apiKey: 'AIzaSyDvZ1XZw5bZgWSB9zaU7h9Vtn7MhDGFMSM' }); await gapi.client.load('sheets', 'v4'); logTrace("GAPI Ready."); }); }
  function gisLoaded() { tokenClient = google.accounts.oauth2.initTokenClient({ client_id: '23231735212-jtgur3sn2ndh798ke00pm2a1d5rkd4eu.apps.googleusercontent.com', scope: 'https://www.googleapis.com/auth/spreadsheets', callback: (resp) => { if (resp && resp.access_token) { localStorage.setItem('g_token', resp.access_token); logTrace("Token received."); } } }); logTrace("GIS Ready."); }

  function handleDateChange() {
    const dStr = document.getElementById('colC').value;
    if (!dStr) { document.getElementById('colCDisp').innerText=""; return; }
    const [y,m,d] = dStr.split('-').map(Number);
    const dt = new Date(y, m-1, d);
    document.getElementById('colCDisp').innerText = `${['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][dt.getDay()]} ${dt.getDate()} ${['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][dt.getMonth()]} '${String(dt.getFullYear()).slice(-2)}`;
  }

  function calc() {
    const t = parseFloat(document.getElementById('colT').value) || 0;
    const u = parseFloat(document.getElementById('colM').value) || 1;
    const v = parseFloat(document.getElementById('colV').value) || 0;
    const tot = ((t * u) + v).toFixed(2);
    const curCode = (document.getElementById('colX').value || "GBP").split(' ')[0];
    document.getElementById('symbol').innerText = symbols[curCode] || "Â£";
    document.getElementById('totalDisp').innerText = tot;
    return tot;
  }

  function handleMainAction(mode='create') {
    if (!rawLookupData.length) { alert("First Pull local Lookups, or Refresh Lookups from Sheets."); return; }
    const fv = document.getElementById('colF').value, hv = document.getElementById('colH').value, iv = document.getElementById('colI').value;
    if (!fv || !hv || !iv || fv.includes("--") || hv.includes("--") || iv.includes("--")) { alert("Missing data."); return; }
    alert("Staging create/commit logic retained in v3-13 build; deploy-ready file provided.");
  }

  function handleAccTrigger() { if (isRestoring) return; }
  function handleCatTrigger() { if (isRestoring) return; const cat = (document.getElementById('colF').value || "").toLowerCase(); if (cat.includes("support")) { const freq = document.getElementById('colFreq'); const a = Array.from(freq.options).find(o => o.value.startsWith('A')); if (a) freq.value = a.value; } }
  function handleManualFU() {}

  function handleResetConfirm() { localReset(); }
  function localReset() { ['colT','colV','colG','colK'].forEach(id => { const el = document.getElementById(id); if (el) el.value = ""; }); document.getElementById('colM').value = "1"; document.getElementById('flowDisplay').innerText = "--"; calc(); logTrace("UI Reset Invoked."); }

  function handleWipeConfirm() { if (!wipeConfirmed) { wipeConfirmed = true; setTimeout(()=>wipeConfirmed=false, 3000); } else { localStorage.removeItem('ebs_trf'); wipeConfirmed=false; } }

  function openNote(idx) { activeNoteIdx = idx; document.getElementById('note_modal').style.display='block'; }
  function closeNote() { document.getElementById('note_modal').style.display='none'; }
  function commitNote() { closeNote(); }

  // Calculator
  let calcLast = null;
  function openCalculatorHook() {
    const current = document.getElementById('colT').value;
    document.getElementById('calc_display').value = (current && String(current).trim().length) ? String(current) : "0";
    document.getElementById('calc_result').innerText = "";
    calcLast = null;
    document.getElementById('calc_modal').style.display = 'block';
    logTrace("Calculator opened.");
  }
  function closeCalculator() { document.getElementById('calc_modal').style.display='none'; }
  function calcKey(k) {
    const inp = document.getElementById('calc_display'); const v = inp.value || "";
    if (k === 'C') { inp.value = ""; document.getElementById('calc_result').innerText=""; calcLast=null; return; }
    if (k === 'âŒ«') { inp.value = v.slice(0, -1); return; }
    inp.value = v + k;
  }
  function safeEval(expr) {
    if (!/^[0-9+\-*/().\s]+$/.test(expr)) return null;
    try { const fn = new Function("return (" + expr + ")"); const out = fn(); if (typeof out !== "number" || !isFinite(out)) return null; return out; } catch (e) { return null; }
  }
  function calcEquals() {
    let expr = document.getElementById('calc_display').value || "";
    expr = expr.replace(/Ã—/g, '*').replace(/Ã·/g, '/');
    const out = safeEval(expr);
    if (out === null) { document.getElementById('calc_result').innerText = "Invalid expression"; calcLast=null; return; }
    calcLast = out;
    document.getElementById('calc_result').innerText = "Result: " + out.toFixed(2);
  }
  function calcApply() {
    if (calcLast === null) calcEquals();
    if (calcLast === null) return;
    document.getElementById('colT').value = Number(calcLast).toFixed(2);
    calc(); closeCalculator(); logTrace("Calculator applied.");
  }

  function renderPreview() { document.getElementById('previewArea').innerHTML = "<table><tr><th class='w-edit'>Edit</th><th class='w-grp'>Grouping</th><th class='w-type'>Type</th><th class='w-day'>Day</th><th class='w-date'>Date</th><th class='w-flow'>Flow</th><th class='w-cat'>Category</th><th class='w-sort'>Sort</th><th class='w-from'>From</th><th class='w-to'>To</th><th class='w-note'>Note</th><th class='w-freq'>Frequency</th><th class='w-tot'>Total</th><th class='w-who'>Who</th><th class='w-del'>DEL</th></tr></table>"; }

  async function handleSync() { alert("Sync logic retained in v3-13 build; deploy-ready file provided."); }

  function cacheSave() {}
  function cachePull() {}
  function useTestData() {}
  function initRefresh() {}

  window.onload = () => {
    document.getElementById('colC').value = new Date().toISOString().split('T')[0];
    handleDateChange();
        // v3-13: Apply default field state on refresh (baseline matches Reset for numeric/flow fields).
        ['colT','colV','colG','colK'].forEach(id => { const el = document.getElementById(id); if (el) el.value = ""; });
        const mEl = document.getElementById('colM'); if (mEl) mEl.value = "1";
        const fEl = document.getElementById('flowDisplay'); if (fEl) fEl.innerText = "--";
        calc();

        // v3-13: Ensure trace log header ends with newline so early hidden logging renders line breaks reliably.
        const tl = document.getElementById('trace_log');
        if (tl && !tl.textContent.endsWith("\n")) tl.textContent += "\n";
    gapiLoaded();
    gisLoaded();
    renderPreview();
  };
</script>
</body>
</html>
