<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EBS Entry v0-113</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>
    <style>
        :root { --primary: #2c3e50; --accent: #27ae60; --danger: #c0392b; --bg: #f8f9fa; --bridge: #2980b9; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 10px; }
        .container { max-width: 950px; margin: auto; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .header-wrap { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; gap: 10px; }
        h3 { margin: 0; font-weight: bold; flex-grow: 1; font-size: 1.1rem; }
        .header-btns { display: flex; gap: 8px; }
        .btn-lookup { background: var(--bridge); padding: 4px; font-size: 0.7rem; border-radius: 6px; border: none; color: white; cursor: pointer; font-weight: bold; width: 65px; height: 35px; line-height: 1.1; text-align: center; }
        .btn-reset-ui { background: #7f8c8d; }
        .grid-top { display: grid; grid-template-columns: 0.8fr 1fr 1.2fr; gap: 10px; }
        .grid-cat { display: grid; grid-template-columns: 1fr 0.4fr 0.3fr; gap: 10px; margin-top: 10px; }
        .grid-acc { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        label { font-size: 0.7rem; font-weight: 700; display: block; margin-bottom: 2px; }
        input, select, textarea { width: 100%; padding: 8px; border: 1px solid #dcdde1; border-radius: 6px; font-size: 16px; box-sizing: border-box; height: 38px; -webkit-text-size-adjust: 100%; }
        .type-display { font-size: 0.85rem; font-weight: bold; color: var(--primary); text-align: center; height: 38px; line-height: 36px; border: 1px solid #dcdde1; border-radius: 6px; background: #f1f2f6; box-sizing: border-box; cursor: default; }
        .total-box { background: #e8f5e9; border: 2px dashed var(--accent); padding: 10px; border-radius: 8px; text-align: center; margin: 15px 0; }
        .total-val { font-size: 1.3rem; font-weight: bold; color: var(--accent); }
        .actions { display: grid; grid-template-columns: 1fr 1fr 1.2fr; gap: 8px; }
        button { padding: 10px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; color: white; font-size: 0.72rem; }
        .btn-save { background: var(--accent); }
        .btn-sync { background: var(--bridge); }
        .btn-wipe { background: var(--danger); opacity: 0.85; }
        #auth_status { font-size: 0.65rem; margin-top: 10px; text-align: center; color: #7f8c8d; }
        .preview-wrap { overflow-x: auto; margin-top: 15px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.58rem; table-layout: fixed; }
        th, td { border: 1px solid #ddd; padding: 4px 2px; text-align: left; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        th { background: #f2f2f2; font-weight: bold; }
        .w-grp { width: 35px; } .w-fu { width: 22px; } .w-date { width: 68px; }
        .w-cat, .w-acc { width: 110px; } .w-tiny { width: 15px; text-align: center; }
        .w-sort { width: 15px; text-align: center; } .w-who { width: 40px; }
        .w-tot { width: 75px; text-align: right; }
    </style>
</head>
<body>
<div class="container">
    <div class="header-wrap">
        <h3>EBS input <span class="ver-tag">(v0-113)</span></h3>
        <div class="header-btns">
            <button class="btn-lookup" onclick="initRefresh()">Refresh<br>Lookups</button>
            <button class="btn-lookup btn-reset-ui" onclick="localReset()">Reset<br>fields</button>
        </div>
    </div>
    <div class="grid-top">
        <div><label>F/U</label><select id="colB" onchange="handleManualFU()"></select></div>
        <div><label>Grouping</label><select id="colA"></select></div>
        <div><label>Date</label><div style="display:flex;align-items:center;gap:5px;"><button onclick="document.getElementById('colC').showPicker()" style="height:38px; border:1px solid #ddd; border-radius:6px; background:#fff; width:40px;">ðŸ“…</button><input type="date" id="colC" style="visibility:hidden; width:0; position:absolute;" onchange="handleDateChange()"><span id="colCDisp" style="font-size:0.75rem;"></span></div></div>
    </div>
    <div class="grid-cat">
        <div><label>Category</label><select id="colF" required onchange="handleCatTrigger()"></select></div>
        <div><label style="text-align:center;">Type</label><div id="workTypeDisplay" class="type-display">--</div></div>
        <div><label>sort</label><input type="number" id="colG" placeholder="0"></div>
    </div>
    <div class="grid-acc">
        <div><label>From</label><select id="colH" required onchange="handleAccTrigger()"></select></div>
        <div><label>To</label><select id="colI" required onchange="handleAccTrigger()"></select></div>
    </div>
    <div style="margin-top:10px;"><label>Note</label><textarea id="colK" rows="2" style="width:100%; border-radius:6px; border:1px solid #dcdde1; padding:8px; box-sizing:border-box; font-size:16px;"></textarea></div>
    <div class="grid-3" style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-top:10px;">
        <div><label>Frequency</label><select id="colFreq"></select></div>
        <div><label>Status</label><select id="colStatus"></select></div>
        <div><label>Mnth</label><select id="colZ"></select></div>
    </div>
    <div class="grid-4" style="display:grid; grid-template-columns:1fr 1fr 1fr 1fr; gap:8px; margin-top:10px;">
        <div><label>Each</label><input type="number" id="colT" placeholder="0.00" step="0.01" oninput="calc()"></div>
        <div><label>Currency</label><select id="colX" onchange="calc()"></select></div>
        <div><label>Fees</label><input type="number" id="colV" placeholder="0.00" step="0.01" oninput="calc()"></div>
        <div><label>Multiplier</label><input type="number" id="colM" value="1" step="0.01" oninput="calc()"></div>
    </div>
    <div class="total-box"><div class="total-val"><span id="symbol">Â£</span> <span id="totalDisp">0.00</span></div></div>
    <div class="actions">
        <button class="btn-save" onclick="saveRow()">Stage Entry</button>
        <button class="btn-sync" id="sync_btn" onclick="handleSync()">Send to Sheets</button>
        <button id="wipeBtn" class="btn-wipe" onclick="clearData()">Wipe Local (2 clicks)</button>
    </div>
    <div class="preview-wrap" id="previewArea"></div>
    <div id="auth_status">iOS Sync Status: Idle (Tap Refresh to Login)</div>
    <input type="hidden" id="bgTypeE" value="--">
</div>

<script>
    const SHEET_ID = '1DdjG4B8wB9llk7yOoRRO72G0XqHEgFkMIlLuusShA6E';
    const VER = "Excel Budget Sheet input (v0-113)";
    let AA_LIST = [], coordinateMap = {}, symbols = { "GBP": "Â£", "EUR": "â‚¬", "USD": "$", "ZAR": "R", "CHF": "Fr", "THB": "à¸¿", "RUR": "â‚½", "COP": "COL$" };
    let tokenClient, gapiInited = false, gsiInited = false, wipeConfirmed = false;

    function colToIndex(col) {
        let idx = 0; col = col.toUpperCase().replace(/[0-9]/g, '');
        for(let i=0; i<col.length; i++) { idx = idx * 26 + (col.charCodeAt(i) - 64); }
        return idx - 1;
    }

    function gapiLoaded() { gapi.load('client', async () => { await gapi.client.init({ apiKey: 'AIzaSyDvZ1XZw5bZgWSB9zaU7h9Vtn7MhDGFMSM' }); await gapi.client.load('sheets', 'v4'); gapiInited = true; }); }
    function gisLoaded() { tokenClient = google.accounts.oauth2.initTokenClient({ client_id: '23231735212-jtgur3sn2ndh798ke00pm2a1d5rkd4eu.apps.googleusercontent.com', scope: 'https://www.googleapis.com/auth/spreadsheets', callback: '' }); gsiInited = true; }

    function initRefresh() {
        document.getElementById('auth_status').innerText = "Requesting Login...";
        tokenClient.callback = async (resp) => { if (resp.access_token) fetchLookupRefs(); };
        tokenClient.requestAccessToken();
    }

    function localReset() {
        const resetSel = (id, def) => {
            const s = document.getElementById(id); if(!s) return;
            if(def) { const opt = Array.from(s.options).find(o => o.value.startsWith(def)); if(opt) s.value = opt.value; }
            else s.selectedIndex = 0;
        };
        resetSel('colA', 'Roy'); resetSel('colB', 'v'); resetSel('colF', null);
        resetSel('colH', null); resetSel('colI', null); resetSel('colFreq', 'A');
        resetSel('colStatus', 'N'); resetSel('colZ', 'NEW'); resetSel('colX', 'GBP');
        ['colT', 'colV', 'colG', 'colK'].forEach(id => document.getElementById(id).value = "");
        document.getElementById('colM').value = "1"; document.getElementById('workTypeDisplay').innerText = "--";
        document.getElementById('bgTypeE').value = "--"; calc();
    }

    async function fetchLookupRefs() {
        try {
            const res = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SHEET_ID, range: 'LookupRefs!A2:C15' });
            res.result.values.forEach(r => { coordinateMap[r[0]] = { val: colToIndex(r[1]), desc: (r[2] && r[2].toLowerCase() !== 'n/a') ? colToIndex(r[2]) : null }; });
            fetchActiveAccounts();
        } catch (e) { document.getElementById('auth_status').innerText = "Auth Error."; }
    }

    async function fetchActiveAccounts() {
        try {
            const res = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SHEET_ID, range: 'ActiveAccounts!A2:A500' });
            AA_LIST = res.result.values ? res.result.values.flat().filter(v => v) : [];
            fetchActualData();
        } catch (e) { document.getElementById('auth_status').innerText = "AA List Error."; }
    }

    async function fetchActualData() {
        try {
            const res = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SHEET_ID, range: 'Lookups!A2:AC1000' });
            const data = res.result.values;
            const pop = (id, key, def, prompt = null) => {
                const list = data.filter(r => r[coordinateMap[key].val]).map(r => {
                    const v = r[coordinateMap[key].val], d = coordinateMap[key].desc !== null ? r[coordinateMap[key].desc] : null;
                    return d ? `${v} - ${d}` : v;
                });
                updateDropdown(id, list, def, prompt);
            };
            pop('colA', 'Grouping', 'Roy'); pop('colB', 'F/U', 'v'); pop('colF', 'Category', null, '--Select--');
            pop('colH', 'From', null, '--Select--'); pop('colI', 'To', null, '--Select--');
            pop('colFreq', 'Frequency', 'A'); pop('colStatus', 'Status', 'N'); pop('colZ', 'Month', 'NEW'); pop('colX', 'Currency', 'GBP');
            localReset(); document.getElementById('auth_status').innerText = "Ready - Bridge Active";
        } catch (e) { document.getElementById('auth_status').innerText = "Data Fetch Error."; }
    }

    function handleAccTrigger() {
        const h = document.getElementById('colH').value, i = document.getElementById('colI').value;
        const fu = document.getElementById('colB'), typeDisp = document.getElementById('workTypeDisplay'), cat = document.getElementById('colF'), freq = document.getElementById('colFreq');
        if (!h || !i || h.includes("--") || i.includes("--")) return;
        const fAA = AA_LIST.includes(h), tAA = AA_LIST.includes(i);
        let valE = "zOut"; if (fAA && tAA) valE = "xfer"; else if (!fAA && tAA) valE = "In";
        typeDisp.innerText = valE; document.getElementById('bgTypeE').value = valE;
        if (valE === "xfer") { 
            const xf = Array.from(fu.options).find(o => o.value.startsWith('xf')); if(xf) fu.value = xf.value;
            const k = Array.from(freq.options).find(o => o.value.startsWith('K')); if(k) freq.value = k.value;
            cat.value = "Transfer"; 
        } else if (cat.value.toLowerCase().includes("support")) {
            const s = Array.from(fu.options).find(o => o.value.startsWith('S')); if(s) fu.value = s.value;
        }
    }

    function handleCatTrigger() {
        const f = document.getElementById('colF').value, fu = document.getElementById('colB');
        if (f.startsWith('S')) { const s = Array.from(fu.options).find(o => o.value.startsWith('S')); if(s) fu.value = s.value; }
    }

    function handleManualFU() { if(document.getElementById('colB').value.startsWith('xf')) document.getElementById('colF').value = "Transfer"; }
    function updateDropdown(id, vals, defCode, prompt) {
        const sel = document.getElementById(id); let html = prompt ? `<option value="" disabled selected>${prompt}</option>` : '';
        html += vals.map(v => `<option value="${v}">${v}</option>`).join(''); sel.innerHTML = html;
        if(defCode) { const opt = Array.from(sel.options).find(o => o.value.startsWith(defCode)); if(opt) sel.value = opt.value; }
    }

    function handleDateChange() {
        const dStr = document.getElementById('colC').value; if(!dStr) return;
        const [y, m, d] = dStr.split('-').map(Number); const dt = new Date(y, m-1, d);
        document.getElementById('colCDisp').innerText = `${['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][dt.getDay()]} ${dt.getDate()} ${['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][dt.getMonth()]} '${String(dt.getFullYear()).substr(-2)}`;
    }

    function calc() {
        const t = parseFloat(document.getElementById('colT').value)||0, u = parseFloat(document.getElementById('colM').value)||1, v = parseFloat(document.getElementById('colV').value)||0;
        const tot = ((t * u) + v).toFixed(2);
        const curCode = document.getElementById('colX').value.split(' - ')[0] || 'GBP';
        document.getElementById('symbol').innerText = symbols[curCode]||"Â£";
        document.getElementById('totalDisp').innerText = tot; return tot;
    }

    function saveRow() {
        const fv = document.getElementById('colF').value, hv = document.getElementById('colH').value, iv = document.getElementById('colI').value;
        if (!fv || !hv || !iv || fv.includes("--") || hv.includes("--") || iv.includes("--")) { alert("Required fields missing."); return; }
        let whoVal = ""; if (fv.startsWith('S')) whoVal = document.getElementById('colA').value;

        // Force Column A (index 0) to have data to anchor the append
        const row = Array(35).fill("");
        row[0] = document.getElementById('colA').value || "Roy"; 
        row[1] = document.getElementById('colB').value.split(' - ')[0];
        row[2] = document.getElementById('colC').value;
        row[4] = document.getElementById('bgTypeE').value;
        row[5] = document.getElementById('colF').value.split(' - ')[0];
        row[6] = document.getElementById('colG').value;
        row[7] = document.getElementById('colH').value;
        row[8] = document.getElementById('colI').value;
        row[10] = document.getElementById('colK').value;
        row[11] = document.getElementById('colFreq').value.split(' - ')[0];
        row[14] = document.getElementById('colStatus').value.split(' - ')[0];
        row[19] = parseFloat(document.getElementById('colT').value||0).toFixed(2);
        row[20] = document.getElementById('colM').value;
        row[21] = parseFloat(document.getElementById('colV').value||0).toFixed(2);
        row[22] = calc();
        row[23] = document.getElementById('colX').value.split(' - ')[0];
        row[25] = document.getElementById('colZ').value;
        row[33] = whoVal; 
        row[34] = VER;   
        
        let data = JSON.parse(localStorage.getItem('ebs_trf') || '[]'); data.push(row); localStorage.setItem('ebs_trf', JSON.stringify(data));
        ['colT', 'colV', 'colG', 'colK'].forEach(id => document.getElementById(id).value = "");
        document.getElementById('colM').value = "1"; calc(); renderPreview();
    }

    function renderPreview() {
        const data = JSON.parse(localStorage.getItem('ebs_trf') || '[]');
        let h = '<table><tr><th class="w-grp">Grp</th><th class="w-fu">F/U</th><th class="w-date">Date</th><th class="w-type">Type</th><th class="w-cat">Category</th><th class="w-sort">s</th><th class="w-acc">From</th><th class="w-acc">To</th><th class="w-tiny">N</th><th class="w-tiny">F</th><th class="txt-center" style="width:15px;">S</th><th class="w-tot">Total</th><th class="txt-center" style="width:35px;">Mnth</th><th class="w-who">Who</th><th class="w-tiny">X</th></tr>';
        data.forEach((r, idx) => {
            const dP = r[2].split('-');
            const noteMark = r[10] && r[10].trim() !== "" ? "âœ“" : "";
            h += `<tr><td>${r[0]}</td><td>${r[1]}</td><td>${dP[2]} ${['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][parseInt(dP[1])-1]}</td><td>${r[4]}</td><td>${r[5]}</td><td class="w-sort">${r[6]}</td><td>${r[7]}</td><td>${r[8]}</td><td class="w-tiny">${noteMark}</td><td class="w-tiny">${r[11]}</td><td class="txt-center">${r[14]}</td><td class="w-tot">${r[22]}</td><td class="txt-center">${r[25]}</td><td class="w-who">${r[33]}</td><td class="w-tiny"><button onclick="deleteRow(${idx})" style="background:red;border:none;color:white;cursor:pointer;padding:0 3px;">X</button></td></tr>`;
        });
        document.getElementById('previewArea').innerHTML = h + '</table>';
    }

    function deleteRow(i) { let d = JSON.parse(localStorage.getItem('ebs_trf') || '[]'); d.splice(i, 1); localStorage.setItem('ebs_trf', JSON.stringify(d)); renderPreview(); }
    async function handleSync() {
        const data = JSON.parse(localStorage.getItem('ebs_trf') || '[]'); if (!data.length) return;
        tokenClient.callback = async (resp) => {
            const vals = data.map(r => { 
                let rc = [...r]; 
                const dP = rc[2].split('-'); 
                rc[2] = `${dP[2]}/${dP[1]}/${dP[0]}`; 
                [19, 21, 22].forEach(i => rc[i] = parseFloat(rc[i] || 0)); 
                return rc; 
            });
            try { 
                // Hardened sync: Using values[0].length check to force row preservation
                await gapi.client.sheets.spreadsheets.values.append({ 
                    spreadsheetId: SHEET_ID, 
                    range: "'EBSinput'!A:AI", 
                    valueInputOption: 'USER_ENTERED', 
                    insertDataOption: 'INSERT_ROWS',
                    resource: { values: vals } 
                }); 
                alert("Success!"); renderPreview(); 
            } catch (e) { alert("Sync Error."); }
        };
        tokenClient.requestAccessToken();
    }
    function clearData() { if(!wipeConfirmed) { wipeConfirmed=true; document.getElementById('wipeBtn').innerText = "CONFIRM?"; setTimeout(()=>{wipeConfirmed=false; document.getElementById('wipeBtn').innerText="Wipe Local (2 clicks)";},3000); } else { localStorage.removeItem('ebs_trf'); wipeConfirmed=false; renderPreview(); } }
    window.onload = () => { document.getElementById('colC').value = new Date().toISOString().split('T')[0]; handleDateChange(); gapiLoaded(); gisLoaded(); renderPreview(); };
</script>
</body>
</html>
