<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EBS Entry v2-80</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>
    <style>
        :root { --primary: #2c3e50; --accent: #27ae60; --danger: #c0392b; --bg: #f8f9fa; --bridge: #2980b9; --cache: #8e44ad; --test: #e67e22; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); margin: 0; padding: 10px; }
        .container { max-width: 960px; margin: auto; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .branding-row { margin-bottom: 10px; font-size: 1.1rem; line-height: 1.1; color: var(--primary); }
        .header-wrap { display: flex; flex-direction: column; margin-bottom: 15px; gap: 8px; }
        .header-btns { display: flex; justify-content: space-between; gap: 4px; width: 100%; }
        .btn-lookup { background: var(--bridge); padding: 2px; font-size: 0.72rem; border-radius: 6px; border: none; color: white; cursor: pointer; font-weight: 600; flex: 1; height: 50px; line-height: 1.1; text-align: center; display: flex; align-items: center; justify-content: center; min-width: 0; }
        .btn-reset-ui { background: var(--danger); }
        label { font-size: 0.7rem; font-weight: 700; display: block; margin-bottom: 2px; color: var(--primary); }
        input, select, textarea { width: 100%; padding: 8px; border: 1px solid #dcdde1; border-radius: 6px; font-size: 16px; box-sizing: border-box; height: 38px; -webkit-text-size-adjust: 100%; font-family: inherit; }
        .flow-display { font-size: 0.85rem; font-weight: bold; color: var(--primary); text-align: center; height: 38px; line-height: 36px; border: 1px solid #dcdde1; border-radius: 6px; background: #f1f2f6; box-sizing: border-box; }
        .total-box { background: #e8f5e9; border: 2px dashed var(--accent); padding: 10px; border-radius: 8px; text-align: center; margin: 15px 0; }
        .total-val { font-size: 1.3rem; font-weight: bold; color: var(--accent); }
        .actions { display: grid; grid-template-columns: 1fr 1fr 1.2fr; gap: 8px; }
        button.action-main { padding: 10px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; color: white; font-size: 0.72rem; -webkit-font-smoothing: antialiased; }
        .preview-wrap { width: 100%; overflow-x: auto; margin-top: 15px; border: 1px solid #ddd; border-radius: 6px; }
        table { width: 1100px; border-collapse: collapse; font-size: 0.58rem; table-layout: fixed; font-family: inherit; }
        th, td { border: 1px solid #eee; padding: 6px 3px; text-align: left; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        th { background: #f2f2f2; font-weight: bold !important; color: var(--primary); }
        .w-edit { width: 45px; text-align: center; } .w-flow { width: 40px; text-align: center; } .w-note { width: 40px; text-align: center; cursor: pointer; font-size: 1rem; } .w-tot { width: 80px; text-align: right; }
        #trace_log { margin-top: 15px; padding: 10px; background: #2c3e50; color: #00ff00; font-family: "Courier New", monospace; font-size: 0.6rem; border-radius: 6px; max-height: 120px; overflow-y: auto; white-space: pre-wrap; display: none; cursor: pointer; }
        
        /* Calculator v2-80 */
        .calc-input-wrap { display: flex; align-items: center; gap: 4px; }
        .btn-calc-trigger { background: var(--bridge); color: white; border: none; border-radius: 4px; height: 38px; width: 30px; cursor: pointer; font-weight: bold; }
        #calc_modal { display: none; position: fixed; z-index: 2000; left: 50%; top: 50%; transform: translate(-50%, -50%); width: 260px; background: white; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .calc-header { background: var(--primary); color: white; padding: 10px; border-radius: 12px 12px 0 0; cursor: move; text-align: center; font-size: 0.8rem; font-weight: bold; }
        .calc-screen { background: #ecf0f1; padding: 10px; text-align: right; font-size: 1.2rem; font-family: monospace; font-weight: bold; overflow: hidden; height: 40px; }
        .calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; padding: 10px; }
        .calc-btn { padding: 15px 5px; background: #eee; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 1rem; }
        .calc-op { background: var(--test); color: white; }
        .calc-eq { background: var(--accent); color: white; }
        .calc-res { background: #bdc3c7; }
        .calc-clr { background: var(--danger); color: white; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; margin: 15% auto; padding: 20px; width: 80%; max-width: 400px; border-radius: 12px; }
    </style>
</head>
<body>
<div class="container">
    <div class="header-wrap">
        <div class="branding-row"><b>EBS Input</b> <span style="font-size:0.7rem; color:#7f8c8d;">v2-80</span></div>
        <div class="header-btns">
            <button class="btn-lookup" id="pullLocalBtn">Pull local<br>Lookups</button>
            <button class="btn-lookup" id="refresh_btn">Refresh<br>Lookups<br>from Sheets</button>
            <button class="btn-lookup" id="saveLocalBtn">Save to<br>local Lookups</button>
            <button class="btn-lookup" id="testBtn">Pull test<br>Lookups</button>
            <button class="btn-lookup btn-reset-ui" id="resetBtn">Reset</button>
        </div>
    </div>
    
    <div style="display:grid; grid-template-columns: 0.8fr 1fr 1.2fr; gap:10px;">
        <div><label>Type</label><select id="colB"></select></div>
        <div><label>Grouping</label><select id="colA"></select></div>
        <div><label>Date</label><input type="date" id="colC"></div>
    </div>
    <div style="display:grid; grid-template-columns: 1fr 0.4fr 0.3fr; gap:10px; margin-top:10px;">
        <div><label>Category</label><select id="colF"></select></div>
        <div><label style="text-align:center;">Flow</label><div id="flowDisplay" class="flow-display">--</div></div>
        <div><label>Sort</label><input type="number" id="colG" placeholder="0"></div>
    </div>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
        <div><label>From</label><select id="colH"></select></div>
        <div><label>To</label><select id="colI"></select></div>
    </div>
    <div style="margin-top:10px;"><label>Note</label><textarea id="colK" rows="2" style="font-size:16px;"></textarea></div>
    <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-top:10px;">
        <div><label>Frequency</label><select id="colFreq"></select></div>
        <div><label>Status</label><select id="colStatus"></select></div>
        <div><label>Month</label><select id="colZ"></select></div>
    </div>
    <div style="display:grid; grid-template-columns:1.2fr 1fr 1fr 1fr; gap:8px; margin-top:10px;">
        <div><label>Each</label>
            <div class="calc-input-wrap"><input type="number" id="colT" placeholder="0.00" step="0.01"><button class="btn-calc-trigger" id="calcOpen">¬±</button></div>
        </div>
        <div><label>Currency</label><select id="colX"></select></div>
        <div><label>Fees</label><input type="number" id="colV" placeholder="0.00" step="0.01"></div>
        <div><label>Multiplier</label><input type="number" id="colM" value="1"></div>
    </div>
    <div class="total-box"><div class="total-val">¬£ <span id="totalDisp">0.00</span></div></div>
    <div class="actions">
        <button class="action-main" id="createBtn" style="background:var(--accent);">Create Staging record</button>
        <button class="action-main" id="sync_btn" style="background:var(--bridge);">Send Staging records to Sheets</button>
        <button class="action-main" id="wipeBtn" style="background:var(--danger);">Clear Staging records</button>
    </div>
    <div class="preview-wrap" id="previewArea"></div>
    <div id="auth_status" style="font-size: 0.75rem; margin-top:10px; text-align:center; color:#7f8c8d;">iOS Sync Status: Idle</div>
    <button id="log_btn" style="margin-top:15px; width:100%; background:var(--primary); color:white; font-size:0.7rem; border-radius:6px; padding:8px; border:none;">Display Trace Log</button>
    <div id="trace_log">Trace: v2-80 full restoration and 2-stage verification logic repair.</div>
</div>

<div id="calc_modal">
    <div class="calc-header" id="calc_handle">Calculator (Drag Header)</div>
    <div class="calc-screen" id="calc_display">0</div>
    <div class="calc-grid">
        <button class="calc-btn calc-clr" onclick="calcAction('C')">C</button>
        <button class="calc-btn" onclick="calcAction('/')">/</button>
        <button class="calc-btn" onclick="calcAction('*')">√ó</button>
        <button class="calc-btn calc-op" onclick="calcAction('DEL')">‚Üê</button>
        <button class="calc-btn" onclick="calcAction('7')">7</button>
        <button class="calc-btn" onclick="calcAction('8')">8</button>
        <button class="calc-btn" onclick="calcAction('9')">9</button>
        <button class="calc-btn" onclick="calcAction('-')">-</button>
        <button class="calc-btn" onclick="calcAction('4')">4</button>
        <button class="calc-btn" onclick="calcAction('5')">5</button>
        <button class="calc-btn" onclick="calcAction('6')">6</button>
        <button class="calc-btn" onclick="calcAction('+')">+</button>
        <button class="calc-btn" onclick="calcAction('1')">1</button>
        <button class="calc-btn" onclick="calcAction('2')">2</button>
        <button class="calc-btn" onclick="calcAction('3')">3</button>
        <button class="calc-btn" onclick="calcAction('%')">%</button>
        <button class="calc-btn" onclick="calcAction('0')">0</button>
        <button class="calc-btn" onclick="calcAction('.')">.</button>
        <button class="calc-btn calc-res" onclick="calcCompute()">=</button>
        <button class="calc-btn calc-eq" onclick="calcApply()">APPLY</button>
    </div>
    <button class="calc-btn" style="width:100%; border-radius:0 0 12px 12px;" onclick="closeCalculator()">Cancel</button>
</div>

<div id="note_modal" class="modal">
    <div class="modal-content"><label>Edit Note</label><textarea id="modal_note_text" rows="4"></textarea><div style="display:flex; gap:10px; margin-top:15px;"><button onclick="commitNote()" style="flex:1; background:var(--accent); color:white; padding:10px; border:none; border-radius:6px; font-weight:bold;">Save</button><button onclick="closeNote()" style="flex:1; background:#7f8c8d; color:white; padding:10px; border:none; border-radius:6px; font-weight:bold;">Cancel</button></div></div>
</div>

<script>
    const VER = "v2-80";
    let AA_LIST = [], editIndex = -1, pendingEdit = -1, activeNoteIdx = -1, isRestoring = false, wipeConfirmed = false, resetConfirmed = false;

    function logTrace(m) { const l = document.getElementById('trace_log'); l.innerText += `\n[${new Date().toLocaleTimeString()}] ${m}`; }
    function updateStatus(l, s) { const el = document.getElementById('auth_status'); el.innerText = `iOS Sync Status: ${l}`; el.style.color = s === "active" ? "#27ae60" : "#7f8c8d"; }
    function checkEditState(fn) { if (editIndex !== -1 || pendingEdit !== -1) alert("Function locked during active Edit."); else fn(); }

    function setupEventListeners() {
        document.getElementById('pullLocalBtn').addEventListener('click', () => checkEditState(cachePull));
        document.getElementById('saveLocalBtn').addEventListener('click', () => checkEditState(cacheSave));
        document.getElementById('refresh_btn').addEventListener('click', () => checkEditState(initRefresh));
        document.getElementById('testBtn').addEventListener('click', () => checkEditState(useTestData));
        document.getElementById('resetBtn').addEventListener('click', handleResetConfirm);
        document.getElementById('wipeBtn').addEventListener('click', handleWipeConfirm);
        document.getElementById('createBtn').addEventListener('click', () => saveRow(editIndex !== -1));
        document.getElementById('sync_btn').addEventListener('click', () => checkEditState(handleSync));
        document.getElementById('calcOpen').addEventListener('click', openCalculator);
        document.getElementById('log_btn').addEventListener('click', () => { document.getElementById('trace_log').style.display = 'block'; document.getElementById('log_btn').style.display = 'none'; });
        document.getElementById('trace_log').addEventListener('click', () => { document.getElementById('trace_log').style.display = 'none'; document.getElementById('log_btn').style.display = 'block'; });
        document.getElementById('colH').addEventListener('change', handleAccTrigger);
        document.getElementById('colI').addEventListener('change', handleAccTrigger);
        ['colT','colV','colM'].forEach(id => document.getElementById(id).addEventListener('input', calc));
        document.getElementById('colT').addEventListener('focus', function(){ this.value=''; });
        document.getElementById('colV').addEventListener('focus', function(){ this.value=''; });
    }

    function handleWipeConfirm() {
        const b = document.getElementById('wipeBtn');
        if(!wipeConfirmed) { wipeConfirmed = true; b.innerText = "CONFIRM?"; setTimeout(() => { wipeConfirmed = false; b.innerText = "Clear Staging records"; }, 3000); }
        else { localStorage.removeItem('ebs_trf'); wipeConfirmed = false; b.innerText = "Clear Staging records"; renderPreview(); logTrace("Staging area wiped."); }
    }

    function handleResetConfirm() {
        const b = document.getElementById('resetBtn');
        if(!resetConfirmed) { resetConfirmed = true; b.innerText = "CONFIRM?"; setTimeout(() => { resetConfirmed = false; b.innerText = "Reset"; }, 3000); }
        else { editIndex = -1; pendingEdit = -1; resetConfirmed = false; b.innerText = "Reset"; renderPreview(); logTrace("UI Reset."); }
    }

    // Calculator Logic
    let cStr = "";
    function openCalculator() { cStr = document.getElementById('colT').value || "0"; updateDisplay(); document.getElementById('calc_modal').style.display = 'block'; }
    function closeCalculator() { document.getElementById('calc_modal').style.display = 'none'; }
    function updateDisplay() { document.getElementById('calc_display').innerText = cStr || "0"; }
    function calcAction(v) {
        if(v==='C') cStr = "0"; else if(v==='DEL') cStr = cStr.slice(0,-1) || "0";
        else if(v==='%') { calcCompute(); cStr = (parseFloat(cStr)/100).toString(); }
        else { if(cStr==="0" && !isNaN(v)) cStr = v; else cStr += v; }
        updateDisplay();
    }
    function calcCompute() { try { cStr = eval(cStr).toString(); updateDisplay(); } catch(e) { cStr = "Err"; updateDisplay(); } }
    function calcApply() { calcCompute(); if(cStr!=="Err") { document.getElementById('colT').value = parseFloat(cStr).toFixed(2); calc(); closeCalculator(); } }

    function renderPreview() {
        const d = JSON.parse(localStorage.getItem('ebs_trf') || '[]');
        let h = '<table><tr><th class="w-edit">Edit</th><th>Grp</th><th>Type</th><th>Day</th><th>Date</th><th class="w-flow">Flow</th><th>Category</th><th>Sort</th><th>From</th><th>To</th><th class="w-note">Note</th><th>Total</th></tr>';
        d.forEach((r, idx) => {
            const bL = (pendingEdit===idx)?"...":(editIndex===idx?"C":"Edit");
            const bC = (pendingEdit===idx)?"background:red":(editIndex===idx?"background:#f39c12":"background:#3498db");
            h += `<tr><td><button onclick="initiateEdit(${idx})" style="${bC};color:white;border:none;border-radius:4px;padding:2px;width:100%;font-size:0.55rem;">${bL}</button></td><td>${r[0]}</td><td>${r[1]}</td><td>Day</td><td>${r[2]}</td><td>${r[4]}</td><td>${r[5]}</td><td>${r[6]}</td><td>${r[7]}</td><td>${r[8]}</td><td class="w-note" onclick="openNote(${idx})">${r[10]?'üìÑ':'‚ñ´Ô∏è'}</td><td class="w-tot">${r[22]}</td></tr>`;
        });
        document.getElementById('previewArea').innerHTML = h + '</table>';
    }

    function initiateEdit(idx) {
        if (pendingEdit === idx) {
            isRestoring = true; editIndex = idx; pendingEdit = -1;
            const d = JSON.parse(localStorage.getItem('ebs_trf'))[idx];
            const setUI = (id, val, drop = false) => {
                const el = document.getElementById(id); if(!el) return;
                if(!drop) { el.value = val; return; }
                for(let i=0; i<el.options.length; i++) { if(el.options[i].value === val || el.options[i].text === val || el.options[i].value === val + " (AA)") { el.selectedIndex = i; break; } }
            };
            setUI('colA', d[0], true); setUI('colB', d[1], true); setUI('colC', d[2]); setUI('colF', d[5], true); setUI('colG', d[6]); setUI('colH', d[7], true); setUI('colI', d[8], true); setUI('colT', d[19]); setUI('colV', d[21]); setUI('colM', d[20]); setUI('colZ', d[25], true);
            document.getElementById('flowDisplay').innerText = d[4] || "--";
            isRestoring = false; logTrace("Pulling Record for Edit...");
        } else { pendingEdit = idx; editIndex = -1; }
        renderPreview();
    }

    function handleAccTrigger() { if(isRestoring) return; const h = document.getElementById('colH').value, i = document.getElementById('colI').value; const fAA = AA_LIST.includes(h), tAA = AA_LIST.includes(i); let f = "zOut"; if(fAA && tAA) f = "xfer"; else if(!fAA && tAA) f = "In"; document.getElementById('flowDisplay').innerText = f; }
    function handleCatTrigger() { if(isRestoring) return; if(document.getElementById('colF').value.startsWith('S')) { const s = Array.from(document.getElementById('colB').options).find(o => o.value.startsWith('S')); if(s) document.getElementById('colB').value = s.value; } }
    function calc() { const t = parseFloat(document.getElementById('colT').value)||0, u = parseFloat(document.getElementById('colM').value)||1, v = parseFloat(document.getElementById('colV').value)||0; const tot = ((t * u) + v).toFixed(2); document.getElementById('totalDisp').innerText = tot; return tot; }

    function saveRow(ovr) {
        const flow = document.getElementById('flowDisplay').innerText;
        if(flow === "--") { alert("Select Flow"); return; }
        const r = Array(35).fill("");
        r[0]=document.getElementById('colA').value; r[1]=document.getElementById('colB').value; r[2]=document.getElementById('colC').value; r[4]=flow; r[5]=document.getElementById('colF').value; r[6]=document.getElementById('colG').value; r[7]=document.getElementById('colH').value; r[8]=document.getElementById('colI').value; r[10]=document.getElementById('colK').value; r[19]=document.getElementById('colT').value; r[20]=document.getElementById('colM').value; r[21]=document.getElementById('colV').value; r[22]=calc(); r[25]=document.getElementById('colZ').value;
        let d = JSON.parse(localStorage.getItem('ebs_trf') || '[]');
        if(ovr && editIndex > -1) d[editIndex] = r; else d.push(r);
        localStorage.setItem('ebs_trf', JSON.stringify(d)); editIndex = -1; pendingEdit = -1; renderPreview(); logTrace("Record Staged.");
    }

    function openNote(idx) { activeNoteIdx = idx; const d = JSON.parse(localStorage.getItem('ebs_trf')); document.getElementById('modal_note_text').value = d[idx][10] || ""; document.getElementById('note_modal').style.display = 'block'; }
    function closeNote() { document.getElementById('note_modal').style.display = 'none'; }
    function commitNote() { let d = JSON.parse(localStorage.getItem('ebs_trf')); d[activeNoteIdx][10] = document.getElementById('modal_note_text').value; localStorage.setItem('ebs_trf', JSON.stringify(d)); closeNote(); renderPreview(); }
    async function initRefresh() { updateStatus("Syncing...", "sync"); setTimeout(() => updateStatus("Token Active", "active"), 1000); }
    async function handleSync() { updateStatus("Syncing...", "sync"); setTimeout(() => updateStatus("Token Active", "active"), 1000); }
    function cachePull() { renderPreview(); } function cacheSave() {} function useTestData() { AA_LIST = ["Santander P (AA)", "Revolut P (AA)"]; logTrace("Test Data Loaded."); }

    // Draggable Logic
    const dm = document.querySelector("#calc_modal"); const dh = document.querySelector("#calc_handle");
    let active = false, xO = 0, yO = 0, iX, iY;
    dh.addEventListener("mousedown", (e) => { iX = e.clientX - xO; iY = e.clientY - yO; if(e.target === dh) active = true; });
    document.addEventListener("mouseup", () => active = false);
    document.addEventListener("mousemove", (e) => { if(active) { e.preventDefault(); xO = e.clientX - iX; yO = e.clientY - iY; dm.style.transform = `translate(calc(-50% + ${xO}px), calc(-50% + ${yO}px))`; } });

    window.onload = () => { setupEventListeners(); renderPreview(); };
</script>
</body>
</html>
