<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EBS Entry v3-15</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>
    <style>
        :root { --primary: #2c3e50; --accent: #27ae60; --danger: #c0392b; --bg: #f8f9fa; --bridge: #2980b9; --cache: #8e44ad; --test: #e67e22; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); margin: 0; padding: 10px; }
        .container { max-width: 960px; margin: auto; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .branding-row { margin-bottom: 10px; font-size: 1.1rem; line-height: 1.1; color: var(--primary); }
        .branding-row b { font-weight: bold; }
        .branding-row span { font-weight: 400; font-size: 0.75rem; color: #7f8c8d; margin-left: 5px; }
        .header-wrap { display: flex; flex-direction: column; margin-bottom: 15px; gap: 8px; }
        .header-btns { display: flex; justify-content: space-between; gap: 4px; width: 100%; }
        .btn-lookup { background: var(--bridge); padding: 4px; font-size: 0.72rem; border-radius: 6px; border: none; color: white; cursor: pointer; font-weight: 600; flex: 1; height: 50px; line-height: 1.1; text-align: center; overflow: hidden; -webkit-font-smoothing: antialiased; display: flex; align-items: center; justify-content: center; min-width: 0; }
        .btn-reset-ui { background: #7f8c8d; } .btn-cache-save { background: var(--accent); } .btn-cache-pull { background: var(--cache); } .btn-test-mode { background: var(--test); }
        label { font-size: 0.7rem; font-weight: 700; display: block; margin-bottom: 2px; color: var(--primary); }
        input, select, textarea { width: 100%; padding: 8px; border: 1px solid #dcdde1; border-radius: 6px; font-size: 16px; box-sizing: border-box; height: 38px; -webkit-text-size-adjust: 100%; font-family: inherit; }
        .date-input-container { display: flex; align-items: center; gap: 5px; background: white; border: 1px solid #dcdde1; border-radius: 6px; padding: 0 8px; height: 38px; }
        .date-input-container input[type="date"] { border: none; padding: 0; height: 100%; font-size: 14px; flex-grow: 1; outline: none; background: transparent; }
        .type-display { font-size: 0.85rem; font-weight: bold; color: var(--primary); text-align: center; height: 38px; line-height: 36px; border: 1px solid #dcdde1; border-radius: 6px; background: #f1f2f6; box-sizing: border-box; }
        .total-box { background: #e8f5e9; border: 2px dashed var(--accent); padding: 10px; border-radius: 8px; text-align: center; margin: 15px 0; }
        .total-val { font-size: 1.3rem; font-weight: bold; color: var(--accent); }
        .actions { display: grid; grid-template-columns: 1fr 1fr 1.2fr; gap: 8px; }
        button.action-main { padding: 10px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; color: white; font-size: 0.72rem; -webkit-font-smoothing: antialiased; }
        .preview-wrap { width: 100%; overflow-x: auto; margin-top: 15px; -webkit-overflow-scrolling: touch; border: 1px solid #ddd; border-radius: 6px; }
        table { width: 1050px; border-collapse: collapse; font-size: 0.58rem; table-layout: fixed; font-family: inherit; }
        th, td { border: 1px solid #eee; padding: 6px 3px; text-align: left; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        th { background: #f2f2f2; font-weight: bold !important; color: var(--primary); font-size: 0.58rem !important; font-family: inherit !important; }
        .w-edit { width: 30px; text-align: center; } .w-grp { width: 90px; } .w-fu { width: 80px; } .w-day { width: 30px; text-align: center; } .w-date { width: 70px; } .w-flow { width: 45px; text-align: center; } .w-cat { width: 160px; } .w-sort { width: 35px; text-align: center; }
        .w-acc { width: 170px; } .w-note { width: 40px; text-align: center; cursor: pointer; font-size: 1rem; } .w-cur { width: 35px; text-align: center; } .w-tot { width: 90px; text-align: right; } .w-mnth { width: 50px; text-align: center; } .w-stat { width: 70px; } .w-who { width: 70px; } .w-del { width: 40px; text-align: center; }
        #auth_status { font-size: 0.75rem; margin-top: 10px; text-align: center; color: var(--primary); font-weight: 600; -webkit-font-smoothing: antialiased; }
        #log_btn { margin-top: 15px; width: 100%; background: var(--primary); color: white; font-size: 0.7rem; border-radius: 6px; padding: 8px; display: block; border: none; font-weight: 600; }
        #trace_log { margin-top: 15px; padding: 10px; background: #2c3e50; color: #00ff00; font-family: "Courier New", monospace; font-size: 0.6rem; border-radius: 6px; max-height: 120px; overflow-y: auto; white-space: pre-wrap; display: none; cursor: pointer; }
        .txt-center { text-align: center; }
        #note_modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        #flow_modal { display: none; position: fixed; z-index: 1050; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; margin: 15% auto; padding: 20px; width: 80%; max-width: 400px; border-radius: 12px; }
        /* v3-15: Calculator modal styling */
        #calc_modal { display:none; position:fixed; z-index:1100; left:0; top:0; width:100%; height:100%; background: rgba(0,0,0,0.5); }
        #calc_modal .modal-content { background:white; margin:10% auto; padding:18px; width:92%; max-width:520px; border-radius:14px; box-shadow:0 6px 24px rgba(0,0,0,0.25); }
        .calc-row { display:grid; grid-template-columns: repeat(4, 1fr); gap:10px; margin-top:10px; }
        .calc-btn { border:none; border-radius:10px; padding:14px 10px; font-weight:800; font-size:1rem; cursor:pointer; background:#eef2f7; color:#2c3e50; }
        .calc-btn.op { background:#e6ebf3; }
        .calc-btn.bridge { background: var(--bridge); color:white; }
        .calc-btn.accent { background: var(--accent); color:white; }
        .calc-btn.danger { background:#fbeceb; color:#c0392b; }
        .calc-display { margin-top:10px; font-size:0.8rem; font-weight:700; color:#7f8c8d; }
        .calc-result { font-size:1.6rem; font-weight:900; color: var(--primary); margin-top:2px; }
    </style>
</head>
<body>
<div class="container">
    <div class="header-wrap">
        <div class="branding-row"><b>EBS Input</b> <span>v3-15</span></div>
        <div class="header-btns">
            <button class="btn-lookup btn-cache-pull" onclick="checkEditState(() => cachePull())">Pull local<br>Lookups</button>
            <button class="btn-lookup" id="refresh_btn" onclick="checkEditState(() => initRefresh())">Refresh<br>Lookups from Sheets</button>
            <button class="btn-lookup btn-cache-save" onclick="checkEditState(() => cacheSave())">Save to<br>local Lookups</button>
            <button class="btn-lookup btn-test-mode" onclick="checkEditState(() => useTestData())">Pull test<br>Lookups</button>
            <button class="btn-lookup btn-reset-ui" id="resetBtn" onclick="handleResetConfirm()">Reset</button>
        </div>
    </div>

    <div style="display:grid; grid-template-columns: 0.8fr 1fr 1.2fr; gap:10px;">
        <div><label>Type</label><select id="colB" onchange="handleManualFU()"></select></div>
        <div><label>Grouping</label><select id="colA"></select></div>
        <div><label>Date</label><div class="date-input-container" onclick="document.getElementById('colC').showPicker()"><span>ðŸ“…</span><input type="date" id="colC" onchange="handleDateChange()"></div><div id="colCDisp" style="font-size:0.65rem; color:#7f8c8d; text-align:center; margin-top:2px;"></div></div>
    </div>

    <div style="display:grid; grid-template-columns: 1fr 0.4fr 0.3fr; gap:10px; margin-top:10px;">
        <div><label>Category</label><select id="colF" required onchange="handleCatTrigger()"></select></div>
        <div><label style="text-align:center;">Flow</label><div id="flowDisplay" class="type-display">--</div></div>
        <div><label>Sort</label><input type="number" id="colG" placeholder="0" onfocus="this.value=''"></div>
    </div>

    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
        <div><label>From</label><select id="colH" required onchange="handleAccTrigger()"></select></div>
        <div><label>To</label><select id="colI" required onchange="handleAccTrigger()"></select></div>
    </div>

    <div style="margin-top:10px;"><label>Note</label><textarea id="colK" rows="2" style="font-size:16px;"></textarea></div>

    <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-top:10px;">
        <div><label>Frequency</label><select id="colFreq"></select></div>
        <div><label>Status</label><select id="colStatus"></select></div>
        <div><label>Month</label><select id="colZ"></select></div>
    </div>

    <div style="display:grid; grid-template-columns:1fr 40px 1fr 1fr 1fr; gap:8px; margin-top:10px;">
        <div><label>Each</label><input type="number" id="colT" placeholder="0.00" step="0.01" onfocus="handleEachFocus(event)" oninput="calc()"></div>
        <div style="display:flex; align-items:end;"><button onclick="openCalculatorHook()" style="width:100%; height:38px; border:none; border-radius:6px; background:var(--bridge); color:white; font-weight:900; cursor:pointer;">Â±</button></div>
        <div><label>Currency</label><select id="colX" onchange="calc()"></select></div>
        <div><label>Fees</label><input type="number" id="colV" placeholder="0.00" step="0.01" onfocus="this.value=''" oninput="calc()"></div>
        <div><label>Multiplier</label><input type="number" id="colM" value="1" step="0.01" oninput="calc()"></div>
    </div>

    <div class="total-box"><div class="total-val"><span id="symbol">Â£</span> <span id="totalDisp">0.00</span></div></div>

    <div class="actions">
        <button class="action-main" onclick="handleMainAction('create')" style="background:var(--accent);">Create Staging record</button>
        <button class="action-main" id="sync_btn" onclick="checkEditState(() => handleSync())" style="background:var(--bridge);">Send Staging records to Sheets</button>
        <button class="action-main" id="wipeBtn" onclick="handleWipeConfirm()" style="background:var(--danger); opacity: 0.85;">Clear Staging records</button>
    </div>

    <div class="preview-wrap" id="previewArea"></div>
    <div id="auth_status">iOS Sync Status: Idle</div>
    <button id="log_btn" onclick="toggleLog(true)">Display Trace Log</button>
    <div id="trace_log" onclick="toggleLog(false)">Trace: v3-15 Logic Circuit Breaker active.</div>
</div>

<div id="note_modal">
    <div class="modal-content">
        <label>Edit Transaction Note</label>
        <textarea id="modal_note_text" rows="4" style="margin-top:10px;"></textarea>
        <div style="display:flex; gap:10px; margin-top:15px;">
            <button onclick="commitNote()" style="flex:1; background:var(--accent); color:white; padding:10px; border-radius:6px; border:none; font-weight:bold;">Save Note</button>
            <button onclick="closeNote()" style="flex:1; background:#7f8c8d; color:white; padding:10px; border-radius:6px; border:none; font-weight:bold;">Cancel</button>
        </div>
    </div>
</div>

<div id="flow_modal">
    <div class="modal-content">
        <label>Flow is required</label>
        <div style="font-size:0.75rem; color:#7f8c8d; margin-top:6px; line-height:1.2;">
            Select <b>From</b> and <b>To</b accounts to derive Flow automatically.
        </div>
        <div style="display:flex; gap:10px; margin-top:15px;">
            <button onclick="closeFlowModal()" style="flex:1; background:#7f8c8d; color:white; padding:10px; border-radius:6px; border:none; font-weight:bold;">OK</button>
        </div>
    </div>
</div>

<div id="calc_modal">
  <div class="modal-content">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
      <div style="font-weight:900; font-size:1.05rem;">Calculator</div>
      <div style="font-size:0.75rem; color:#7f8c8d;">v3-15</div>
    </div>

    <div style="margin-top:10px;">
      <input id="calc_expr" type="text" inputmode="decimal" autocomplete="off"
             style="width:100%; font-size:1.1rem; padding:10px; border:1px solid #dcdde1; border-radius:10px;" />
      <div class="calc-display">Result</div>
      <div id="calc_result" class="calc-result">0</div>
    </div>

    <!-- v3-15: Parentheses removed. '=' evaluates and keeps modal open. -->
    <div class="calc-row">
      <button class="calc-btn danger" onclick="calcClear()">C</button>
      <button class="calc-btn op" onclick="calcBack()">âŒ«</button>
      <button class="calc-btn op" onclick="calcPress('/')">Ã·</button>
      <button class="calc-btn op" onclick="calcPress('*')">Ã—</button>
    </div>
    <div class="calc-row">
      <button class="calc-btn" onclick="calcPress('7')">7</button>
      <button class="calc-btn" onclick="calcPress('8')">8</button>
      <button class="calc-btn" onclick="calcPress('9')">9</button>
      <button class="calc-btn op" onclick="calcPress('-')">âˆ’</button>
    </div>
    <div class="calc-row">
      <button class="calc-btn" onclick="calcPress('4')">4</button>
      <button class="calc-btn" onclick="calcPress('5')">5</button>
      <button class="calc-btn" onclick="calcPress('6')">6</button>
      <button class="calc-btn op" onclick="calcPress('+')">+</button>
    </div>
    <div class="calc-row">
      <button class="calc-btn" onclick="calcPress('1')">1</button>
      <button class="calc-btn" onclick="calcPress('2')">2</button>
      <button class="calc-btn" onclick="calcPress('3')">3</button>
      <button class="calc-btn bridge" onclick="calcEvaluate(true)">=</button>
    </div>
    <div class="calc-row">
      <button class="calc-btn" onclick="calcPress('0')">0</button>
      <button class="calc-btn" onclick="calcPress('00')">00</button>
      <button class="calc-btn" onclick="calcPress('.')">.</button>
      <button class="calc-btn op" style="opacity:0.35; cursor:default;" onclick="return false;"> </button>
    </div>

    <div style="display:flex; gap:10px; margin-top:12px;">
      <button class="calc-btn accent" onclick="calcApply()" style="flex:1;">Apply</button>
      <button class="calc-btn op" onclick="calcClose()" style="flex:1;">Close</button>
    </div>
  </div>
</div>

<script>
    const SHEET_ID = '1DdjG4B8wB9llk7yOoRRO72G0XqHEgFkMIlLuusShA6E';
    const VER = "Excel Budget Sheet Input (v3-15)";
    let AA_LIST = [], coordinateMap = {}, symbols = { "GBP": "Â£", "EUR": "â‚¬", "USD": "$", "ZAR": "R", "CHF": "Fr", "THB": "à¸¿", "RUR": "â‚½", "COP": "COL$" };
    let tokenClient, editIndex = -1, pendingEdit = -1, activeNoteIdx = -1, rawLookupData = [], wipeConfirmed = false, isRestoring = false, resetConfirmed = false;

    const TEST_SET = { "Grouping": ["Roy", "Peter"], "FU": ["v Verified", "xf Transfer", "S Support"], "Categories": ["Food", "Transfer", "Support Misc", "Salary", "Rent"], "Accounts": ["Santander P (AA)", "Revolut P (AA)", "Starling B (AA)"], "AA": ["Santander P (AA)", "Revolut P (AA)", "Starling B (AA)"], "Freq": ["A Ad-hoc", "M Monthly", "K Keep in credit"], "Status": ["N New", "P Paid"], "Month": ["NEW", "JAN", "FEB"], "Cur": ["GBP", "EUR", "ZAR"] };

    function logTrace(msg) {
    const log = document.getElementById('trace_log');
    const now = new Date().toLocaleTimeString();
    if (!log) return;
    // v3-15: Firefox/macOS-safe newline enforcement
    const cur = (log.textContent || '').replace(/\r\n/g, '\n');
    const base = cur.endsWith('\n') ? cur : (cur + '\n');
    log.textContent = base + `[${now}] ${msg}\n`;
    log.scrollTop = log.scrollHeight;
  }

  function initTraceLog() {
    // v3-15: Seed trace header + newline so early log entries render correctly.
    const log = document.getElementById('trace_log');
    if (!log) return;
    log.textContent = `Trace: v3-15 Logic Circuit Breaker active.\n`;
  }

    function toggleLog(show) { document.getElementById('log_btn').style.display = show ? 'none' : 'block'; document.getElementById('trace_log').style.display = show ? 'block' : 'none'; }
    function gapiLoaded() { gapi.load('client', async () => { await gapi.client.init({ apiKey: 'AIzaSyDvZ1XZw5bZgWSB9zaU7h9Vtn7MhDGFMSM' }); await gapi.client.load('sheets', 'v4'); logTrace("GAPI Ready. (v3-15)"); }); }
    function gisLoaded() { tokenClient = google.accounts.oauth2.initTokenClient({ client_id: '23231735212-jtgur3sn2ndh798ke00pm2a1d5rkd4eu.apps.googleusercontent.com', scope: 'https://www.googleapis.com/auth/spreadsheets', callback: (resp) => { if (resp.access_token) { localStorage.setItem('g_token', resp.access_token); localStorage.setItem('g_token_ts', String(Date.now())); fetchLookupRefs(); } } }); logTrace("GIS Ready. (v3-15)"); }

    function checkEditState(onSuccess) {
        if (pendingEdit !== -1 || editIndex !== -1) {
            alert("This function is not available while Edit is in progress for a Staging entry.");
            return;
        }
        onSuccess();
    }

    function handleResetConfirm() {
    const btn = document.getElementById('resetBtn');
    if (!resetConfirmed) {
      resetConfirmed = true;
      btn.innerText = "CONFIRM?";
      setTimeout(() => { resetConfirmed = false; btn.innerText = "Reset"; }, 3000);
    } else {
      localReset();
      resetConfirmed = false;
      btn.innerText = "Reset";
    }
  }

  function handleWipeConfirm() {
    const btn = document.getElementById('wipeBtn');
    if (!wipeConfirmed) {
      wipeConfirmed = true;
      btn.innerText = "CONFIRM?";
      setTimeout(() => { wipeConfirmed = false; btn.innerText = "Clear Staging records"; }, 3000);
    } else {
      localStorage.removeItem('ebs_trf');
      wipeConfirmed = false;
      btn.innerText = "Clear Staging records";
      renderPreview();
      logTrace("Staging wiped manually. (v3-15)");
    }
  }

    function useTestData() {
      if (!confirm("Overwrite values with test set?")) return;
      AA_LIST = TEST_SET.AA;
      coordinateMap = {"Grouping":{val:0},"F/U":{val:1},"Category":{val:2},"From":{val:3},"To":{val:4},"Frequency":{val:5},"Status":{val:6},"Month":{val:7},"Currency":{val:8}};
      updateDropdown('colA', TEST_SET.Grouping, 'Roy');
      updateDropdown('colB', TEST_SET.FU, 'v');
      updateDropdown('colF', TEST_SET.Categories, null, '--Select--');
      updateDropdown('colH', TEST_SET.Accounts, null, '--Select--');
      updateDropdown('colI', TEST_SET.Accounts, null, '--Select--');
      updateDropdown('colFreq', TEST_SET.Freq, 'A');
      updateDropdown('colStatus', TEST_SET.Status, 'N');
      updateDropdown('colZ', TEST_SET.Month, 'NEW');
      updateDropdown('colX', TEST_SET.Cur, 'GBP');
      localReset();
      logTrace("Test Data Injected. (v3-15)");
    }

    function cacheSave() {
      if (rawLookupData.length === 0) { alert("Refresh Lookups First"); return; }
      if (!confirm("Snapshot active values?")) return;
      localStorage.setItem('ebs_cache_data', JSON.stringify(rawLookupData));
      localStorage.setItem('ebs_cache_coords', JSON.stringify(coordinateMap));
      localStorage.setItem('ebs_cache_aa', JSON.stringify(AA_LIST));
      logTrace("local UI Snapshotted. (v3-15)");
    }

    function cachePull() {
      if (!confirm("Do you want to load local Lookups?")) return;
      const cached = localStorage.getItem('ebs_cache_data');
      if (cached) {
        rawLookupData = JSON.parse(cached);
        coordinateMap = JSON.parse(localStorage.getItem('ebs_cache_coords'));
        AA_LIST = JSON.parse(localStorage.getItem('ebs_cache_aa'));
        populateUI(rawLookupData);
        logTrace("local Snapshot Loaded. (v3-15)");
      } else { alert("No snapshot found."); }
    }

    function initRefresh() { tokenClient.requestAccessToken({ prompt: '' }); }

    async function fetchLookupRefs() {
      document.getElementById('auth_status').innerText = "Sync Status: Fetching Refs...";
      const res = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SHEET_ID, range: 'LookupRefs!A2:C15' });
      res.result.values.forEach(r => { coordinateMap[r[0]] = { val: colToIndex(r[1].toUpperCase().replace(/[0-9]/g, '')), desc: (r[2] && r[2].toLowerCase() !== 'n/a') ? colToIndex(r[2]) : null }; });
      fetchActiveAccounts();
    }

    function colToIndex(col) { let idx = 0; for(let i=0; i<col.length; i++) { idx = idx * 26 + (col.charCodeAt(i) - 64); } return idx - 1; }

    async function fetchActiveAccounts() {
      const res = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SHEET_ID, range: 'ActiveAccounts!A2:A500' });
      AA_LIST = res.result.values ? res.result.values.flat().filter(v => v) : [];
      fetchActualData();
    }

    async function fetchActualData() {
      const res = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SHEET_ID, range: 'Lookups!A2:AC1000' });
      rawLookupData = res.result.values || [];
      populateUI(rawLookupData);
      document.getElementById('auth_status').innerText = "iOS Sync Status: Token Active";
      alert("Lookup refresh completed.");
    }

    function populateUI(data) {
      const pop = (id, key, def, p = null) => {
        const list = data.filter(r => r[coordinateMap[key].val]).map(r => { const v = r[coordinateMap[key].val], d = coordinateMap[key].desc !== null ? r[coordinateMap[key].desc] : null; return d ? `${v} ${d}` : v; });
        updateDropdown(id, list, def, p);
      };
      pop('colA','Grouping','Roy');
      pop('colB','F/U','v');
      pop('colF','Category',null,'--Select--');
      pop('colH','From',null,'--Select--');
      pop('colI','To',null,'--Select--');
      pop('colFreq','Frequency','A');
      pop('colStatus','Status','N');
      pop('colZ','Month','NEW');
      pop('colX','Currency','GBP');
      localReset();
    }

    function updateDropdown(id, vals, def, prompt) {
      const s = document.getElementById(id);
      let h = prompt ? `<option value="" disabled selected>${prompt}</option>` : '';
      h += vals.map(v => `<option value="${v}">${v}</option>`).join('');
      s.innerHTML = h;
      if(def) {
        const o = Array.from(s.options).find(opt => opt.value.startsWith(def));
        if(o) s.value = o.value;
      }
    }

    function localReset() {
      ['colT','colV','colG','colK'].forEach(id => { const el = document.getElementById(id); if(el) el.value = ""; });
      document.getElementById('colM').value = "1";
      document.getElementById('flowDisplay').innerText = "--";
      editIndex = -1;
      pendingEdit = -1;
      const rS = (id, def) => {
        const s = document.getElementById(id);
        if(!s) return;
        if(def) {
          const o = Array.from(s.options).find(opt => opt.value.startsWith(def));
          if(o) s.value = o.value;
        } else s.selectedIndex = 0;
      };
      rS('colA','Roy');
      rS('colB','v');
      rS('colF',null);
      rS('colH',null);
      rS('colI',null);
      rS('colFreq','A');
      rS('colStatus','N');
      rS('colZ','NEW');
      rS('colX','GBP');
      renderPreview();
      calc();
      logTrace("UI Reset Invoked. (v3-15)");
    }

    function handleEachFocus(ev) {
      // v3-15: Each focus behaviour
      const el = ev && ev.target ? ev.target : document.getElementById('colT');
      if (!el) return;
      const raw = String(el.value ?? '').trim();
      const num = raw === '' ? NaN : Number(raw);
      if (raw === '' || (Number.isFinite(num) && num === 0)) {
        el.value = '';
        return;
      }
      try {
        const len = el.value.length;
        el.setSelectionRange(len, len);
      } catch (e) {}
    }

    function handleAccTrigger() {
        if (isRestoring) return;
        const h = document.getElementById('colH').value, i = document.getElementById('colI').value;
        if (!h || !i || h.includes("--") || i.includes("--")) return;

        const fAA = AA_LIST.includes(h), tAA = AA_LIST.includes(i);
        let flow = "--";
        if (fAA && tAA) flow = "xfer";
        else if (!fAA && tAA) flow = "In";
        else if (fAA && !tAA) flow = "zOut";
        document.getElementById('flowDisplay').innerText = flow;

        // If category is support, keep Type as S Support if available.
        const cat = (document.getElementById('colF').value || '');
        if (cat.toLowerCase().includes("support")) {
          const fuSel = document.getElementById('colB');
          const sOpt = Array.from(fuSel.options).find(o => (o.value || '').startsWith('S'));
          if (sOpt) fuSel.value = sOpt.value;
        }
    }

    function handleCatTrigger() {
        if (isRestoring) return;

    // v3-15: Support category forces Frequency to Ad-hoc
    const fVal = (document.getElementById('colF').value || '');
    if (fVal.toLowerCase().includes('support')) {
      const freqSel = document.getElementById('colFreq');
      const optA = freqSel ? Array.from(freqSel.options).find(o => (o.value || '').startsWith('A')) : null;
      if (optA) freqSel.value = optA.value;
    }

        const f = document.getElementById('colF').value, fu = document.getElementById('colB');
        if ((f || '').toLowerCase().includes('support')) {
          const s = Array.from(fu.options).find(o => (o.value || '').startsWith('S'));
          if(s) fu.value = s.value;
        }
    }

    function handleDateChange() {
      const dStr = document.getElementById('colC').value;
      if(!dStr) return;
      const [y, m, d] = dStr.split('-').map(Number);
      const dt = new Date(y, m-1, d);
      document.getElementById('colCDisp').innerText = `${['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][dt.getDay()]} ${dt.getDate()} ${['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][dt.getMonth()]} '${String(dt.getFullYear()).substr(-2)}`;
    }

    function calc() {
      const t = parseFloat(document.getElementById('colT').value)||0,
            u = parseFloat(document.getElementById('colM').value)||1,
            v = parseFloat(document.getElementById('colV').value)||0;
      const tot = ((t * u) + v).toFixed(2);
      const curCode = (document.getElementById('colX').value.split(' ')[0] || 'GBP');
      document.getElementById('symbol').innerText = symbols[curCode]||"Â£";
      document.getElementById('totalDisp').innerText = tot;
      return tot;
    }

    function handleManualFU() { if(document.getElementById('colB').value.startsWith('xf')) document.getElementById('colF').value = "Transfer"; }

    function openFlowModal() { document.getElementById('flow_modal').style.display = 'block'; }
    function closeFlowModal() { document.getElementById('flow_modal').style.display = 'none'; }

    function initiateEdit(idx) {
        if (pendingEdit === idx) {
            isRestoring = true;
            editIndex = idx; pendingEdit = -1;
            const d = JSON.parse(localStorage.getItem('ebs_trf'))[idx];
            const setUI = (id, val, isDrop = false) => {
                const el = document.getElementById(id); if(!el) return;
                if(!isDrop) el.value = val;
                else {
                    const code = val.split(' ')[0];
                    const o = Array.from(el.options).find(opt => opt.value.startsWith(code));
                    if(o) el.value = o.value;
                }
            };

            setUI('colA', d[0], true);
            setUI('colB', d[1], true);
            setUI('colC', d[2]);
            setUI('colF', d[5], true);
            setUI('colG', d[6]);
            setUI('colH', d[7], true);
            setUI('colI', d[8], true);
            setUI('colK', d[10]);
            setUI('colFreq', d[11], true);
            setUI('colStatus', d[14], true);
            setUI('colT', d[19]);
            setUI('colM', d[20]);
            setUI('colV', d[21]);
            setUI('colX', d[23], true);
            setUI('colZ', d[25], true);

            // Restore flow
            document.getElementById('flowDisplay').innerText = d[4] || "--";

            handleDateChange();
            calc();
            isRestoring = false;
            logTrace("Record successfully pulled for edit. (v3-15)");
        } else {
            pendingEdit = idx; editIndex = -1;
            logTrace("Confirming edit... (v3-15)");
        }
        renderPreview();
    }

    function openNote(idx) { activeNoteIdx = idx; const d = JSON.parse(localStorage.getItem('ebs_trf')); document.getElementById('modal_note_text').value = d[idx][10] || ""; document.getElementById('note_modal').style.display = 'block'; }
    function closeNote() { document.getElementById('note_modal').style.display = 'none'; activeNoteIdx = -1; }
    function commitNote() { let d = JSON.parse(localStorage.getItem('ebs_trf')); d[activeNoteIdx][10] = document.getElementById('modal_note_text').value; localStorage.setItem('ebs_trf', JSON.stringify(d)); closeNote(); renderPreview(); logTrace("Note Updated. (v3-15)"); }

    function deleteRow(i) { let d = JSON.parse(localStorage.getItem('ebs_trf') || '[]'); d.splice(i, 1); localStorage.setItem('ebs_trf', JSON.stringify(d)); editIndex = -1; pendingEdit = -1; renderPreview(); }

    function renderPreview() {
      const d = JSON.parse(localStorage.getItem('ebs_trf') || '[]');
      let h = '<table><tr>'
        + '<th class="w-edit">Edit</th>'
        + '<th class="w-grp">Grouping</th>'
        + '<th class="w-fu">Type</th>'
        + '<th class="w-day">Day</th>'
        + '<th class="w-date">Date</th>'
        + '<th class="w-flow">Flow</th>'
        + '<th class="w-cat">Category</th>'
        + '<th class="w-sort">Sort</th>'
        + '<th class="w-acc">From</th>'
        + '<th class="w-acc">To</th>'
        + '</tr>';

      d.forEach((r, idx) => {
        let bS = "background:#3498db", bL = "E", fN = `initiateEdit(${idx})`;
        if (pendingEdit === idx) { bS = "background:red"; bL = "..."; }
        else if (editIndex === idx) { bS = "background:#f39c12"; bL = "C"; fN = `handleMainAction('commit')`; }

        const [y, m, dn] = (r[2] || '1970-01-01').split('-').map(Number);
        const dt = new Date(y, m-1, dn);
        const dNam = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][dt.getDay()];
        const dStr = `${String(dn).padStart(2,'0')} ${['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][dt.getMonth()]} '${String(dt.getFullYear()).substr(-2)}`;

        h += '<tr>'
          + `<td class="w-edit"><button onclick="${fN}" style="${bS};color:white;border:none;border-radius:4px;padding:2px 6px;width:28px;">${bL}</button></td>`
          + `<td>${r[0] || ''}</td>`
          + `<td>${r[1] || ''}</td>`
          + `<td class="txt-center">${dNam}</td>`
          + `<td>${dStr}</td>`
          + `<td class="txt-center">${r[4] || ''}</td>`
          + `<td>${r[5] || ''}</td>`
          + `<td class="txt-center">${r[6] || ''}</td>`
          + `<td>${r[7] || ''}</td>`
          + `<td>${r[8] || ''}</td>`
          + '</tr>';
      });

      document.getElementById('previewArea').innerHTML = h + '</table>';
      logTrace(`Table Rendered. Active Rows: ${d.length} (v3-15)`);
    }

    async function handleSync() {
      const d = JSON.parse(localStorage.getItem('ebs_trf') || '[]');
      if (!d.length) return;
      document.getElementById('auth_status').innerText = "iOS Sync Status: Syncing...";

      tokenClient.callback = async (resp) => {
        if (!resp.access_token) return;
        try {
          const meta = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SHEET_ID, range: "'EBSinput'!A:A" });
          const nR = (meta.result.values ? meta.result.values.length : 0) + 1;

          const vls = d.map(r => {
            let rc = [...r];
            const dP = (rc[2] || '').split('-');
            if (dP.length === 3) rc[2] = `${dP[2]}/${dP[1]}/${dP[0]}`;
            [1, 5, 11, 14, 23, 25].forEach(i => { if (rc[i]) rc[i] = rc[i].split(' ')[0]; });
            [7, 8].forEach(i => { if (rc[i]) rc[i] = rc[i].replace(/ \(AA\)/g, ''); });
            [19, 21, 22].forEach(i => rc[i] = parseFloat(rc[i] || 0));
            return rc;
          });

          await gapi.client.sheets.spreadsheets.values.update({
            spreadsheetId: SHEET_ID,
            range: `'EBSinput'!A${nR}:AI${nR + vls.length - 1}`,
            valueInputOption: 'USER_ENTERED',
            resource: { values: vls }
          });

          alert("Sync completed.");
          document.getElementById('auth_status').innerText = "iOS Sync Status: Token Active";
          logTrace("Sync complete. (v3-15)");
        } catch (e) {
          logTrace("Sync Fail. (v3-15)");
          document.getElementById('auth_status').innerText = "iOS Sync Status: Error";
        }
      };

      tokenClient.requestAccessToken({ prompt: '' });
    }

    function handleMainAction(mode = 'create') {
    logTrace(`Action Triggered. mode=${mode} (v3-15)`);

    // v3-15: Create during pending edit ("...") duplicates that row and abandons edit.
    if (mode === 'create' && pendingEdit > -1 && editIndex === -1) {
      const masterList = JSON.parse(localStorage.getItem('ebs_trf') || '[]');
      const src = masterList[pendingEdit];
      if (!src) { alert("Missing data."); return; }
      const cloned = [...src];
      cloned[34] = VER;
      masterList.push(cloned);
      localStorage.setItem('ebs_trf', JSON.stringify(masterList));
      logTrace(`Pending edit abandoned; row ${pendingEdit} duplicated. (v3-15)`);
      localReset();
      return;
    }

    // v3-15: After a hard refresh, Lookups may not be available yet.
    if (rawLookupData.length === 0) {
      alert("First Pull local Lookups, or Refresh Lookups from Sheets.");
      return;
    }

    const fv = document.getElementById('colF').value, hv = document.getElementById('colH').value, iv = document.getElementById('colI').value;
    if (!fv || !hv || !iv || fv.includes("--") || hv.includes("--") || iv.includes("--")) { alert("Missing data."); return; }

    const flowV = document.getElementById('flowDisplay').innerText;
    if (flowV === "--") { openFlowModal(); return; }

    let wV = "";
    if ((fv || '').toLowerCase().includes("support")) wV = document.getElementById('colA').value;

    const finalPackage = [
      document.getElementById('colA').value, document.getElementById('colB').value, document.getElementById('colC').value,
      "", flowV, document.getElementById('colF').value, document.getElementById('colG').value,
      document.getElementById('colH').value, document.getElementById('colI').value, "",
      document.getElementById('colK').value, document.getElementById('colFreq').value, "", "",
      document.getElementById('colStatus').value, "", "", "", "",
      parseFloat(document.getElementById('colT').value || 0).toFixed(2), document.getElementById('colM').value,
      parseFloat(document.getElementById('colV').value || 0).toFixed(2), calc(),
      document.getElementById('colX').value, "", document.getElementById('colZ').value,
      "", "", "", "", "", "", "", wV, VER
    ];

    let masterList = JSON.parse(localStorage.getItem('ebs_trf') || '[]');

    // v3-15: Create during active edit ("C") appends new record and abandons edit.
    if (mode === 'create' && editIndex > -1) {
      masterList.push(finalPackage);
      localStorage.setItem('ebs_trf', JSON.stringify(masterList));
      logTrace(`Active edit abandoned; new record appended from UI. (v3-15)`);
      localReset();
      return;
    }

    if (mode === 'commit' && editIndex > -1) {
      masterList[editIndex] = finalPackage;
      logTrace(`Logic Update: Row ${editIndex} Overwritten (Commit). (v3-15)`);
    } else {
      masterList.push(finalPackage);
      logTrace("Logic Update: New Record Appended. (v3-15)");
    }

    localStorage.setItem('ebs_trf', JSON.stringify(masterList));
    logTrace("Storage Synced. (v3-15)");
    localReset();
  }

  function openCalculatorHook() {
    // v3-15: Open calculator modal; inherit current Each field value
    const modal = document.getElementById('calc_modal');
    const expr = document.getElementById('calc_expr');
    const res = document.getElementById('calc_result');
    if (!modal || !expr || !res) return;

    const cur = String(document.getElementById('colT').value || '').trim();
    expr.value = cur !== '' ? cur : '0';
    calcEvaluate(false);
    modal.style.display = 'block';
    try { expr.focus(); expr.setSelectionRange(expr.value.length, expr.value.length); } catch (e) {}
    logTrace("Calculator opened. (v3-15)");
  }

  // v3-15: Calculator helpers (safe expression evaluation)
  function calcSanitise(expr) {
    const raw = String(expr || '').replace(/Ã—/g, '*').replace(/Ã·/g, '/');
    if (!/^[0-9+\-*/.\s]*$/.test(raw)) return null;
    return raw;
  }

  function calcEvaluate(showToast) {
    const exprEl = document.getElementById('calc_expr');
    const resEl = document.getElementById('calc_result');
    if (!exprEl || !resEl) return null;

    const cleaned = calcSanitise(exprEl.value);
    if (cleaned === null) {
      resEl.textContent = "ERR";
      if (showToast) alert("Invalid expression.");
      return null;
    }

    try {
      const fn = Function('"use strict"; return (' + (cleaned || "0") + ');');
      const v = fn();
      const num = Number(v);
      if (!Number.isFinite(num)) throw new Error("NaN");
      const fixed = (Math.round(num * 100) / 100).toFixed(2);
      resEl.textContent = fixed;
      return fixed;
    } catch (e) {
      resEl.textContent = "ERR";
      if (showToast) alert("Calculation error.");
      return null;
    }
  }

  function calcPress(ch) {
    const exprEl = document.getElementById('calc_expr');
    if (!exprEl) return;
    exprEl.value = String(exprEl.value || '') + String(ch);
    calcEvaluate(false);
  }

  function calcBack() {
    const exprEl = document.getElementById('calc_expr');
    if (!exprEl) return;
    exprEl.value = String(exprEl.value || '').slice(0, -1);
    calcEvaluate(false);
  }

  function calcClear() {
    const exprEl = document.getElementById('calc_expr');
    if (!exprEl) return;
    exprEl.value = '0';
    calcEvaluate(false);
  }

  function calcApply() {
    const fixed = calcEvaluate(false);
    if (fixed === null) return;
    const each = document.getElementById('colT');
    if (each) each.value = fixed;
    calc();
    calcClose();
    logTrace("Calculator Apply => Each updated. (v3-15)");
  }

  function calcClose() {
    const modal = document.getElementById('calc_modal');
    if (modal) modal.style.display = 'none';
  }

    window.onload = () => {
    initTraceLog(); // v3-15
    document.getElementById('colC').value = new Date().toISOString().split('T')[0];
    handleDateChange();
    gapiLoaded();
    gisLoaded();
    localReset(); // v3-15: apply standard defaults after refresh
    renderPreview();
  };
</script>
</body>
</html>