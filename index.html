<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>EBS Input v3-74.1</title>

  <style>
    :root{
      --bg:#f4f6f8;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --line:#d1d5db;
      --soft:#eef2f7;
      --green:#16a34a;
      --blue:#1d73b7;
      --red:#c0392b;
      --btnText:#ffffff;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
    }

    .page{
      max-width:980px;
      margin:0 auto;
      padding:12px;
    }

    .branding-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:10px 12px;
      background:var(--card);
      border:1px solid var(--line);
      border-radius:12px;
      margin-bottom:12px;
    }
    .branding-row b{font-size:16px}
    .branding-row span{color:var(--muted); font-weight:600}

    .grid{
      display:grid;
      grid-template-columns:1fr 1fr 1fr;
      gap:12px;
    }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:12px;
      padding:12px;
    }
    .card h3{
      margin:0 0 10px 0;
      font-size:14px;
      color:var(--muted);
      letter-spacing:.2px;
    }

    .row{
      display:grid;
      grid-template-columns:1fr 1fr 1fr;
      gap:12px;
      align-items:end;
      margin-bottom:10px;
    }
    .row2{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
      align-items:end;
      margin-bottom:10px;
    }
    .row4{
      display:grid;
      grid-template-columns:1fr 1fr 1fr 1fr;
      gap:12px;
      align-items:end;
      margin-bottom:10px;
    }

    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin:0 0 6px 0;
      font-weight:600;
      letter-spacing:.2px;
    }

    select, input[type="text"], input[type="number"], input[type="date"], textarea{
      width:100%;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:10px;
      background:#fff;
      font-size:16px;
      outline:none;
    }

    textarea{
      min-height:42px;
      resize:vertical;
    }

    .amount-box{
      border:2px dashed #48b16a;
      border-radius:12px;
      padding:12px;
      text-align:center;
      font-weight:800;
      color:#0c7a2e;
      font-size:34px;
      background:#e8f6ee;
    }

    .mini{
      display:flex;
      align-items:center;
      gap:8px;
    }

    .btnRow{
      display:grid;
      grid-template-columns:1fr 1fr 1fr;
      gap:12px;
      margin-top:12px;
    }
    button{
      appearance:none;
      border:0;
      border-radius:12px;
      padding:14px 12px;
      font-size:16px;
      font-weight:800;
      color:var(--btnText);
      cursor:pointer;
    }
    .btnGreen{background:var(--green)}
    .btnBlue{background:var(--blue)}
    .btnRed{background:var(--red)}
    button:active{transform:translateY(1px)}
    button:disabled{opacity:.6; cursor:not-allowed}

    .tableWrap{
      margin-top:12px;
      background:var(--card);
      border:1px solid var(--line);
      border-radius:12px;
      overflow:hidden;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:14px;
    }
    thead th{
      background:#f1f5f9;
      color:#111827;
      text-align:left;
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      font-weight:800;
    }
    tbody td{
      padding:10px 10px;
      border-bottom:1px solid #e5e7eb;
      vertical-align:middle;
    }
    tbody tr:last-child td{border-bottom:0}

    .center{text-align:center}
    .right{text-align:right}
    .muted{color:var(--muted)}

    .note-cell{
      cursor:pointer;
      user-select:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:26px;
    }

    .note-svg{width:16px; height:16px; display:inline-block; vertical-align:middle; fill:currentColor;}
    .note-svg-empty{width:12px; height:12px; display:inline-block; vertical-align:middle; fill:none; stroke:currentColor; stroke-width:2px;}

    .calcIconBtn{
      width:34px;
      height:34px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border:1px solid var(--line);
      background:#fff;
      border-radius:10px;
      cursor:pointer;
    }
    .calcSvg{width:18px; height:18px; fill:#1d73b7}

    .small{
      font-size:12px;
      color:var(--muted);
      margin-top:10px;
      text-align:center;
      font-weight:700;
    }

    .traceBtn{
      width:100%;
      margin-top:12px;
      background:#3c4a59;
      border-radius:12px;
      padding:14px 12px;
      font-size:16px;
      font-weight:900;
      color:#fff;
    }

    .hidden{display:none !important}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}

    @media (max-width: 780px){
      .grid{grid-template-columns:1fr}
      .row, .row2, .row4{grid-template-columns:1fr 1fr}
      .btnRow{grid-template-columns:1fr}
    }
    @media (max-width: 460px){
      .row, .row2, .row4{grid-template-columns:1fr}
    }

    /* Modal */
    .modalBackdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.45);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:14px;
      z-index:9999;
    }
    .modal{
      width:min(720px, 100%);
      background:#fff;
      border-radius:14px;
      border:1px solid var(--line);
      overflow:hidden;
      box-shadow:0 10px 40px rgba(0,0,0,.18);
    }
    .modalHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:12px 12px;
      background:#f8fafc;
      border-bottom:1px solid var(--line);
      font-weight:900;
    }
    .modalBody{padding:12px}
    .modalBody textarea{min-height:180px}
    .modalFooter{
      display:flex;
      gap:10px;
      padding:12px;
      border-top:1px solid var(--line);
      background:#f8fafc;
      justify-content:flex-end;
    }
    .btnGhost{
      background:#e5e7eb;
      color:#111827;
      font-weight:900;
    }
    .btnPrimary{
      background:#1d73b7;
      color:#fff;
      font-weight:900;
    }
    .btnDanger{
      background:#c0392b;
      color:#fff;
      font-weight:900;
    }
  </style>
</head>

<body>
  <div class="page">
    <div class="branding-row"><b>EBS Input</b> <span>v3-74.1</span></div>

    <div class="grid">
      <div class="card">
        <h3>Header</h3>

        <div class="row">
          <div>
            <label for="typeSel">Type</label>
            <select id="typeSel"></select>
          </div>
          <div>
            <label for="groupSel">Grouping</label>
            <select id="groupSel"></select>
          </div>
          <div>
            <label for="dateInp">Date</label>
            <input id="dateInp" type="date"/>
            <div class="small" id="dateHuman"></div>
          </div>
        </div>

        <div class="row">
          <div style="grid-column:1/3">
            <label for="catSel">Category</label>
            <select id="catSel"></select>
          </div>
          <div>
            <label for="flowSel">Flow</label>
            <select id="flowSel"></select>
          </div>
        </div>

        <div class="row">
          <div>
            <label for="sortInp">Sort</label>
            <input id="sortInp" type="number" step="1" value="0"/>
          </div>
          <div>
            <label for="fromSel">From</label>
            <select id="fromSel"></select>
          </div>
          <div>
            <label for="toSel">To</label>
            <select id="toSel"></select>
          </div>
        </div>

        <div class="row2">
          <div style="grid-column:1/2">
            <label for="noteInp">Note</label>
            <input id="noteInp" type="text" placeholder=""/>
          </div>
          <div class="mini" style="justify-content:flex-end">
            <div class="muted" style="font-weight:900">DEL</div>
            <button id="btnDelNote" class="btnRed" style="padding:10px 10px;border-radius:10px; width:auto">✕</button>
            <div class="muted" style="font-weight:900">text</div>
          </div>
        </div>

        <div class="row">
          <div>
            <label for="freqSel">Frequency</label>
            <select id="freqSel"></select>
          </div>
          <div>
            <label for="statusSel">Status</label>
            <select id="statusSel"></select>
          </div>
          <div>
            <label for="monthSel">Month</label>
            <select id="monthSel"></select>
          </div>
        </div>

        <div class="row4">
          <div>
            <label for="eachInp">Each</label>
            <div style="display:flex; gap:8px; align-items:center">
              <input id="eachInp" type="number" step="0.01" value="0.00"/>
              <div class="calcIconBtn" title="Calculator">
                <svg class="calcSvg" viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M7 2h10a2 2 0 0 1 2 2v16a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2zm0 2v4h10V4H7zm2 7h2v2H9v-2zm4 0h2v2h-2v-2zM9 15h2v2H9v-2zm4 0h2v2h-2v-2z"/>
                </svg>
              </div>
            </div>
          </div>

          <div>
            <label for="feesInp">Fees</label>
            <div style="display:flex; gap:8px; align-items:center">
              <input id="feesInp" type="number" step="0.01" value="0.00"/>
              <div class="calcIconBtn" title="Calculator">
                <svg class="calcSvg" viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M7 2h10a2 2 0 0 1 2 2v16a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2zm0 2v4h10V4H7zm2 7h2v2H9v-2zm4 0h2v2h-2v-2zM9 15h2v2H9v-2zm4 0h2v2h-2v-2z"/>
                </svg>
              </div>
            </div>
          </div>

          <div>
            <label for="multInp">Multiplier</label>
            <div style="display:flex; gap:8px; align-items:center">
              <input id="multInp" type="number" step="1" value="1"/>
              <div class="calcIconBtn" title="Calculator">
                <svg class="calcSvg" viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M7 2h10a2 2 0 0 1 2 2v16a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2zm0 2v4h10V4H7zm2 7h2v2H9v-2zm4 0h2v2h-2v-2zM9 15h2v2H9v-2zm4 0h2v2h-2v-2z"/>
                </svg>
              </div>
            </div>
          </div>

          <div>
            <label for="currSel">Currency</label>
            <select id="currSel"></select>
          </div>
        </div>

        <div class="row2">
          <div class="mini">
            <div class="muted" style="font-weight:900">Amount</div>
            <div style="display:flex; flex-direction:column; align-items:center; gap:6px">
              <div class="muted" style="font-weight:900">Chk flag</div>
              <input id="chkFlag" type="checkbox" style="transform:scale(1.25)"/>
            </div>
          </div>
          <div class="amount-box" id="amountBox">£ 0.00</div>
        </div>

        <div class="btnRow">
          <button id="btnCreate" class="btnGreen">Create Staging record</button>
          <button id="btnSend" class="btnBlue">Send Staging records to<br/>Sheets</button>
          <button id="btnClear" class="btnRed">Clear Staging records</button>
        </div>
      </div>

      <div class="card">
        <h3>Staging</h3>
        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th>Grouping</th>
                <th class="center">Note</th>
                <th>Frequency</th>
                <th>Status</th>
                <th>Currency</th>
              </tr>
            </thead>
            <tbody id="stagingBody"></tbody>
          </table>
        </div>

        <div class="small" style="margin-top:14px; font-size:16px; color:#1f2937">
          <span style="font-weight:900">iOS Sync Status:</span> <span id="syncStatus">Idle</span>
        </div>

        <button class="traceBtn" id="btnTrace">Display Trace Log</button>
      </div>

      <div class="card">
        <h3>Trace</h3>
        <div class="mono" id="traceLog" style="white-space:pre-wrap; font-size:12px; line-height:1.35; color:#111827; background:#0b1020; color:#dbeafe; padding:10px; border-radius:12px; border:1px solid #1f2a44; min-height:260px;">
Trace: v3-74.1 Logic Circuit Breaker active.
        </div>
      </div>
    </div>
  </div>

  <!-- Note Modal -->
  <div id="noteModal" class="modalBackdrop hidden" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modalHeader">
        <div>Staging Note</div>
        <button id="noteCloseX" class="btnGhost" style="padding:8px 10px;border-radius:10px;">✕</button>
      </div>
      <div class="modalBody">
        <div class="muted" style="font-size:12px; font-weight:800; margin-bottom:8px" id="noteRowHint"></div>
        <textarea id="noteModalText"></textarea>
      </div>
      <div class="modalFooter">
        <button id="noteDelete" class="btnDanger">Delete</button>
        <button id="noteCancel" class="btnGhost">Cancel</button>
        <button id="noteSave" class="btnPrimary">Save</button>
      </div>
    </div>
  </div>

<script>
/* ======================
   Version / constants
====================== */
const VER = "Excel Budget Sheet Input (v3-74.1)";

const ICON_NOTE = '<svg class="note-svg" viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path d="M6 2h9l5 5v15a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2z"/><path d="M14 2v6h6"/></svg>';
const ICON_NOTE_EMPTY = '<svg class="note-svg-empty" viewBox="0 0 24 24" aria-hidden="true" focusable="false"><rect x="6" y="6" width="12" height="12" rx="2" ry="2"></rect></svg>';

/* ======================
   UI refs
====================== */
const elType = document.getElementById("typeSel");
const elGroup = document.getElementById("groupSel");
const elDate = document.getElementById("dateInp");
const elDateHuman = document.getElementById("dateHuman");
const elCat = document.getElementById("catSel");
const elFlow = document.getElementById("flowSel");
const elSort = document.getElementById("sortInp");
const elFrom = document.getElementById("fromSel");
const elTo = document.getElementById("toSel");
const elNote = document.getElementById("noteInp");
const btnDelNote = document.getElementById("btnDelNote");
const elFreq = document.getElementById("freqSel");
const elStatus = document.getElementById("statusSel");
const elMonth = document.getElementById("monthSel");
const elEach = document.getElementById("eachInp");
const elFees = document.getElementById("feesInp");
const elMult = document.getElementById("multInp");
const elCurr = document.getElementById("currSel");
const elChk = document.getElementById("chkFlag");
const elAmountBox = document.getElementById("amountBox");

const btnCreate = document.getElementById("btnCreate");
const btnSend = document.getElementById("btnSend");
const btnClear = document.getElementById("btnClear");
const btnTrace = document.getElementById("btnTrace");
const elTrace = document.getElementById("traceLog");
const elSync = document.getElementById("syncStatus");

const stagingBody = document.getElementById("stagingBody");

/* Note modal */
const noteModal = document.getElementById("noteModal");
const noteModalText = document.getElementById("noteModalText");
const noteRowHint = document.getElementById("noteRowHint");
const noteCloseX = document.getElementById("noteCloseX");
const noteCancel = document.getElementById("noteCancel");
const noteSave = document.getElementById("noteSave");
const noteDelete = document.getElementById("noteDelete");

/* ======================
   Data dictionaries
====================== */
const TYPE_OPTS = [
  ["V variable","V variable"],
  ["F fixed","F fixed"],
  ["T transfer","T transfer"]
];

const GROUP_OPTS = ["Roy","Galore","House","Work","Other"];

const CAT_OPTS = [
  "--Select--",
  "Bills",
  "Food",
  "Transport",
  "Health",
  "Entertainment",
  "Savings",
  "Other"
];

const FLOW_OPTS = ["--","In","Out"];

const FROM_OPTS = ["--Select--","HSBC","Monzo","Cash","Card"];
const TO_OPTS   = ["--Select--","HSBC","Monzo","Cash","Card"];

const FREQ_OPTS = [
  ["A Ad-hoc","A Ad-hoc"],
  ["W Weekly","W Weekly"],
  ["M Monthly","M Monthly"],
  ["Q Quarterly","Q Quarterly"],
  ["Y Yearly","Y Yearly"],
  ["2Yr 2 yearly","2Yr 2 yearly"]
];

const STATUS_OPTS = [
  ["N Pending","N Pending"],
  ["F Fixed","F Fixed"],
  ["P Paid","P Paid"],
  ["C Cancelled","C Cancelled"]
];

const MONTH_OPTS = ["NEW","Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

const CURR_OPTS = ["GBP","EUR","USD"];

/* ======================
   State
====================== */
let staging = [];
let activeNoteIndex = -1;

/* ======================
   Helpers
====================== */
function addOpts(sel, arr, asPairs=false){
  sel.innerHTML = "";
  if(asPairs){
    arr.forEach(p=>{
      const o=document.createElement("option");
      o.value=p[0]; o.textContent=p[1];
      sel.appendChild(o);
    });
  }else{
    arr.forEach(v=>{
      const o=document.createElement("option");
      o.value=v; o.textContent=v;
      sel.appendChild(o);
    });
  }
}

function fmtGBP(v){
  const n = Number(v||0);
  return "£ " + n.toFixed(2);
}

function calcAmount(){
  const each = Number(elEach.value||0);
  const fees = Number(elFees.value||0);
  const mult = Number(elMult.value||1);
  const amt = (each + fees) * mult;
  elAmountBox.textContent = fmtGBP(amt);
}

function setHumanDate(){
  if(!elDate.value){ elDateHuman.textContent=""; return; }
  const d = new Date(elDate.value + "T00:00:00");
  const opt = {weekday:"short", day:"2-digit", month:"short", year:"2-digit"};
  elDateHuman.textContent = d.toLocaleDateString(undefined, opt);
}

function log(line){
  const ts = new Date().toISOString();
  elTrace.textContent += "\n[" + ts + "] " + line;
  elTrace.scrollTop = elTrace.scrollHeight;
}

/* ======================
   Render staging table
====================== */
function renderStaging(){
  stagingBody.innerHTML = "";
  staging.forEach((r, idx)=>{
    const tr=document.createElement("tr");

    const noteIcon = ((r.note || '').toString().trim().length > 0) ? ICON_NOTE : ICON_NOTE_EMPTY;

    tr.innerHTML = `
      <td>${r.group}</td>
      <td class="center"><span class="note-cell" data-idx="${idx}" title="Edit note">${noteIcon}</span></td>
      <td>${r.freq}</td>
      <td>${r.status}</td>
      <td>${r.curr}</td>
    `;
    stagingBody.appendChild(tr);
  });

  stagingBody.querySelectorAll(".note-cell").forEach(el=>{
    el.addEventListener("click", (e)=>{
      const i = Number(e.currentTarget.getAttribute("data-idx"));
      openNoteModal(i);
    });
  });
}

/* ======================
   Note modal
====================== */
function openNoteModal(i){
  activeNoteIndex = i;
  const r = staging[i];
  noteRowHint.textContent = `Row ${i+1} • Grouping: ${r.group} • Frequency: ${r.freq}`;
  noteModalText.value = r.note || "";
  noteModal.classList.remove("hidden");
  noteModalText.focus();
}

function closeNoteModal(){
  activeNoteIndex = -1;
  noteModal.classList.add("hidden");
}

noteCloseX.addEventListener("click", closeNoteModal);
noteCancel.addEventListener("click", closeNoteModal);
noteModal.addEventListener("click",(e)=>{
  if(e.target === noteModal) closeNoteModal();
});

noteSave.addEventListener("click", ()=>{
  if(activeNoteIndex < 0) return;
  staging[activeNoteIndex].note = noteModalText.value || "";
  renderStaging();
  log(`Saved note for staging row ${activeNoteIndex+1}.`);
  closeNoteModal();
});

noteDelete.addEventListener("click", ()=>{
  if(activeNoteIndex < 0) return;
  staging[activeNoteIndex].note = "";
  renderStaging();
  log(`Deleted note for staging row ${activeNoteIndex+1}.`);
  closeNoteModal();
});

/* ======================
   Init
====================== */
addOpts(elType, TYPE_OPTS, true);
addOpts(elGroup, GROUP_OPTS, false);
addOpts(elCat, CAT_OPTS, false);
addOpts(elFlow, FLOW_OPTS, false);
addOpts(elFrom, FROM_OPTS, false);
addOpts(elTo, TO_OPTS, false);
addOpts(elFreq, FREQ_OPTS, true);
addOpts(elStatus, STATUS_OPTS, true);
addOpts(elMonth, MONTH_OPTS, false);
addOpts(elCurr, CURR_OPTS, false);

elType.value = "V variable";
elGroup.value = "Roy";
elCat.value = "--Select--";
elFlow.value = "--";
elFrom.value = "--Select--";
elTo.value = "--Select--";
elFreq.value = "A Ad-hoc";
elStatus.value = "N Pending";
elMonth.value = "NEW";
elCurr.value = "GBP";

const today = new Date();
const yyyy = today.getFullYear();
const mm = String(today.getMonth()+1).padStart(2,"0");
const dd = String(today.getDate()).padStart(2,"0");
elDate.value = `${yyyy}-${mm}-${dd}`;
setHumanDate();
calcAmount();

elEach.addEventListener("input", calcAmount);
elFees.addEventListener("input", calcAmount);
elMult.addEventListener("input", calcAmount);
elDate.addEventListener("change", setHumanDate);

btnDelNote.addEventListener("click", ()=>{
  elNote.value = "";
  log("Cleared input Note field text.");
});

/* ======================
   Create staging record
====================== */
btnCreate.addEventListener("click", ()=>{
  const rec = {
    type: elType.value,
    group: elGroup.value,
    date: elDate.value,
    cat: elCat.value,
    flow: elFlow.value,
    sort: Number(elSort.value||0),
    from: elFrom.value,
    to: elTo.value,
    note: elNote.value || "",
    freq: elFreq.value,
    status: elStatus.value,
    month: elMonth.value,
    each: Number(elEach.value||0),
    fees: Number(elFees.value||0),
    mult: Number(elMult.value||1),
    curr: elCurr.value,
    chk: !!elChk.checked
  };

  staging.push(rec);
  renderStaging();
  log(`Created staging record (#${staging.length}). Note length=${(rec.note||"").length}.`);
  elSync.textContent = "Idle";
});

/* ======================
   Send staging to sheets (placeholder)
====================== */
btnSend.addEventListener("click", ()=>{
  if(staging.length === 0){
    log("Send requested but staging is empty.");
    return;
  }
  elSync.textContent = "Sending...";
  log(`Send requested for ${staging.length} staging record(s).`);
  setTimeout(()=>{
    elSync.textContent = "Idle";
    log("Send completed (stub).");
  }, 500);
});

/* ======================
   Clear staging
====================== */
btnClear.addEventListener("click", ()=>{
  staging = [];
  renderStaging();
  elSync.textContent = "Idle";
  log("Cleared all staging records.");
});

/* ======================
   Trace toggle
====================== */
btnTrace.addEventListener("click", ()=>{
  const isHidden = elTrace.classList.contains("hidden");
  if(isHidden){
    elTrace.classList.remove("hidden");
    log("Trace log shown.");
  }else{
    elTrace.classList.add("hidden");
  }
});

/* Seed some staging rows resembling screenshot */
staging.push({group:"Galore", note:"Weekly groceries", freq:"W Weekly", status:"N Pending", curr:"GBP"});
staging.push({group:"Galore", note:"", freq:"A Ad-hoc", status:"N Pending", curr:"GBP"});
staging.push({group:"Galore", note:"", freq:"A Ad-hoc", status:"N Pending", curr:"GBP"});
staging.push({group:"Galore", note:"Insurance renewal note", freq:"2Yr 2 yearly", status:"F Fixed", curr:"GBP"});
renderStaging();
log("Loaded seeded staging records for UI preview.");
</script>
</body>
</html>
