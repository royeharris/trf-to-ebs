<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>EBS Entry v3-11</title>

  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js" async defer></script>

  <style>
    :root {
      --primary: #2c3e50;
      --accent: #27ae60;
      --danger: #c0392b;
      --bg: #f8f9fa;
      --bridge: #2980b9;
      --cache: #8e44ad;
      --test: #e67e22;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg);
      margin: 0;
      padding: 10px;
    }

    .container {
      max-width: 960px;
      margin: auto;
      background: white;
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .branding-row {
      margin-bottom: 10px;
      font-size: 1.1rem;
      line-height: 1.1;
      color: var(--primary);
    }
    .branding-row b { font-weight: bold; }
    .branding-row span {
      font-weight: 400;
      font-size: 0.75rem;
      color: #7f8c8d;
      margin-left: 5px;
    }

    .header-wrap { display: flex; flex-direction: column; margin-bottom: 15px; gap: 8px; }
    .header-btns { display: flex; justify-content: space-between; gap: 4px; width: 100%; }
    .btn-lookup {
      padding: 2px;
      font-size: 0.72rem;
      border-radius: 6px;
      border: none;
      color: white;
      cursor: pointer;
      font-weight: 600;
      flex: 1;
      height: 50px;
      line-height: 1.1;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 0;
    }
    .btn-pull { background: var(--cache); }
    .btn-refresh { background: var(--bridge); }
    .btn-save { background: var(--accent); }
    .btn-test { background: var(--test); }
    .btn-reset { background: var(--danger); }

    label {
      font-size: 0.7rem;
      font-weight: 700;
      display: block;
      margin-bottom: 2px;
      color: var(--primary);
    }

    input, select, textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #dcdde1;
      border-radius: 6px;
      font-size: 16px;
      box-sizing: border-box;
      height: 38px;
      -webkit-text-size-adjust: 100%;
      font-family: inherit;
    }

    .date-input-container {
      display: flex;
      align-items: center;
      gap: 5px;
      background: white;
      border: 1px solid #dcdde1;
      border-radius: 6px;
      padding: 0 8px;
      height: 38px;
    }
    .date-input-container input[type="date"] {
      border: none;
      padding: 0;
      height: 100%;
      font-size: 14px;
      flex-grow: 1;
      outline: none;
      background: transparent;
    }

    .flow-display {
      font-size: 0.85rem;
      font-weight: bold;
      color: var(--primary);
      text-align: center;
      height: 38px;
      line-height: 36px;
      border: 1px solid #dcdde1;
      border-radius: 6px;
      background: #f1f2f6;
      box-sizing: border-box;
    }

    .total-box {
      background: #e8f5e9;
      border: 2px dashed var(--accent);
      padding: 10px;
      border-radius: 8px;
      text-align: center;
      margin: 15px 0;
    }
    .total-val { font-size: 1.3rem; font-weight: bold; color: var(--accent); }

    .actions { display: grid; grid-template-columns: 1fr 1fr 1.2fr; gap: 8px; }
    button.action-main {
      padding: 10px;
      border: none;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      color: white;
      font-size: 0.72rem;
      -webkit-font-smoothing: antialiased;
    }

    .preview-wrap {
      width: 100%;
      overflow-x: auto;
      margin-top: 15px;
      border: 1px solid #ddd;
      border-radius: 6px;
    }

    /* v3-11: Staging preview widths tuned to longest observed options (e.g., 'Computer Futures extra', 'Computer consumables') */
    table { width: 175ch; border-collapse: collapse; font-size: 0.58rem; table-layout: fixed; font-family: inherit; }
    th, td { border: 1px solid #eee; padding: 6px 3px; text-align: left; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    th { background: #f2f2f2; font-weight: bold !important; color: var(--primary); font-size: 0.58rem !important; }

    .w-edit { width: 5ch; text-align: center; }
    .w-grouping { width: 10ch; }
    .w-type { width: 12ch; }
    .w-day { width: 4ch; text-align: center; }
    .w-date { width: 10ch; }
    .w-flow { width: 6ch; text-align: center; }
    .w-category { width: 22ch; }
    .w-sort { width: 5ch; text-align: center; }
    .w-from { width: 24ch; }
    .w-to { width: 24ch; }
    .w-note { width: 6ch; text-align: center; cursor: pointer; font-size: 1rem; }
    .w-freq { width: 14ch; }
    .w-month { width: 6ch; text-align: center; }
    .w-tot { width: 10ch; text-align: right; }
    .w-who { width: 10ch; text-align: center; }
    .w-del { width: 5ch; text-align: center; }

    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
    .modal-content { background: white; margin: 15% auto; padding: 20px; width: 80%; max-width: 420px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); }

    #auth_status { font-size: 0.75rem; margin-top: 10px; text-align: center; color: var(--primary); font-weight: 600; }
    #log_btn { margin-top: 15px; width: 100%; background: var(--primary); color: white; font-size: 0.7rem; border-radius: 6px; padding: 8px; border: none; font-weight: 600; display: block; }
    #trace_log { display: none; margin-top: 15px; padding: 10px; background: #2c3e50; color: #00ff00; font-family: "Courier New", monospace; font-size: 0.6rem; border-radius: 6px; max-height: 150px; overflow-y: auto; white-space: pre-wrap; cursor: pointer; }

    .calc-input-wrap { display: flex; align-items: center; gap: 4px; }
    .btn-calc-trigger { background: var(--bridge); color: white; border: none; border-radius: 4px; height: 38px; width: 30px; cursor: pointer; font-weight: bold; }
    .txt-center { text-align: center; }

    /* Calculator modal */
    .calc-screen {
      width: 100%;
      height: 46px;
      font-size: 18px;
      padding: 10px;
      border: 1px solid #dcdde1;
      border-radius: 8px;
      box-sizing: border-box;
      font-family: "Courier New", monospace;
    }
    .calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 12px; }
    .calc-btn {
      height: 44px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 700;
      font-size: 16px;
      background: #eef2f7;
      color: var(--primary);
    }
    .calc-btn.op { background: #dde7f5; }
    .calc-btn.danger { background: #f7d9d7; }
    .calc-actions { display:flex; gap:10px; margin-top:12px; }
    .calc-actions button { flex: 1; padding: 10px; border-radius: 10px; border: none; font-weight: 800; cursor: pointer; }
    .calc-actions .btn-eq { background: var(--bridge); color: white; }
    .calc-actions .btn-apply { background: var(--accent); color: white; }
    .calc-actions .btn-close { background: #7f8c8d; color: white; }
  </style>
</head>

<body>
  <div class="container">
    <div class="header-wrap">
      <div class="branding-row"><b>EBS Input</b> <span>v3-11</span></div>
      <div class="header-btns">
        <button class="btn-lookup btn-pull" onclick="checkEditState(() => cachePull())">Pull local<br>Lookups</button>
        <button class="btn-lookup btn-refresh" id="refresh_btn" onclick="checkEditState(() => initRefresh())">Refresh<br>Lookups<br>from Sheets</button>
        <button class="btn-lookup btn-save" onclick="checkEditState(() => cacheSave())">Save to<br>local Lookups</button>
        <button class="btn-lookup btn-test" onclick="checkEditState(() => useTestData())">Pull test<br>Lookups</button>
        <button class="btn-lookup btn-reset" id="resetBtn" onclick="handleResetConfirm()">Reset</button>
      </div>
    </div>

    <div style="display:grid; grid-template-columns: 0.8fr 1fr 1.2fr; gap:10px;">
      <div><label>Type</label><select id="colB" onchange="handleManualFU()"></select></div>
      <div><label>Grouping</label><select id="colA"></select></div>
      <div>
        <label>Date</label>
        <div class="date-input-container" onclick="document.getElementById('colC').showPicker()">
          <span>üìÖ</span><input type="date" id="colC" onchange="handleDateChange()">
        </div>
        <div id="colCDisp" style="font-size:0.65rem; color:#7f8c8d; text-align:center; margin-top:2px;"></div>
      </div>
    </div>

    <div style="display:grid; grid-template-columns: 1fr 0.4fr 0.3fr; gap:10px; margin-top:10px;">
      <div><label>Category</label><select id="colF" required onchange="handleCatTrigger()"></select></div>
      <div><label style="text-align:center;">Flow</label><div id="flowDisplay" class="flow-display">--</div></div>
      <div><label>Sort</label><input type="number" id="colG" placeholder="0" onfocus="this.value=''"></div>
    </div>

    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
      <div><label>From</label><select id="colH" required onchange="handleAccTrigger()"></select></div>
      <div><label>To</label><select id="colI" required onchange="handleAccTrigger()"></select></div>
    </div>

    <div style="margin-top:10px;"><label>Note</label><textarea id="colK" rows="2" style="font-size:16px;"></textarea></div>

    <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-top:10px;">
      <div><label>Frequency</label><select id="colFreq"></select></div>
      <div><label>Status</label><select id="colStatus"></select></div>
      <div><label>Month</label><select id="colZ"></select></div>
    </div>

    <div style="display:grid; grid-template-columns:1.2fr 1fr 1fr 1fr; gap:8px; margin-top:10px;">
      <div>
        <label>Each</label>
        <div class="calc-input-wrap">
          <input type="number" id="colT" placeholder="0.00" step="0.01" onfocus="this.value=''" oninput="calc()">
          <button class="btn-calc-trigger" onclick="openCalculatorHook()">¬±</button>
        </div>
      </div>
      <div><label>Currency</label><select id="colX" onchange="calc()"></select></div>
      <div><label>Fees</label><input type="number" id="colV" placeholder="0.00" step="0.01" onfocus="this.value=''" oninput="calc()"></div>
      <div><label>Multiplier</label><input type="number" id="colM" value="1" step="0.01" oninput="calc()"></div>
    </div>

    <div class="total-box">
      <div class="total-val"><span id="symbol">¬£</span> <span id="totalDisp">0.00</span></div>
    </div>

    <div class="actions">
      <button class="action-main" onclick="handleMainAction()" style="background:var(--accent);">Create Staging record</button>
      <button class="action-main" id="sync_btn" onclick="checkEditState(() => handleSync())" style="background:var(--bridge);">Send Staging records to Sheets</button>
      <button class="action-main" id="wipeBtn" onclick="handleWipeConfirm()" style="background:var(--danger); opacity:0.85;">Clear Staging records</button>
    </div>

    <div class="preview-wrap" id="previewArea"></div>

    <div id="auth_status">iOS Sync Status: Idle</div>
    <button id="log_btn" onclick="toggleLog(true)">Display Trace Log</button>
    <div id="trace_log" onclick="toggleLog(false)">Trace: v3-11 Logic Circuit Breaker active.</div>
  </div>

  <!-- Flow selection modal -->
  <div id="flow_modal" class="modal">
    <div class="modal-content">
      <label style="font-size:1rem; margin-bottom:15px;">Flow cannot be determined - select manually</label>
      <select id="modal_flow_select" style="margin-bottom:20px;">
        <option value="xfer">xfer</option>
        <option value="In">In</option>
        <option value="zOut">zOut</option>
      </select>
      <div style="display:flex; gap:10px;">
        <button onclick="commitFlowSelection()" style="flex:1; background:var(--accent); color:white; padding:10px; border-radius:6px; border:none; font-weight:bold;">OK</button>
        <button onclick="closeFlowModal()" style="flex:1; background:#7f8c8d; color:white; padding:10px; border-radius:6px; border:none; font-weight:bold;">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Note modal -->
  <div id="note_modal" class="modal">
    <div class="modal-content">
      <label>Edit Transaction Note</label>
      <textarea id="modal_note_text" rows="4" style="margin-top:10px;"></textarea>
      <div style="display:flex; gap:10px; margin-top:15px;">
        <button onclick="commitNote()" style="flex:1; background:var(--accent); color:white; padding:10px; border-radius:6px; border:none; font-weight:bold;">Save Note</button>
        <button onclick="closeNote()" style="flex:1; background:#7f8c8d; color:white; padding:10px; border-radius:6px; border:none; font-weight:bold;">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Calculator modal -->
  <div id="calc_modal" class="modal">
    <div class="modal-content">
      <label style="font-size:1rem;">Calculator</label>
      <input id="calc_screen" class="calc-screen" inputmode="decimal" />
      <div class="calc-grid">
        <button class="calc-btn" onclick="calcKey('7')">7</button>
        <button class="calc-btn" onclick="calcKey('8')">8</button>
        <button class="calc-btn" onclick="calcKey('9')">9</button>
        <button class="calc-btn op" onclick="calcKey('/')">√∑</button>

        <button class="calc-btn" onclick="calcKey('4')">4</button>
        <button class="calc-btn" onclick="calcKey('5')">5</button>
        <button class="calc-btn" onclick="calcKey('6')">6</button>
        <button class="calc-btn op" onclick="calcKey('*')">√ó</button>

        <button class="calc-btn" onclick="calcKey('1')">1</button>
        <button class="calc-btn" onclick="calcKey('2')">2</button>
        <button class="calc-btn" onclick="calcKey('3')">3</button>
        <button class="calc-btn op" onclick="calcKey('-')">‚àí</button>

        <button class="calc-btn" onclick="calcKey('0')">0</button>
        <button class="calc-btn" onclick="calcKey('.')">.</button>
        <button class="calc-btn danger" onclick="calcBack()">‚å´</button>
        <button class="calc-btn op" onclick="calcKey('+')">+</button>

        <button class="calc-btn danger" onclick="calcClear()" style="grid-column: span 4;">Clear</button>
      </div>

      <div class="calc-actions">
        <button class="btn-eq" onclick="calcEvaluate(false)">=</button>
        <button class="btn-apply" onclick="calcEvaluate(true)">Apply</button>
        <button class="btn-close" onclick="closeCalculator()">Close</button>
      </div>
    </div>
  </div>

<script>
  const SHEET_ID = "1DdjG4B8wB9llk7yOoRRO72G0XqHEgFkMIlLuusShA6E";
  const VER = "Excel Budget Sheet Input (v3-11)";
  let AA_LIST = [];
  let coordinateMap = {};
  let symbols = { "GBP": "¬£", "EUR": "‚Ç¨", "USD": "$", "ZAR": "R", "CHF": "Fr", "THB": "‡∏ø", "RUR": "‚ÇΩ", "COP": "COL$" };

  let tokenClient;
  let editIndex = -1;
  let pendingEdit = -1;
  let activeNoteIdx = -1;
  let rawLookupData = [];
  let wipeConfirmed = false;
  let resetConfirmed = false;
  let isRestoring = false;

  function logTrace(msg) {
    console.log(msg);
    const log = document.getElementById("trace_log");
    const now = new Date().toLocaleTimeString();
    log.innerText += `\n[${now}] ${msg}`;
    log.scrollTop = log.scrollHeight;
  }

  function toggleLog(show) {
    document.getElementById("log_btn").style.display = show ? "none" : "block";
    document.getElementById("trace_log").style.display = show ? "block" : "none";
  }

  function gapiLoaded() {
    gapi.load("client", async () => {
      await gapi.client.init({ apiKey: "AIzaSyDvZ1XZw5bZgWSB9zaU7h9Vtn7MhDGFMSM" });
      await gapi.client.load("sheets", "v4");
      logTrace("GAPI Ready. (v3-11)");
    });
  }

  function gisLoaded() {
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: "23231735212-jtgur3sn2ndh798ke00pm2a1d5rkd4eu.apps.googleusercontent.com",
      scope: "https://www.googleapis.com/auth/spreadsheets",
      callback: (resp) => {
        if (resp.access_token) {
          localStorage.setItem("g_token", resp.access_token);
          fetchLookupRefs();
        }
      }
    });
    logTrace("GIS Ready. (v3-11)");
  }

  function updateStatus(label, state) {
    const el = document.getElementById("auth_status");
    el.innerText = `iOS Sync Status: ${label}`;
    const colors = { idle: "#7f8c8d", active: "#27ae60", sync: "#e67e22", error: "#c0392b" };
    el.style.color = colors[state] || colors.idle;
  }

  function checkEditState(onSuccess) {
    if (pendingEdit !== -1 || editIndex !== -1) {
      alert("Function locked during Edit.");
      return;
    }
    onSuccess();
  }

  function useTestData() {
    if (!confirm("Load test set?")) return;
    AA_LIST = ["Santander P (AA)", "Revolut P (AA)"];
    coordinateMap = {"Grouping":{val:0},"F/U":{val:1},"Category":{val:2},"From":{val:3},"To":{val:4},"Frequency":{val:5},"Status":{val:6},"Month":{val:7},"Currency":{val:8}};
    rawLookupData = [["INIT"]];
    updateDropdown("colA", ["Roy", "Peter"], "Roy");
    updateDropdown("colB", ["v Verified", "xf Transfer", "S Support"], "v");
    updateDropdown("colF", ["Food", "Transfer", "Support Samara", "Support Misc"], null, "--Select--");
    updateDropdown("colH", AA_LIST, null, "--Select--");
    updateDropdown("colI", AA_LIST, null, "--Select--");
    updateDropdown("colFreq", ["A Ad-hoc", "K Keep in credit"], "A");
    updateDropdown("colStatus", ["N Pending", "aj adjustment"], "N");
    updateDropdown("colZ", ["NEW", "JAN", "FEB"], "NEW");
    updateDropdown("colX", ["GBP", "EUR", "USD"], "GBP");
    localReset();
  }

  function cacheSave() {
    if (rawLookupData.length === 0) { alert("Refresh Lookups First"); return; }
    if (!confirm("Snapshot values?")) return;
    localStorage.setItem("ebs_cache_data", JSON.stringify(rawLookupData));
    localStorage.setItem("ebs_cache_coords", JSON.stringify(coordinateMap));
    localStorage.setItem("ebs_cache_aa", JSON.stringify(AA_LIST));
    logTrace("Lookup cache saved. (v3-11)");
  }

  function cachePull() {
    if (!confirm("Load local Lookups?")) return;
    const cached = localStorage.getItem("ebs_cache_data");
    if (cached) {
      rawLookupData = JSON.parse(cached);
      coordinateMap = JSON.parse(localStorage.getItem("ebs_cache_coords"));
      AA_LIST = JSON.parse(localStorage.getItem("ebs_cache_aa"));
      populateUI(rawLookupData);
      logTrace("Lookup cache pulled. (v3-11)");
    } else {
      alert("No local Lookups cache found.");
    }
  }

  function initRefresh() { tokenClient.requestAccessToken(); }

  async function fetchLookupRefs() {
    updateStatus("Fetching Refs...", "sync");
    const res = await gapi.client.sheets.spreadsheets.values.get({
      spreadsheetId: SHEET_ID,
      range: "LookupRefs!A2:C15"
    });
    res.result.values.forEach(r => {
      coordinateMap[r[0]] = {
        val: colToIndex(r[1].toUpperCase().replace(/[0-9]/g, "")),
        desc: (r[2] && r[2].toLowerCase() !== "n/a") ? colToIndex(r[2]) : null
      };
    });
    fetchActiveAccounts();
  }

  function colToIndex(col) {
    let idx = 0;
    for (let i = 0; i < col.length; i++) idx = idx * 26 + (col.charCodeAt(i) - 64);
    return idx - 1;
  }

  async function fetchActiveAccounts() {
    const res = await gapi.client.sheets.spreadsheets.values.get({
      spreadsheetId: SHEET_ID,
      range: "ActiveAccounts!A2:A500"
    });
    AA_LIST = res.result.values ? res.result.values.flat().filter(v => v) : [];
    fetchActualData();
  }

  async function fetchActualData() {
    const res = await gapi.client.sheets.spreadsheets.values.get({
      spreadsheetId: SHEET_ID,
      range: "Lookups!A2:AC1000"
    });
    rawLookupData = res.result.values || [];
    populateUI(rawLookupData);
    updateStatus("Token Active", "active");
    alert("Refresh complete.");
  }

  function populateUI(data) {
    const pop = (id, key, def, p = null) => {
      const list = data
        .filter(r => r[coordinateMap[key].val])
        .map(r => {
          const v = r[coordinateMap[key].val];
          const d = coordinateMap[key].desc !== null ? r[coordinateMap[key].desc] : null;
          return d ? `${v} ${d}` : v;
        });
      updateDropdown(id, list, def, p);
    };
    pop("colA", "Grouping", "Roy");
    pop("colB", "F/U", "v");
    pop("colF", "Category", null, "--Select--");
    pop("colH", "From", null, "--Select--");
    pop("colI", "To", null, "--Select--");
    pop("colFreq", "Frequency", "A");
    pop("colStatus", "Status", "N");
    pop("colZ", "Month", "NEW");
    pop("colX", "Currency", "GBP");
    localReset();
  }

  function updateDropdown(id, vals, def, prompt) {
    const s = document.getElementById(id);
    let h = prompt ? `<option value="" disabled selected>${prompt}</option>` : "";
    h += vals.map(v => `<option value="${v}">${v}</option>`).join("");
    s.innerHTML = h;
    if (def) {
      const o = Array.from(s.options).find(opt => opt.value.startsWith(def));
      if (o) s.value = o.value;
    }
  }

  function localReset() {
    editIndex = -1;
    pendingEdit = -1;
    logTrace("UI Reset Invoked. (v3-11)");

    ["colT","colV","colG","colK"].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.value = "";
    });

    document.getElementById("colM").value = "1";
    document.getElementById("flowDisplay").innerText = "--";

    const rS = (id, def) => {
      const s = document.getElementById(id);
      if (!s) return;
      if (def) {
        const o = Array.from(s.options).find(opt => opt.value.startsWith(def));
        if (o) s.value = o.value;
      } else {
        s.selectedIndex = 0;
      }
    };

    rS("colA", "Roy");
    rS("colB", "v");
    rS("colF", null);
    rS("colH", null);
    rS("colI", null);
    rS("colFreq", "A");
    rS("colStatus", "N");
    rS("colZ", "NEW");
    rS("colX", "GBP");

    calc();
    renderPreview();
    logTrace("UI Fields Reset. (v3-11)");
  }

  function handleResetConfirm() {
    const btn = document.getElementById("resetBtn");
    if (!resetConfirmed) {
      resetConfirmed = true;
      btn.innerText = "CONFIRM?";
      setTimeout(() => {
        resetConfirmed = false;
        btn.innerText = "Reset";
      }, 3000);
    } else {
      localReset();
      resetConfirmed = false;
      btn.innerText = "Reset";
    }
  }

  function handleWipeConfirm() {
    const btn = document.getElementById("wipeBtn");
    if (!wipeConfirmed) {
      wipeConfirmed = true;
      btn.innerText = "CONFIRM?";
      setTimeout(() => {
        wipeConfirmed = false;
        btn.innerText = "Clear Staging records";
      }, 3000);
    } else {
      localStorage.removeItem("ebs_trf");
      wipeConfirmed = false;
      btn.innerText = "Clear Staging records";
      renderPreview();
      logTrace("Staging wiped. (v3-11)");
    }
  }

  function handleAccTrigger() {
    if (isRestoring) return;

    const h = document.getElementById("colH").value;
    const i = document.getElementById("colI").value;
    const ty = document.getElementById("colB");

    const fAA = AA_LIST.includes(h);
    const tAA = AA_LIST.includes(i);

    let valE = "zOut";
    if (fAA && tAA) valE = "xfer";
    else if (!fAA && tAA) valE = "In";

    document.getElementById("flowDisplay").innerText = valE;

    if (valE === "xfer") {
      const xf = Array.from(ty.options).find(o => o.value.toLowerCase().startsWith("xf"));
      if (xf) ty.value = xf.value;
      document.getElementById("colF").value = "Transfer";
    }
  }

  function handleCatTrigger() {
    if (isRestoring) return;

    const catVal = document.getElementById("colF").value || "";
    const fu = document.getElementById("colB");
    const freq = document.getElementById("colFreq");

    if (catVal.toLowerCase().includes("support")) {
      const s = Array.from(fu.options).find(o => o.value.startsWith("S"));
      if (s) fu.value = s.value;

      // v3-07: Support category forces Frequency to Ad-hoc
      const a = Array.from(freq.options).find(o => o.value.startsWith("A"));
      if (a) freq.value = a.value;
    }
  }

  function handleManualFU() {
    if (document.getElementById("colB").value.toLowerCase().startsWith("xf")) {
      document.getElementById("colF").value = "Transfer";
    }
  }

  function handleDateChange() {
    const dStr = document.getElementById("colC").value;
    if (!dStr) {
      document.getElementById("colCDisp").innerText = "";
      return;
    }
    const [y, m, d] = dStr.split("-").map(Number);
    const dt = new Date(y, m - 1, d);
    document.getElementById("colCDisp").innerText =
      `${["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][dt.getDay()]} ${dt.getDate()} ${["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][dt.getMonth()]} '${String(dt.getFullYear()).substr(-2)}`;
  }

  function calc() {
    const t = parseFloat(document.getElementById("colT").value) || 0;
    const u = parseFloat(document.getElementById("colM").value) || 1;
    const v = parseFloat(document.getElementById("colV").value) || 0;
    const tot = ((t * u) + v).toFixed(2);
    const curCode = (document.getElementById("colX").value.split(" ")[0] || "GBP");
    document.getElementById("symbol").innerText = symbols[curCode] || "¬£";
    document.getElementById("totalDisp").innerText = tot;
    return tot;
  }

  function handleMainAction() {
    logTrace("Action Triggered. (v3-11)");

    if (rawLookupData.length === 0) {
      alert("Edit is only possible after Lookups are pulled or refreshed");
      return;
    }

    const lockIdx = editIndex;

    const fv = document.getElementById("colF").value;
    const hv = document.getElementById("colH").value;
    const iv = document.getElementById("colI").value;

    if (!fv || !hv || !iv || fv.includes("--") || hv.includes("--") || iv.includes("--")) {
      alert("Missing data.");
      return;
    }

    const flowV = document.getElementById("flowDisplay").innerText;
    if (flowV === "--") { openFlowModal(); return; }

    // Who should only be set for Support categories
    let wV = "";
    if ((fv || "").toLowerCase().includes("support")) wV = document.getElementById("colA").value;

    const finalPackage = [
      document.getElementById("colA").value,
      document.getElementById("colB").value,
      document.getElementById("colC").value,
      "",
      flowV,
      document.getElementById("colF").value,
      document.getElementById("colG").value,
      document.getElementById("colH").value,
      document.getElementById("colI").value,
      "",
      document.getElementById("colK").value,
      document.getElementById("colFreq").value,
      "",
      "",
      document.getElementById("colStatus").value,
      "",
      "",
      "",
      "",
      parseFloat(document.getElementById("colT").value || 0).toFixed(2),
      document.getElementById("colM").value,
      parseFloat(document.getElementById("colV").value || 0).toFixed(2),
      calc(),
      document.getElementById("colX").value,
      "",
      document.getElementById("colZ").value,
      "",
      "",
      "",
      "",
      "",
      "",
      "",
      wV,
      VER
    ];

    let masterList = JSON.parse(localStorage.getItem("ebs_trf") || "[]");
    if (lockIdx > -1) {
      masterList[lockIdx] = finalPackage;
      logTrace(`Logic Update: Row ${lockIdx} Overwritten. (v3-11)`);
    } else {
      masterList.push(finalPackage);
      logTrace("Logic Update: New Record Appended. (v3-11)");
    }

    localStorage.setItem("ebs_trf", JSON.stringify(masterList));
    logTrace("Storage Synced. (v3-11)");

    localReset();
  }

  function initiateEdit(idx) {
    if (rawLookupData.length === 0) { alert("First Refresh Lookups or Pull local Lookups."); return; }

    if (pendingEdit === idx) {
      isRestoring = true;
      editIndex = idx;
      pendingEdit = -1;

      const d = JSON.parse(localStorage.getItem("ebs_trf") || "[]")[idx];

      const setUI = (id, val, isDrop = false) => {
        const el = document.getElementById(id);
        if (!el) return;
        if (!isDrop) { el.value = val; return; }
        const opts = el.options;
        for (let i = 0; i < opts.length; i++) {
          if (opts[i].value === val || opts[i].text === val || opts[i].value === val + " (AA)") { el.selectedIndex = i; break; }
        }
      };

      setUI("colA", d[0], true);
      setUI("colB", d[1], true);
      setUI("colC", d[2]);
      setUI("colF", d[5], true);
      setUI("colG", d[6]);
      setUI("colH", d[7], true);
      setUI("colI", d[8], true);
      setUI("colK", d[10]);
      setUI("colT", d[19]);
      setUI("colV", d[21]);
      setUI("colM", d[20]);
      setUI("colZ", d[25], true);
      setUI("colFreq", d[11], true);
      setUI("colStatus", d[14], true);

      document.getElementById("flowDisplay").innerText = d[4] || "--";

      isRestoring = false;
      handleDateChange();
      calc();
      renderPreview();
      logTrace(`Active Edit: row ${idx + 1} (v3-11)`);
    } else {
      pendingEdit = idx;
      editIndex = -1;
      renderPreview();
    }
  }

  function openFlowModal() { document.getElementById("flow_modal").style.display = "block"; }
  function closeFlowModal() { document.getElementById("flow_modal").style.display = "none"; }
  function commitFlowSelection() {
    const selected = document.getElementById("modal_flow_select").value;
    document.getElementById("flowDisplay").innerText = selected;
    closeFlowModal();
    handleMainAction();
  }

  function renderPreview() {
    const storageData = JSON.parse(localStorage.getItem("ebs_trf") || "[]");

    let h = '<table><tr>'
      + '<th class="w-edit">Edit</th>'
      + '<th class="w-grouping">Grouping</th>'
      + '<th class="w-type">Type</th>'
      + '<th class="w-day">Day</th>'
      + '<th class="w-date">Date</th>'
      + '<th class="w-flow">Flow</th>'
      + '<th class="w-category">Category</th>'
      + '<th class="w-sort">Sort</th>'
      + '<th class="w-from">From</th>'
      + '<th class="w-to">To</th>'
      + '<th class="w-note">Note</th>'
      + '<th class="w-freq">Frequency</th>'
      + '<th class="w-month">Month</th>'
      + '<th class="w-tot">Total</th>'
      + '<th class="w-who">Who</th>'
      + '<th class="w-del">DEL</th>'
      + '</tr>';

    storageData.forEach((r, idx) => {
      let bS = (pendingEdit === idx) ? "background:red" : (editIndex === idx ? "background:#f39c12" : "background:#3498db");
      let bL = (pendingEdit === idx) ? "..." : (editIndex === idx ? "C" : "E");

      const [y, m, dn] = (r[2] || "2000-01-01").split("-").map(Number);
      const dt = new Date(y, (m || 1) - 1, dn || 1);
      const dNam = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][dt.getDay()];
      const dStr = `${String(dn || 1).padStart(2,"0")} ${["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][dt.getMonth()]} '${String(dt.getFullYear()).substr(-2)}`;

      h += `<tr>
        <td class="w-edit"><button onclick="initiateEdit(${idx})" style="${bS};color:white;border:none;border-radius:4px;padding:2px;width:100%;font-size:0.55rem;">${bL}</button></td>
        <td class="w-grouping">${r[0] || ""}</td>
        <td class="w-type">${r[1] || ""}</td>
        <td class="w-day txt-center">${dNam}</td>
        <td class="w-date">${dStr}</td>
        <td class="w-flow txt-center">${r[4] || ""}</td>
        <td class="w-category">${r[5] || ""}</td>
        <td class="w-sort txt-center">${r[6] || ""}</td>
        <td class="w-from">${r[7] || ""}</td>
        <td class="w-to">${r[8] || ""}</td>
        <td class="w-note" onclick="openNote(${idx})">${(r[10] && String(r[10]).trim().length) ? "üìÑ" : "‚ñ´Ô∏è"}</td>
        <td class="w-freq">${r[11] || ""}</td>
        <td class="w-month">${r[25] || ""}</td>
        <td class="w-tot">${r[22] || ""}</td>
        <td class="w-who txt-center">${r[33] || ""}</td>
        <td class="w-del"><button onclick="deleteRow(${idx})" style="background:red;color:white;border:none;border-radius:4px;padding:0 5px;">X</button></td>
      </tr>`;
    });

    document.getElementById("previewArea").innerHTML = h + "</table>";
    logTrace("Table Rendered. Active Rows: " + storageData.length + " (v3-11)");
  }

  function deleteRow(i) {
    let d = JSON.parse(localStorage.getItem("ebs_trf") || "[]");
    d.splice(i, 1);
    localStorage.setItem("ebs_trf", JSON.stringify(d));
    editIndex = -1;
    pendingEdit = -1;
    renderPreview();
  }

  function openNote(idx) {
    activeNoteIdx = idx;
    const d = JSON.parse(localStorage.getItem("ebs_trf") || "[]");
    if (d[idx]) {
      document.getElementById("modal_note_text").value = d[idx][10] || "";
      document.getElementById("note_modal").style.display = "block";
    }
  }

  function closeNote() { document.getElementById("note_modal").style.display = "none"; }
  function commitNote() {
    let d = JSON.parse(localStorage.getItem("ebs_trf") || "[]");
    d[activeNoteIdx][10] = document.getElementById("modal_note_text").value;
    localStorage.setItem("ebs_trf", JSON.stringify(d));
    closeNote();
    renderPreview();
  }

  // ---- Calculator ----
  let calcActive = false;

  function openCalculatorHook() {
    const screen = document.getElementById("calc_screen");
    const current = document.getElementById("colT").value;
    screen.value = (current && String(current).trim().length) ? String(current) : "";
    document.getElementById("calc_modal").style.display = "block";
    calcActive = true;
    logTrace("Calculator opened. (v3-11)");
  }

  function closeCalculator() {
    document.getElementById("calc_modal").style.display = "none";
    calcActive = false;
    logTrace("Calculator closed. (v3-11)");
  }

  function calcKey(k) {
    if (!calcActive) return;
    const screen = document.getElementById("calc_screen");
    if (k === "*" ) k = "*";
    if (k === "/" ) k = "/";
    screen.value += k;
  }

  function calcBack() {
    const screen = document.getElementById("calc_screen");
    screen.value = screen.value.slice(0, -1);
  }

  function calcClear() {
    document.getElementById("calc_screen").value = "";
  }

  function safeEval(expr) {
    // allow digits, spaces, + - * / . parentheses
    if (!/^[0-9+\-*/().\s]+$/.test(expr)) return null;
    try {
      // eslint-disable-next-line no-new-func
      const fn = new Function(`return (${expr});`);
      const val = fn();
      if (val === Infinity || val === -Infinity || Number.isNaN(val)) return null;
      return val;
    } catch {
      return null;
    }
  }

  function calcEvaluate(applyAndClose) {
    const screen = document.getElementById("calc_screen");
    const expr = (screen.value || "").trim();
    if (!expr) return;

    const val = safeEval(expr);
    if (val === null) {
      alert("Invalid calculation.");
      return;
    }

    const fixed = (Math.round(val * 100) / 100).toFixed(2);
    screen.value = fixed;

    if (applyAndClose) {
      document.getElementById("colT").value = fixed;
      calc();
      closeCalculator();
      logTrace("Calculator applied value to Each. (v3-11)");
    } else {
      logTrace("Calculator evaluated. (v3-11)");
    }
  }

  // ---- Sync (placeholder; unchanged here) ----
  async function handleSync() {
    updateStatus("Syncing...", "sync");
    setTimeout(() => updateStatus("Token Active", "active"), 1000);
    logTrace("Sync invoked. (v3-11)");
  }

  window.onload = () => {
    document.getElementById("colC").value = new Date().toISOString().split("T")[0];
    handleDateChange();
    gapiLoaded();
    gisLoaded();
    renderPreview();
  };
</script>
</body>
</html>
