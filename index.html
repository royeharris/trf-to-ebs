<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EBS Entry v2-75</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>
    <style>
        :root { --primary: #2c3e50; --accent: #27ae60; --danger: #c0392b; --bg: #f8f9fa; --bridge: #2980b9; --cache: #8e44ad; --test: #e67e22; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); margin: 0; padding: 10px; }
        .container { max-width: 960px; margin: auto; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .branding-row { margin-bottom: 10px; font-size: 1.1rem; line-height: 1.1; color: var(--primary); }
        .branding-row b { font-weight: bold; }
        .branding-row span { font-weight: 400; font-size: 0.75rem; color: #7f8c8d; margin-left: 5px; }
        .header-wrap { display: flex; flex-direction: column; margin-bottom: 15px; gap: 8px; }
        .header-btns { display: flex; justify-content: space-between; gap: 4px; width: 100%; }
        .btn-lookup { background: var(--bridge); padding: 2px; font-size: 0.72rem; border-radius: 6px; border: none; color: white; cursor: pointer; font-weight: 600; flex: 1; height: 50px; line-height: 1.1; text-align: center; overflow: hidden; -webkit-font-smoothing: antialiased; display: flex; align-items: center; justify-content: center; min-width: 0; }
        .btn-reset-ui { background: var(--danger); }
        label { font-size: 0.7rem; font-weight: 700; display: block; margin-bottom: 2px; color: var(--primary); }
        input, select, textarea { width: 100%; padding: 8px; border: 1px solid #dcdde1; border-radius: 6px; font-size: 16px; box-sizing: border-box; height: 38px; -webkit-text-size-adjust: 100%; font-family: inherit; }
        .flow-display { font-size: 0.85rem; font-weight: bold; color: var(--primary); text-align: center; height: 38px; line-height: 36px; border: 1px solid #dcdde1; border-radius: 6px; background: #f1f2f6; box-sizing: border-box; }
        .total-box { background: #e8f5e9; border: 2px dashed var(--accent); padding: 10px; border-radius: 8px; text-align: center; margin: 15px 0; }
        .total-val { font-size: 1.3rem; font-weight: bold; color: var(--accent); }
        .actions { display: grid; grid-template-columns: 1fr 1fr 1.2fr; gap: 8px; }
        button.action-main { padding: 10px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; color: white; font-size: 0.72rem; -webkit-font-smoothing: antialiased; }
        .preview-wrap { width: 100%; overflow-x: auto; margin-top: 15px; -webkit-overflow-scrolling: touch; border: 1px solid #ddd; border-radius: 6px; }
        table { width: 1100px; border-collapse: collapse; font-size: 0.58rem; table-layout: fixed; }
        th, td { border: 1px solid #eee; padding: 6px 3px; text-align: left; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        th { background: #f2f2f2; font-weight: bold !important; color: var(--primary); }
        .w-edit { width: 30px; text-align: center; } .w-grp { width: 40px; } .w-type { width: 60px; } .w-day { width: 30px; text-align: center; } .w-date { width: 70px; } .w-flow { width: 40px; text-align: center; } .w-cat, .w-acc { width: 110px; } .w-sort { width: 30px; } 
        .w-note { width: 40px; text-align: center; cursor: pointer; font-size: 1rem; } .w-cur { width: 35px; text-align: center; } .w-tot { width: 80px; text-align: right; }
        
        /* v2-75: Calculator specific styles */
        .calc-input-wrap { display: flex; align-items: center; gap: 4px; }
        .btn-calc-trigger { background: var(--bridge); color: white; border: none; border-radius: 4px; height: 38px; width: 30px; cursor: pointer; font-weight: bold; }
        #calc_modal { display: none; position: fixed; z-index: 2000; left: 50%; top: 50%; transform: translate(-50%, -50%); width: 260px; background: white; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); user-select: none; }
        .calc-header { background: var(--primary); color: white; padding: 10px; border-radius: 12px 12px 0 0; cursor: move; text-align: center; font-size: 0.8rem; font-weight: bold; }
        .calc-screen { background: #ecf0f1; padding: 10px; text-align: right; font-size: 1.2rem; font-family: monospace; font-weight: bold; border-bottom: 1px solid #ccc; overflow: hidden; }
        .calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; padding: 10px; }
        .calc-btn { padding: 15px 5px; background: #eee; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 1rem; }
        .calc-btn:active { background: #ddd; }
        .calc-op { background: var(--test); color: white; }
        .calc-eq { background: var(--accent); color: white; grid-column: span 2; }
        .calc-clr { background: var(--danger); color: white; }
        
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; margin: 15% auto; padding: 20px; width: 80%; max-width: 400px; border-radius: 12px; }
    </style>
</head>
<body>
<div class="container">
    <div class="header-wrap">
        <div class="branding-row"><b>EBS Input</b> <span>v2-75</span></div>
        <div class="header-btns">
            <button class="btn-lookup" onclick="checkEditState(() => cachePull())">Pull local<br>Lookups</button>
            <button class="btn-lookup" id="refresh_btn" onclick="checkEditState(() => initRefresh())">Refresh<br>Lookups<br>from Sheets</button>
            <button class="btn-lookup" onclick="checkEditState(() => cacheSave())">Save to<br>local Lookups</button>
            <button class="btn-lookup" onclick="useTestData()">Pull test<br>Lookups</button>
            <button class="btn-lookup btn-reset-ui" id="resetBtn" onclick="handleResetConfirm()">Reset</button>
        </div>
    </div>
    
    <div style="display:grid; grid-template-columns: 0.8fr 1fr 1.2fr; gap:10px;">
        <div><label>Type</label><select id="colB" onchange="handleManualType()"></select></div>
        <div><label>Grouping</label><select id="colA"></select></div>
        <div><label>Date</label><input type="date" id="colC" onchange="handleDateChange()"></div>
    </div>

    <div style="display:grid; grid-template-columns: 1fr 0.4fr 0.3fr; gap:10px; margin-top:10px;">
        <div><label>Category</label><select id="colF" required onchange="handleCatTrigger()"></select></div>
        <div><label style="text-align:center;">Flow</label><div id="flowDisplay" class="flow-display">--</div></div>
        <div><label>Sort</label><input type="number" id="colG" placeholder="0"></div>
    </div>

    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
        <div><label>From</label><select id="colH" required onchange="handleAccTrigger()"></select></div>
        <div><label>To</label><select id="colI" required onchange="handleAccTrigger()"></select></div>
    </div>

    <div style="display:grid; grid-template-columns:1.2fr 1fr 1fr 1fr; gap:8px; margin-top:10px;">
        <div>
            <label>Each</label>
            <div class="calc-input-wrap">
                <input type="number" id="colT" placeholder="0.00" step="0.01" onfocus="this.value=''" oninput="calc()">
                <button class="btn-calc-trigger" onclick="openCalculator()">¬±</button>
            </div>
        </div>
        <div><label>Currency</label><select id="colX" onchange="calc()"></select></div>
        <div><label>Fees</label><input type="number" id="colV" placeholder="0.00" step="0.01" onfocus="this.value=''" oninput="calc()"></div>
        <div><label>Multiplier</label><input type="number" id="colM" value="1" step="0.01" oninput="calc()"></div>
    </div>

    <div class="total-box"><div class="total-val"><span id="symbol">¬£</span> <span id="totalDisp">0.00</span></div></div>
    <div class="actions">
        <button class="action-main" onclick="saveRow(false)" style="background:var(--accent);">Create Staging record</button>
        <button class="action-main" id="sync_btn" onclick="checkEditState(() => handleSync())" style="background:var(--bridge);">Send Staging records to Sheets</button>
        <button class="action-main" id="wipeBtn" onclick="checkEditState(() => handleWipeConfirm())" style="background:var(--danger);">Clear Staging records</button>
    </div>
    <div class="preview-wrap" id="previewArea"></div>
    <div id="auth_status" style="font-size: 0.75rem; margin-top:10px; text-align:center;">iOS Sync Status: Idle</div>
</div>

<div id="calc_modal">
    <div class="calc-header" id="calc_handle">Calculator (Drag to Move)</div>
    <div class="calc-screen" id="calc_display">0</div>
    <div class="calc-grid">
        <button class="calc-btn calc-clr" onclick="calcAction('C')">C</button>
        <button class="calc-btn" onclick="calcAction('/')">/</button>
        <button class="calc-btn" onclick="calcAction('*')">√ó</button>
        <button class="calc-btn calc-op" onclick="calcAction('DEL')">‚Üê</button>
        
        <button class="calc-btn" onclick="calcAction('7')">7</button>
        <button class="calc-btn" onclick="calcAction('8')">8</button>
        <button class="calc-btn" onclick="calcAction('9')">9</button>
        <button class="calc-btn" onclick="calcAction('-')">-</button>
        
        <button class="calc-btn" onclick="calcAction('4')">4</button>
        <button class="calc-btn" onclick="calcAction('5')">5</button>
        <button class="calc-btn" onclick="calcAction('6')">6</button>
        <button class="calc-btn" onclick="calcAction('+')">+</button>
        
        <button class="calc-btn" onclick="calcAction('1')">1</button>
        <button class="calc-btn" onclick="calcAction('2')">2</button>
        <button class="calc-btn" onclick="calcAction('3')">3</button>
        <button class="calc-btn" onclick="calcAction('%')">%</button>
        
        <button class="calc-btn" onclick="calcAction('0')">0</button>
        <button class="calc-btn" onclick="calcAction('.')">.</button>
        <button class="calc-btn calc-eq" onclick="calcApply()">APPLY</button>
    </div>
    <button class="calc-btn" style="width:100%; border-radius:0 0 12px 12px;" onclick="closeCalculator()">Cancel</button>
</div>

<div id="note_modal" class="modal">
    <div class="modal-content">
        <label>Edit Transaction Note</label>
        <textarea id="modal_note_text" rows="4" style="margin-top:10px;"></textarea>
        <div style="display:flex; gap:10px; margin-top:15px;">
            <button onclick="commitNote()" style="flex:1; background:var(--accent); color:white; padding:10px; border-radius:6px; border:none; font-weight:bold;">Save Note</button>
            <button onclick="closeNote()" style="flex:1; background:#7f8c8d; color:white; padding:10px; border-radius:6px; border:none; font-weight:bold;">Cancel</button>
        </div>
    </div>
</div>

<script>
    const SHEET_ID = '1DdjG4B8wB9llk7yOoRRO72G0XqHEgFkMIlLuusShA6E';
    const VER = "Excel Budget Sheet Input (v2-75)";
    let AA_LIST = [], coordinateMap = {}, rawLookupData = [], wipeConfirmed = false, resetConfirmed = false, isRestoring = false, editIndex = -1, pendingEdit = -1, activeNoteIdx = -1;

    function checkEditState(onSuccess) { if (pendingEdit !== -1 || editIndex !== -1) { alert("This function is not available while Edit is in progress for a Staging entry."); return; } onSuccess(); }

    // v2-75 Calculator Engine
    let calcString = "";
    function openCalculator() {
        const currentVal = document.getElementById('colT').value;
        calcString = currentVal ? currentVal.toString() : "0";
        updateCalcDisplay();
        document.getElementById('calc_modal').style.display = 'block';
    }
    function closeCalculator() { document.getElementById('calc_modal').style.display = 'none'; }
    function updateCalcDisplay() { document.getElementById('calc_display').innerText = calcString || "0"; }
    
    function calcAction(val) {
        if (val === 'C') calcString = "0";
        else if (val === 'DEL') calcString = calcString.slice(0, -1);
        else if (val === '%') { try { calcString = (eval(calcString) / 100).toString(); } catch(e) { calcString = "Error"; } }
        else {
            if (calcString === "0" && !isNaN(val)) calcString = val;
            else calcString += val;
        }
        updateCalcDisplay();
    }
    
    function calcApply() {
        try {
            const result = eval(calcString);
            document.getElementById('colT').value = parseFloat(result).toFixed(2);
            calc();
            closeCalculator();
        } catch(e) { alert("Invalid Calculation"); }
    }

    // Draggable Logic
    const dragItem = document.querySelector("#calc_modal");
    const dragHandle = document.querySelector("#calc_handle");
    let active = false, currentX, currentY, initialX, initialY, xOffset = 0, yOffset = 0;

    dragHandle.addEventListener("mousedown", dragStart);
    document.addEventListener("mouseup", dragEnd);
    document.addEventListener("mousemove", drag);

    function dragStart(e) {
        initialX = e.clientX - xOffset; initialY = e.clientY - yOffset;
        if (e.target === dragHandle) active = true;
    }
    function dragEnd() { active = false; }
    function drag(e) {
        if (active) {
            e.preventDefault();
            currentX = e.clientX - initialX; currentY = e.clientY - initialY;
            xOffset = currentX; yOffset = currentY;
            dragItem.style.transform = `translate(calc(-50% + ${currentX}px), calc(-50% + ${currentY}px))`;
        }
    }

    // Fixed Note Logic
    function openNote(idx) {
        const d = JSON.parse(localStorage.getItem('ebs_trf') || '[]');
        if (!d[idx]) return;
        activeNoteIdx = idx;
        document.getElementById('modal_note_text').value = d[idx][10] || "";
        document.getElementById('note_modal').style.display = 'block';
    }
    function closeNote() { document.getElementById('note_modal').style.display = 'none'; }
    function commitNote() {
        let d = JSON.parse(localStorage.getItem('ebs_trf') || '[]');
        d[activeNoteIdx][10] = document.getElementById('modal_note_text').value;
        localStorage.setItem('ebs_trf', JSON.stringify(d));
        closeNote();
        renderPreview();
    }

    // Standard Grid Logic
    function handleAccTrigger() {
        if (isRestoring) return;
        const h = document.getElementById('colH').value, i = document.getElementById('colI').value;
        const fAA = AA_LIST.includes(h), tAA = AA_LIST.includes(i);
        let flow = "zOut";
        if (fAA && tAA) flow = "xfer";
        else if (!fAA && tAA) flow = "In";
        document.getElementById('flowDisplay').innerText = flow;
    }
    
    function calc() {
        const t = parseFloat(document.getElementById('colT').value)||0;
        const u = parseFloat(document.getElementById('colM').value)||1;
        const v = parseFloat(document.getElementById('colV').value)||0;
        const total = ((t * u) + v).toFixed(2);
        document.getElementById('totalDisp').innerText = total;
        return total;
    }

    function saveRow(isOverwrite) {
        const flow = document.getElementById('flowDisplay').innerText;
        if (flow === "--") { alert("Select Flow"); return; }
        const r = Array(35).fill("");
        r[0]=document.getElementById('colA').value; r[1]=document.getElementById('colB').value; 
        r[2]=document.getElementById('colC').value; r[4]=flow; r[5]=document.getElementById('colF').value;
        r[6]=document.getElementById('colG').value; r[7]=document.getElementById('colH').value; 
        r[8]=document.getElementById('colI').value; r[10]=document.getElementById('colK').value;
        r[19]=document.getElementById('colT').value; r[20]=document.getElementById('colM').value;
        r[21]=document.getElementById('colV').value; r[22]=calc(); r[23]=document.getElementById('colX').value;
        r[25]=document.getElementById('colZ').value;
        let d = JSON.parse(localStorage.getItem('ebs_trf') || '[]');
        if (isOverwrite && editIndex > -1) d[editIndex] = r; else d.push(r);
        localStorage.setItem('ebs_trf', JSON.stringify(d));
        localReset();
    }

    function renderPreview() {
        const d = JSON.parse(localStorage.getItem('ebs_trf') || '[]');
        let h = '<table><tr><th>E</th><th>Grp</th><th>Type</th><th>Day</th><th>Date</th><th>Flow</th><th>Category</th><th>Sort</th><th>From</th><th>To</th><th>Note</th><th>Tot</th><th>Del</th></tr>';
        d.forEach((r, idx) => {
            const btnLabel = (pendingEdit === idx) ? "..." : (editIndex === idx ? "C" : "E");
            h += `<tr><td><button onclick="initiateEdit(${idx})">${btnLabel}</button></td><td>${r[0]}</td><td>${r[1]}</td><td>Day</td><td>${r[2]}</td><td>${r[4]}</td><td>${r[5]}</td><td>${r[6]}</td><td>${r[7]}</td><td>${r[8]}</td><td class="w-note" onclick="openNote(${idx})">${r[10]?'üìÑ':'‚ñ´Ô∏è'}</td><td>${r[22]}</td><td><button onclick="deleteRow(${idx})">X</button></td></tr>`;
        });
        document.getElementById('previewArea').innerHTML = h + '</table>';
    }

    function initiateEdit(idx) {
        if (rawLookupData.length === 0) { alert("First Refresh Lookups or Pull local Lookups."); return; }
        if (pendingEdit === idx) {
            isRestoring = true; editIndex = idx; pendingEdit = -1;
            const d = JSON.parse(localStorage.getItem('ebs_trf'))[idx];
            document.getElementById('colA').value = d[0]; document.getElementById('colB').value = d[1];
            document.getElementById('colC').value = d[2]; document.getElementById('flowDisplay').innerText = d[4];
            document.getElementById('colF').value = d[5]; document.getElementById('colG').value = d[6];
            document.getElementById('colH').value = d[7]; document.getElementById('colI').value = d[8];
            document.getElementById('colK').value = d[10]; document.getElementById('colT').value = d[19];
            document.getElementById('colM').value = d[20]; document.getElementById('colV').value = d[21];
            document.getElementById('colX').value = d[23]; document.getElementById('colZ').value = d[25];
            isRestoring = false;
        } else { pendingEdit = idx; editIndex = -1; }
        renderPreview();
    }

    function localReset() { editIndex = -1; pendingEdit = -1; renderPreview(); }
    function handleResetConfirm() { localReset(); }
    function handleWipeConfirm() { localStorage.removeItem('ebs_trf'); renderPreview(); }
    async function handleSync() { /* Standard Sync Logic */ }
    window.onload = () => { gapiLoaded(); gisLoaded(); renderPreview(); };
</script>
</body>
</html>
