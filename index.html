<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EBS Entry v2-31</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>
    <style>
        :root { --primary: #2c3e50; --accent: #27ae60; --danger: #c0392b; --bg: #f8f9fa; --bridge: #2980b9; --cache: #8e44ad; --test: #e67e22; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); margin: 0; padding: 10px; }
        .container { max-width: 960px; margin: auto; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .header-wrap { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; gap: 5px; }
        .title-block { display: flex; flex-direction: column; justify-content: center; min-width: 85px; }
        h3 { margin: 0; font-weight: bold; font-size: 1.1rem; line-height: 1.1; color: var(--primary); }
        .ver-tag { font-weight: 400; font-size: 0.7rem; color: #7f8c8d; margin-top: 2px; }
        .header-btns { display: flex; gap: 3px; }
        
        .btn-lookup { background: var(--bridge); padding: 2px; font-size: 0.5rem; border-radius: 6px; border: none; color: white; cursor: pointer; font-weight: 600; width: 55px; height: 44px; line-height: 1.1; text-align: center; overflow: hidden; -webkit-font-smoothing: antialiased; }
        .btn-reset-ui { background: #7f8c8d; }
        .btn-cache-save { background: var(--accent); }
        .btn-cache-pull { background: var(--cache); }
        .btn-test-mode { background: var(--test); }
        
        label { font-size: 0.7rem; font-weight: 700; display: block; margin-bottom: 2px; color: var(--primary); }
        input, select, textarea { width: 100%; padding: 8px; border: 1px solid #dcdde1; border-radius: 6px; font-size: 16px; box-sizing: border-box; height: 38px; -webkit-text-size-adjust: 100%; font-family: inherit; }
        .date-input-container { display: flex; align-items: center; gap: 5px; background: white; border: 1px solid #dcdde1; border-radius: 6px; padding: 0 8px; height: 38px; }
        .date-input-container input[type="date"] { border: none; padding: 0; height: 100%; font-size: 14px; flex-grow: 1; outline: none; background: transparent; }
        .type-display { font-size: 0.85rem; font-weight: bold; color: var(--primary); text-align: center; height: 38px; line-height: 36px; border: 1px solid #dcdde1; border-radius: 6px; background: #f1f2f6; box-sizing: border-box; }
        .total-box { background: #e8f5e9; border: 2px dashed var(--accent); padding: 10px; border-radius: 8px; text-align: center; margin: 15px 0; }
        .total-val { font-size: 1.3rem; font-weight: bold; color: var(--accent); }
        
        .actions { display: grid; grid-template-columns: 1fr 1fr 1.2fr; gap: 8px; }
        button.action-main { padding: 10px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; color: white; font-size: 0.72rem; -webkit-font-smoothing: antialiased; }
        
        /* v2-31 Staging Area Width and Column Sizing */
        .preview-wrap { width: 100%; overflow-x: auto; margin-top: 15px; -webkit-overflow-scrolling: touch; border: 1px solid #ddd; border-radius: 6px; }
        table { width: 1080px; border-collapse: collapse; font-size: 0.58rem; table-layout: fixed; }
        th, td { border: 1px solid #eee; padding: 6px 3px; text-align: left; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        th { background: #f2f2f2; font-weight: bold; color: var(--primary); }
        
        .w-edit { width: 30px; text-align: center; } .w-grp { width: 40px; } .w-day { width: 30px; text-align: center; }
        .w-fu { width: 60px; } .w-date { width: 70px; }
        .w-cat, .w-acc { width: 110px; } .w-sort { width: 30px; } 
        .w-note { width: 30px; text-align: center; } .w-freq { width: 60px; } .w-cur { width: 35px; text-align: center; }
        .w-tot { width: 80px; } .w-mnth { width: 40px; text-align: center; } .w-stat { width: 60px; }
        .w-who { width: 45px; } .w-del { width: 30px; text-align: center; }
        
        #auth_status { font-size: 0.65rem; margin-top: 10px; text-align: center; color: #7f8c8d; }
        #log_btn { margin-top: 15px; width: 100%; background: var(--primary); color: white; font-size: 0.7rem; border-radius: 6px; padding: 8px; display: block; border: none; font-weight: 600; }
        #trace_log { margin-top: 15px; padding: 10px; background: #2c3e50; color: #00ff00; font-family: "Courier New", monospace; font-size: 0.6rem; border-radius: 6px; max-height: 120px; overflow-y: auto; white-space: pre-wrap; display: none; cursor: pointer; }
        .txt-center { text-align: center; }
    </style>
</head>
<body>
<div class="container">
    <div class="header-wrap">
        <div class="title-block"><h3>EBS Input</h3><div class="ver-tag">v2-31</div></div>
        <div class="header-btns">
            <button class="btn-lookup btn-cache-pull" onclick="cachePull()">Pull local<br>Lookups</button>
            <button class="btn-lookup" onclick="initRefresh()">Refresh<br>Lookups</button>
            <button class="btn-lookup btn-cache-save" onclick="cacheSave()">Save to<br>local Lookups</button>
            <button class="btn-lookup btn-test-mode" onclick="useTestData()">Pull test<br>Lookups</button>
            <button class="btn-lookup btn-reset-ui" onclick="localReset()">Reset<br>fields</button>
        </div>
    </div>
    <div style="display:grid; grid-template-columns: 0.8fr 1fr 1.2fr; gap:10px;">
        <div><label>F/U</label><select id="colB" onchange="handleManualFU()"></select></div>
        <div><label>Grouping</label><select id="colA"></select></div>
        <div><label>Date</label><div class="date-input-container" onclick="document.getElementById('colC').showPicker()"><span>ðŸ“…</span><input type="date" id="colC" onchange="handleDateChange()"></div><div id="colCDisp" style="font-size:0.65rem; color:#7f8c8d; text-align:center; margin-top:2px;"></div></div>
    </div>
    <div style="display:grid; grid-template-columns: 1fr 0.4fr 0.3fr; gap:10px; margin-top:10px;">
        <div><label>Category</label><select id="colF" required onchange="handleCatTrigger()"></select></div>
        <div><label style="text-align:center;">Type</label><div id="workTypeDisplay" class="type-display">--</div></div>
        <div><label>sort</label><input type="number" id="colG" placeholder="0"></div>
    </div>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
        <div><label>From</label><select id="colH" required onchange="handleAccTrigger()"></select></div>
        <div><label>To</label><select id="colI" required onchange="handleAccTrigger()"></select></div>
    </div>
    <div style="margin-top:10px;"><label>Note</label><textarea id="colK" rows="2" style="width:100%; border-radius:6px; border:1px solid #dcdde1; padding:8px; box-sizing:border-box; font-size:16px;"></textarea></div>
    <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-top:10px;">
        <div><label>Frequency</label><select id="colFreq"></select></div>
        <div><label>Status</label><select id="colStatus"></select></div>
        <div><label>Mnth</label><select id="colZ"></select></div>
    </div>
    <div style="display:grid; grid-template-columns:1fr 1fr 1fr 1fr; gap:8px; margin-top:10px;">
        <div><label>Each</label><input type="number" id="colT" placeholder="0.00" step="0.01" oninput="calc()"></div>
        <div><label>Currency</label><select id="colX" onchange="calc()"></select></div>
        <div><label>Fees</label><input type="number" id="colV" placeholder="0.00" step="0.01" oninput="calc()"></div>
        <div><label>Multiplier</label><input type="number" id="colM" value="1" step="0.01" oninput="calc()"></div>
    </div>
    <div class="total-box"><div class="total-val"><span id="symbol">Â£</span> <span id="totalDisp">0.00</span></div></div>
    <div class="actions">
        <button class="action-main" onclick="saveRow(false)" style="background:var(--accent);">Create Staging record</button>
        <button class="action-main" id="sync_btn" onclick="handleSync()" style="background:var(--bridge);">Send Staging records to Sheets</button>
        <button class="action-main" id="wipeBtn" onclick="clearData()" style="background:var(--danger); opacity: 0.85;">Clear Staging records</button>
    </div>
    <div class="preview-wrap" id="previewArea"></div>
    <div id="auth_status">iOS Sync Status: Idle</div>
    <button id="log_btn" onclick="toggleLog(true)">Display Trace Log</button>
    <div id="trace_log" onclick="toggleLog(false)">Trace: v2-31 Day/Date format and Full String display updated.</div>
    <input type="hidden" id="bgTypeE" value="--">
</div>
<script>
    const SHEET_ID = '1DdjG4B8wB9llk7yOoRRO72G0XqHEgFkMIlLuusShA6E';
    const VER = "Excel Budget Sheet Input (v2-31)";
    let AA_LIST = [], coordinateMap = {}, symbols = { "GBP": "Â£", "EUR": "â‚¬", "USD": "$", "ZAR": "R", "CHF": "Fr", "THB": "à¸¿", "RUR": "â‚½", "COP": "COL$" };
    let tokenClient, wipeConfirmed = false, editIndex = -1, pendingEdit = -1, rawLookupData = [];

    const TEST_SET = {
        "Grouping": ["Roy", "Peter"], "FU": ["v - Verified", "xf - Transfer", "S - Support"], "Categories": ["Food", "Transfer", "Support Misc", "Salary", "Rent"],
        "Accounts": ["Revolut P (AA)", "Starling B (AA)", "Employer (EXT)", "Landlord (EXT)", "Tesco (EXT)"], "AA": ["Revolut P (AA)", "Starling B (AA)"],
        "Freq": ["A - Ad-hoc", "M - Monthly", "K - Transfer"], "Status": ["N - New", "P - Paid"], "Month": ["NEW", "JAN", "FEB"], "Cur": ["GBP", "EUR", "ZAR"]
    };

    function logTrace(msg) { const log = document.getElementById('trace_log'); const now = new Date().toLocaleTimeString(); log.innerText += `\n[${now}] ${msg}`; log.scrollTop = log.scrollHeight; }
    function toggleLog(show) { document.getElementById('log_btn').style.display = show ? 'none' : 'block'; document.getElementById('trace_log').style.display = show ? 'block' : 'none'; }
    function gapiLoaded() { gapi.load('client', async () => { await gapi.client.init({ apiKey: 'AIzaSyDvZ1XZw5bZgWSB9zaU7h9Vtn7MhDGFMSM' }); await gapi.client.load('sheets', 'v4'); logTrace("GAPI Ready."); }); }
    function gisLoaded() { tokenClient = google.accounts.oauth2.initTokenClient({ client_id: '23231735212-jtgur3sn2ndh798ke00pm2a1d5rkd4eu.apps.googleusercontent.com', scope: 'https://www.googleapis.com/auth/spreadsheets', callback: '' }); gsiInited = true; logTrace("GIS Ready."); }

    function useTestData() {
        if (!confirm("Overwrite current values with representational test set?")) return;
        AA_LIST = TEST_SET.AA; coordinateMap = {"Grouping":{val:0},"F/U":{val:1},"Category":{val:2},"From":{val:3},"To":{val:4},"Frequency":{val:5},"Status":{val:6},"Month":{val:7},"Currency":{val:8}};
        updateDropdown('colA', TEST_SET.Grouping, 'Roy'); updateDropdown('colB', TEST_SET.FU, 'v'); updateDropdown('colF', TEST_SET.Categories, null, '--Select--'); updateDropdown('colH', TEST_SET.Accounts, null, '--Select--'); updateDropdown('colI', TEST_SET.Accounts, null, '--Select--'); updateDropdown('colFreq', TEST_SET.Freq, 'A'); updateDropdown('colStatus', TEST_SET.Status, 'N'); updateDropdown('colZ', TEST_SET.Month, 'NEW'); updateDropdown('colX', TEST_SET.Cur, 'GBP');
        localReset(); logTrace("Test Data Mode Active.");
    }

    function cacheSave() { if (rawLookupData.length === 0) { alert("First Refresh Lookups"); return; } if (!confirm("Snapshot active values?")) return; localStorage.setItem('ebs_cache_data', JSON.stringify(rawLookupData)); localStorage.setItem('ebs_cache_coords', JSON.stringify(coordinateMap)); localStorage.setItem('ebs_cache_aa', JSON.stringify(AA_LIST)); logTrace("local UI Snapshotted."); }
    function cachePull() { if (!confirm("Do you want to load local Lookups?")) return; const cached = localStorage.getItem('ebs_cache_data'); if (cached) { rawLookupData = JSON.parse(cached); coordinateMap = JSON.parse(localStorage.getItem('ebs_cache_coords')); AA_LIST = JSON.parse(localStorage.getItem('ebs_cache_aa')); populateUI(rawLookupData); logTrace("local Snapshot Loaded."); } else { alert("No snapshot found."); } }
    
    function initRefresh() { tokenClient.callback = async (resp) => { if (resp.access_token) { localStorage.setItem('g_token', resp.access_token); fetchLookupRefs(); } }; tokenClient.requestAccessToken(); }
    async function fetchLookupRefs() { const res = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SHEET_ID, range: 'LookupRefs!A2:C15' }); res.result.values.forEach(r => { coordinateMap[r[0]] = { val: colToIndex(r[1].toUpperCase().replace(/[0-9]/g, '')), desc: (r[2] && r[2].toLowerCase() !== 'n/a') ? colToIndex(r[2]) : null }; }); fetchActiveAccounts(); }
    function colToIndex(col) { let idx = 0; for(let i=0; i<col.length; i++) { idx = idx * 26 + (col.charCodeAt(i) - 64); } return idx - 1; }
    async function fetchActiveAccounts() { const res = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SHEET_ID, range: 'ActiveAccounts!A2:A500' }); AA_LIST = res.result.values ? res.result.values.flat().filter(v => v) : []; fetchActualData(); }
    async function fetchActualData() { const res = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SHEET_ID, range: 'Lookups!A2:AC1000' }); rawLookupData = res.result.values; populateUI(rawLookupData); }
    function populateUI(data) { const pop = (id, key, def, p = null) => { const list = data.filter(r => r[coordinateMap[key].val]).map(r => { const v = r[coordinateMap[key].val], d = coordinateMap[key].desc !== null ? r[coordinateMap[key].desc] : null; return d ? `${v} - ${d}` : v; }); updateDropdown(id, list, def, p); }; pop('colA','Grouping','Roy'); pop('colB','F/U','v'); pop('colF','Category',null,'--Select--'); pop('colH','From',null,'--Select--'); pop('colI','To',null,'--Select--'); pop('colFreq','Frequency','A'); pop('colStatus','Status','N'); pop('colZ','Month','NEW'); pop('colX','Currency','GBP'); localReset(); }
    function updateDropdown(id, vals, def, prompt) { const s = document.getElementById(id); let h = prompt ? `<option value="" disabled selected>${prompt}</option>` : ''; h += vals.map(v => `<option value="${v}">${v}</option>`).join(''); s.innerHTML = h; if(def) { const o = Array.from(s.options).find(opt => opt.value.startsWith(def)); if(o) s.value = o.value; } }

    function localReset() {
        ['colT','colV','colG','colK'].forEach(id => { const el = document.getElementById(id); if(el) el.value = ""; });
        document.getElementById('colM').value = "1"; document.getElementById('workTypeDisplay').innerText = "--"; editIndex = -1; pendingEdit = -1;
        const rS = (id, def) => { const s = document.getElementById(id); if(!s) return; if(def) { const o = Array.from(s.options).find(opt => opt.value.startsWith(def)); if(o) s.value = o.value; } else s.selectedIndex = 0; };
        rS('colA','Roy'); rS('colB','v'); rS('colF',null); rS('colH',null); rS('colI',null); rS('colFreq','A'); rS('colStatus','N'); rS('colZ','NEW'); rS('colX','GBP');
        renderPreview(); calc(); logTrace("local UI Reset Complete.");
    }

    function handleAccTrigger() {
        const h = document.getElementById('colH').value, i = document.getElementById('colI').value, fu = document.getElementById('colB'), tD = document.getElementById('workTypeDisplay'), cat = document.getElementById('colF'), freq = document.getElementById('colFreq'); if (!h || !i || h.includes("--") || i.includes("--")) return;
        const fAA = AA_LIST.includes(h), tAA = AA_LIST.includes(i); let valE = "zOut"; if (fAA && tAA) valE = "xfer"; else if (!fAA && tAA) valE = "In";
        tD.innerText = valE;
        if (valE === "xfer") { const xf = Array.from(fu.options).find(o => o.value.startsWith('xf')); if(xf) fu.value = xf.value; const k = Array.from(freq.options).find(o => o.value.startsWith('K')); if(k) freq.value = k.value; cat.value = "Transfer"; }
        else if (cat.value.toLowerCase().includes("support")) { const s = Array.from(fu.options).find(o => o.value.startsWith('S')); if(s) fu.value = s.value; }
    }
    function handleCatTrigger() { const f = document.getElementById('colF').value, fu = document.getElementById('colB'); if (f.startsWith('S')) { const s = Array.from(fu.options).find(o => o.value.startsWith('S')); if(s) fu.value = s.value; } }
    function handleDateChange() { const dStr = document.getElementById('colC').value; if(!dStr) return; const [y, m, d] = dStr.split('-').map(Number); const dt = new Date(y, m-1, d); document.getElementById('colCDisp').innerText = `${['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][dt.getDay()]} ${dt.getDate()} ${['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][dt.getMonth()]} '${String(dt.getFullYear()).substr(-2)}`; }
    function calc() { const t = parseFloat(document.getElementById('colT').value)||0, u = parseFloat(document.getElementById('colM').value)||1, v = parseFloat(document.getElementById('colV').value)||0; const tot = ((t * u) + v).toFixed(2); const curCode = document.getElementById('colX').value.split(' - ')[0] || 'GBP'; document.getElementById('symbol').innerText = symbols[curCode]||"Â£"; document.getElementById('totalDisp').innerText = tot; return tot; }
    function handleManualFU() { if(document.getElementById('colB').value.startsWith('xf')) document.getElementById('colF').value = "Transfer"; }
    
    function initiateEdit(idx) {
        if (pendingEdit === idx) {
            editIndex = idx; pendingEdit = -1;
            const d = JSON.parse(localStorage.getItem('ebs_trf'))[idx];
            const sV = (id, val, iS = false) => { const el = document.getElementById(id); if(!el) return; if(!iS) el.value = val; else { const o = Array.from(el.options).find(opt => opt.value.startsWith(val)); if(o) el.value = o.value; } };
            sV('colA',d[0],true); sV('colB',d[1],true); sV('colC',d[2]); sV('colF',d[5],true); sV('colG',d[6]); sV('colH',d[7],true); sV('colI',d[8],true); sV('colK',d[10]); sV('colFreq',d[11],true); sV('colStatus',d[14],true); sV('colT',d[19]); sV('colM',d[20]); sV('colV',d[21]); sV('colX',d[23],true); sV('colZ',d[25],true);
            handleDateChange(); handleAccTrigger(); logTrace("Edit active.");
        } else { pendingEdit = idx; editIndex = -1; logTrace("Confirming edit..."); }
        renderPreview();
    }
    
    function saveRow(isOverwrite) {
        const fv = document.getElementById('colF').value, hv = document.getElementById('colH').value, iv = document.getElementById('colI').value; if (!fv || !hv || !iv || fv.includes("--") || hv.includes("--") || iv.includes("--")) { alert("Missing data."); return; }
        let wV = ""; if (fv.startsWith('S')) wV = document.getElementById('colA').value;
        const r = Array(35).fill(""); 
        r[0]=document.getElementById('colA').value; 
        r[1]=document.getElementById('colB').value; // Store full string v2-31
        r[2]=document.getElementById('colC').value; 
        r[4]=document.getElementById('workTypeDisplay').innerText; 
        r[5]=document.getElementById('colF').value; 
        r[6]=document.getElementById('colG').value; 
        r[7]=document.getElementById('colH').value; 
        r[8]=document.getElementById('colI').value; 
        r[10]=document.getElementById('colK').value; 
        r[11]=document.getElementById('colFreq').value; // Store full string v2-31
        r[14]=document.getElementById('colStatus').value; // Store full string v2-31
        r[19]=parseFloat(document.getElementById('colT').value||0).toFixed(2); r[20]=document.getElementById('colM').value; r[21]=parseFloat(document.getElementById('colV').value||0).toFixed(2); r[22]=calc(); 
        r[23]=document.getElementById('colX').value.split(' - ')[0]; 
        r[25]=document.getElementById('colZ').value; r[33]=wV; r[34]=VER;
        let d = JSON.parse(localStorage.getItem('ebs_trf') || '[]');
        if (isOverwrite && editIndex > -1) { d[editIndex] = r; logTrace("Record Overwritten."); } else { d.push(r); logTrace("New Record Staged."); }
        localStorage.setItem('ebs_trf', JSON.stringify(d)); localReset();
    }

    function renderPreview() {
        const d = JSON.parse(localStorage.getItem('ebs_trf') || '[]');
        let h = '<table><tr><th class="w-edit">E</th><th class="w-grp">Grp</th><th class="w-day">Day</th><th class="w-fu">F/U</th><th class="w-date">Date</th><th class="w-cat">Category</th><th class="w-sort">sort</th><th class="w-acc">From</th><th class="w-acc">To</th><th class="w-note">Note</th><th class="w-freq">Freq</th><th class="w-cur">Cur</th><th class="w-tot">Total</th><th class="w-mnth">Mnth</th><th class="w-stat">Status</th><th class="w-who">Who</th><th class="w-del">Del</th></tr>';
        d.forEach((r, idx) => { 
            let btnStyle = "background:#3498db"; let btnLabel = "E"; let fn = `initiateEdit(${idx})`;
            if (pendingEdit === idx) { btnStyle = "background:red"; btnLabel = "..."; }
            else if (editIndex === idx) { btnStyle = "background:#f39c12"; btnLabel = "C"; fn = `saveRow(true)`; }
            
            // Date logic v2-31
            const [y, m, dayNum] = r[2].split('-').map(Number); const dt = new Date(y, m-1, dayNum);
            const dayName = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][dt.getDay()];
            const dateStr = `${String(dayNum).padStart(2,'0')} ${['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][dt.getMonth()]} '${String(dt.getFullYear()).substr(-2)}`;

            h += `<tr><td class="w-edit"><button onclick="${fn}" style="${btnStyle};color:white;border:none;border-radius:4px;padding:2px 6px;width:22px;">${btnLabel}</button></td><td>${r[0]}</td><td class="txt-center">${dayName}</td><td>${r[1]}</td><td>${dateStr}</td><td>${r[5]}</td><td class="txt-center">${r[6]}</td><td>${r[7]}</td><td>${r[8]}</td><td class="txt-center">${r[10]?'âœ“':''}</td><td>${r[11]}</td><td class="txt-center">${r[23]}</td><td>${r[22]}</td><td class="txt-center">${r[25]}</td><td>${r[14]}</td><td>${r[33]}</td><td class="w-del"><button onclick="deleteRow(${idx})" style="background:red;border:none;color:white;cursor:pointer;padding:0 5px;border-radius:4px;">X</button></td></tr>`; 
        });
        document.getElementById('previewArea').innerHTML = h + '</table>';
    }
    function deleteRow(i) { let d = JSON.parse(localStorage.getItem('ebs_trf') || '[]'); d.splice(i, 1); localStorage.setItem('ebs_trf', JSON.stringify(d)); editIndex = -1; pendingEdit = -1; renderPreview(); }
    async function handleSync() {
        const d = JSON.parse(localStorage.getItem('ebs_trf') || '[]'); if (!d.length) return;
        tokenClient.callback = async (resp) => { if (!resp.access_token) return; try {
            const meta = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SHEET_ID, range: "'EBSinput'!A:A" }); const nR = (meta.result.values ? meta.result.values.length : 0) + 1;
            const vls = d.map(r => { 
                let rc = [...r]; const dP = rc[2].split('-'); rc[2] = `${dP[2]}/${dP[1]}/${dP[0]}`; 
                // Sync only the codes to sheets, not the descriptions
                [1, 11, 14].forEach(i => rc[i] = rc[i].split(' - ')[0]);
                [19, 21, 22].forEach(i => rc[i] = parseFloat(rc[i] || 0)); return rc; 
            });
            await gapi.client.sheets.spreadsheets.values.update({ spreadsheetId: SHEET_ID, range: `'EBSinput'!A${nR}:AI${nR + vls.length - 1}`, valueInputOption: 'USER_ENTERED', resource: { values: vls } });
            logTrace("Sync OK."); localStorage.removeItem('ebs_trf'); renderPreview();
        } catch (e) { logTrace("Sync Fail."); } }; tokenClient.requestAccessToken();
    }
    function clearData() { if(!wipeConfirmed) { wipeConfirmed=true; document.getElementById('wipeBtn').innerText = "CONFIRM?"; setTimeout(()=>{wipeConfirmed=false; document.getElementById('wipeBtn').innerText="Clear Staging records";},3000); } else { localStorage.removeItem('ebs_trf'); wipeConfirmed=false; renderPreview(); } }
    window.onload = () => { document.getElementById('colC').value = new Date().toISOString().split('T')[0]; handleDateChange(); gapiLoaded(); gisLoaded(); renderPreview(); };
</script>
</body>
</html>
