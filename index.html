<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>EBS Entry v3.02</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>
    <style>
        :root { --primary: #2c3e50; --accent: #27ae60; --danger: #c0392b; --bg: #f8f9fa; --bridge: #2980b9; --cache: #8e44ad; --test: #e67e22; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); margin: 0; padding: 10px; }
        .container { max-width: 960px; margin: auto; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .header-wrap { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; gap: 5px; }
        .title-block { display: flex; flex-direction: column; min-width: 85px; }
        h3 { margin: 0; font-weight: bold; font-size: 1.1rem; line-height: 1.1; color: var(--primary); }
        .ver-tag { font-weight: 400; font-size: 0.7rem; color: #7f8c8d; }
        .header-btns { display: flex; gap: 3px; }
        .btn-lookup { background: var(--bridge); padding: 2px; font-size: 0.5rem; border-radius: 6px; border: none; color: white; cursor: pointer; font-weight: 600; width: 55px; height: 44px; line-height: 1.1; text-align: center; }
        .btn-reset-ui { background: #7f8c8d; } .btn-cache-save { background: var(--accent); } .btn-cache-pull { background: var(--cache); } .btn-test-mode { background: var(--test); }
        label { font-size: 0.7rem; font-weight: 700; display: block; margin-bottom: 2px; color: var(--primary); }
        input, select, textarea { width: 100%; padding: 8px; border: 1px solid #dcdde1; border-radius: 6px; font-size: 16px; box-sizing: border-box; height: 38px; -webkit-appearance: none; }
        .total-box { background: #e8f5e9; border: 2px dashed var(--accent); padding: 10px; border-radius: 8px; text-align: center; margin: 15px 0; }
        .total-val { font-size: 1.3rem; font-weight: bold; color: var(--accent); }
        .actions { display: grid; grid-template-columns: 1fr 1fr 1.2fr; gap: 8px; }
        button.action-main { padding: 10px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; color: white; font-size: 0.72rem; }
        .preview-wrap { width: 100%; overflow-x: auto; margin-top: 15px; border: 1px solid #ddd; border-radius: 6px; }
        table { width: 1050px; border-collapse: collapse; font-size: 0.58rem; table-layout: fixed; }
        th, td { border: 1px solid #eee; padding: 6px 3px; text-align: left; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        /* Note Font fix: forced sans-serif boldness v3.02 */
        th { background: #f2f2f2; font-weight: bold !important; color: var(--primary); font-family: inherit !important; }
        .w-edit { width: 30px; text-align: center; } .w-grp { width: 40px; } .w-day { width: 30px; text-align: center; } .w-fu { width: 60px; } .w-date { width: 70px; } .w-cat, .w-acc { width: 110px; } .w-sort { width: 30px; } .w-note { width: 40px; text-align: center; cursor: pointer; font-size: 1rem; } 
        .w-freq { width: 100px; } .w-cur { width: 35px; text-align: center; } .w-tot { width: 80px; text-align: right; } .w-mnth { width: 40px; text-align: center; } .w-stat { width: 60px; } .w-who { width: 45px; } .w-del { width: 30px; text-align: center; }
        #auth_status { font-size: 0.75rem; margin-top: 10px; text-align: center; color: var(--primary); font-weight: 600; }
        #trace_btn { margin-top: 15px; width: 100%; background: #eee; border: 1px solid #ccc; border-radius: 6px; padding: 8px; font-weight: bold; cursor: pointer; }
        #trace_log { margin-top: 10px; padding: 10px; background: #2c3e50; color: #00ff00; font-family: monospace; font-size: 0.6rem; border-radius: 6px; max-height: 120px; overflow-y: auto; display: none; }
        #note_modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; margin: 15% auto; padding: 20px; width: 80%; max-width: 400px; border-radius: 12px; }
    </style>
</head>
<body>
<div class="container">
    <div class="header-wrap">
        <div class="title-block"><h3>EBS Input</h3><div class="ver-tag">v3.02</div></div>
        <div class="header-btns">
            <button class="btn-lookup btn-cache-pull" onclick="cachePull()">Pull local<br>Lookups</button>
            <button class="btn-lookup" id="refresh_btn" onclick="initRefresh()">Refresh<br>Lookups</button>
            <button class="btn-lookup btn-cache-save" onclick="cacheSave()">Save to<br>local Lookups</button>
            <button class="btn-lookup btn-test-mode" onclick="useTestData()">Pull test<br>Lookups</button>
            <button class="btn-lookup btn-reset-ui" onclick="localReset()">Reset<br>fields</button>
        </div>
    </div>
    <div style="display:grid; grid-template-columns: 0.8fr 1fr 1.2fr; gap:10px;">
        <div><label>F/U</label><select id="colB" onchange="handleManualFU()"></select></div>
        <div><label>Grouping</label><select id="colA"></select></div>
        <div><label>Date</label><input type="date" id="colC" onchange="handleDateChange()"></div>
    </div>
    <div style="display:grid; grid-template-columns: 1fr 0.4fr 0.3fr; gap:10px; margin-top:10px;">
        <div><label>Category</label><select id="colF" required onchange="handleCatTrigger()"></select></div>
        <div><label style="text-align:center;">Type</label><div id="workTypeDisplay" style="height:38px; background:#f1f2f6; border:1px solid #ddd; border-radius:6px; line-height:38px; text-align:center;">--</div></div>
        <div><label>sort</label><input type="number" id="colG" placeholder="0" onfocus="this.value=''"></div>
    </div>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
        <div><label>From</label><select id="colH" required onchange="handleAccTrigger()"></select></div>
        <div><label>To</label><select id="colI" required onchange="handleAccTrigger()"></select></div>
    </div>
    <div style="margin-top:10px;"><label>Note</label><textarea id="colK" rows="2" style="font-size:16px;"></textarea></div>
    <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-top:10px;">
        <div><label>Frequency</label><select id="colFreq"></select></div>
        <div><label>Status</label><select id="colStatus"></select></div>
        <div><label>Mnth</label><select id="colZ"></select></div>
    </div>
    <div style="display:grid; grid-template-columns:1fr 1fr 1fr 1fr; gap:8px; margin-top:10px;">
        <div><label>Each</label><input type="number" id="colT" placeholder="0.00" oninput="calc()"></div>
        <div><label>Cur</label><select id="colX" onchange="calc()"></select></div>
        <div><label>Fees</label><input type="number" id="colV" placeholder="0.00" oninput="calc()"></div>
        <div><label>Mul</label><input type="number" id="colM" value="1" oninput="calc()"></div>
    </div>
    <div class="total-box"><div class="total-val"><span id="symbol">¬£</span> <span id="totalDisp">0.00</span></div></div>
    <div class="actions">
        <button class="action-main" onclick="saveRow(false)" style="background:var(--accent);">Create Staging record</button>
        <button class="action-main" onclick="handleSync()" style="background:var(--bridge);">Send Staging records to Sheets</button>
        <button class="action-main" id="wipeBtn" onclick="clearData()" style="background:var(--danger); opacity: 0.85;">Clear Staging records</button>
    </div>
    <div class="preview-wrap" id="previewArea"></div>
    <div id="auth_status">iOS Sync Status: Idle</div>
    <button id="trace_btn" onclick="toggleLog()">Trace Log</button>
    <div id="trace_log"></div>
</div>

<div id="note_modal">
    <div class="modal-content">
        <label>Edit Note</label>
        <textarea id="modal_note_text" rows="4" style="margin-top:10px 0;"></textarea>
        <div style="display:flex; gap:10px;"><button onclick="commitNote()" style="flex:1; background:var(--accent); color:white; border:none; padding:10px; border-radius:6px;">Save</button><button onclick="closeNote()" style="flex:1; background:#7f8c8d; color:white; border:none; padding:10px; border-radius:6px;">Cancel</button></div>
    </div>
</div>

<script>
    const SHEET_ID = '1DdjG4B8wB9llk7yOoRRO72G0XqHEgFkMIlLuusShA6E';
    const VER = "Excel Budget Sheet Input (v3.02)";
    let AA_LIST = [], coordinateMap = {}, symbols = { "GBP": "¬£", "EUR": "‚Ç¨", "USD": "$" };
    let tokenClient, editIndex = -1, pendingEdit = -1, activeNoteIdx = -1, rawLookupData = [], wipeConfirmed = false, fetchTimer;

    function logTrace(msg) { const log = document.getElementById('trace_log'); log.innerText += `\n[${new Date().toLocaleTimeString()}] ${msg}`; log.scrollTop = log.scrollHeight; }
    function toggleLog() { const l = document.getElementById('trace_log'); l.style.display = (l.style.display === 'block') ? 'none' : 'block'; }
    function gapiLoaded() { gapi.load('client', async () => { await gapi.client.init({ apiKey: 'AIzaSyDvZ1XZw5bZgWSB9zaU7h9Vtn7MhDGFMSM' }); await gapi.client.load('sheets', 'v4'); logTrace("GAPI Ready."); checkSavedToken(); }); }
    
    function gisLoaded() { 
        tokenClient = google.accounts.oauth2.initTokenClient({ 
            client_id: '23231735212-jtgur3sn2ndh798ke00pm2a1d5rkd4eu.apps.googleusercontent.com', scope: 'https://www.googleapis.com/auth/spreadsheets', 
            callback: (resp) => { if (resp.access_token) { sessionStorage.setItem('ebs_token', resp.access_token); gapi.client.setToken({access_token: resp.access_token}); fetchLookupRefs(); } } 
        }); 
        logTrace("GIS Ready."); 
    }

    function checkSavedToken() {
        const saved = sessionStorage.getItem('ebs_token');
        if (saved) { gapi.client.setToken({ access_token: saved }); fetchLookupRefs(); }
    }

    function initRefresh() { 
        document.getElementById('auth_status').innerText = "Sync Status: Fetching Data...";
        fetchTimer = setTimeout(() => { if (document.getElementById('auth_status').innerText.includes("Fetching")) { document.getElementById('auth_status').innerText = "Sync Status: Timeout - Retry"; logTrace("Network Hang detected."); } }, 10000);
        tokenClient.requestAccessToken(); 
    }

    async function fetchLookupRefs() { 
        try {
            const res = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SHEET_ID, range: 'LookupRefs!A2:C15' });
            res.result.values.forEach(r => { coordinateMap[r[0]] = { val: colToIndex(r[1].toUpperCase().replace(/[0-9]/g, '')), desc: (r[2] && r[2].toLowerCase() !== 'n/a') ? colToIndex(r[2]) : null }; });
            fetchActiveAccounts();
        } catch (e) { logTrace("Refs Error."); }
    }

    function colToIndex(col) { let idx = 0; for(let i=0; i<col.length; i++) { idx = idx * 26 + (col.charCodeAt(i) - 64); } return idx - 1; }
    async function fetchActiveAccounts() { const res = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SHEET_ID, range: 'ActiveAccounts!A2:A500' }); AA_LIST = res.result.values ? res.result.values.flat().filter(v => v) : []; fetchActualData(); }
    async function fetchActualData() { const res = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SHEET_ID, range: 'Lookups!A2:AC1000' }); rawLookupData = res.result.values; populateUI(rawLookupData); clearTimeout(fetchTimer); document.getElementById('auth_status').innerText = "iOS Sync Status: Token Active"; alert("Lookup refresh completed."); }

    function populateUI(data) { const pop = (id, key, def, p = null) => { const list = data.filter(r => r[coordinateMap[key].val]).map(r => { const v = r[coordinateMap[key].val], d = coordinateMap[key].desc !== null ? r[coordinateMap[key].desc] : null; return d ? `${v} ${d}` : v; }); updateDropdown(id, list, def, p); }; pop('colA','Grouping','Roy'); pop('colB','F/U','v'); pop('colF','Category',null,'--Select--'); pop('colH','From',null,'--Select--'); pop('colI','To',null,'--Select--'); pop('colFreq','Frequency','A'); pop('colStatus','Status','N'); pop('colZ','Month','NEW'); pop('colX','Currency','GBP'); localReset(); }
    function updateDropdown(id, vals, def, prompt) { const s = document.getElementById(id); let h = prompt ? `<option value="" disabled selected>${prompt}</option>` : ''; h += vals.map(v => `<option value="${v}">${v}</option>`).join(''); s.innerHTML = h; if(def) { const o = Array.from(s.options).find(opt => opt.value.startsWith(def)); if(o) s.value = o.value; } }
    function localReset() { ['colT','colV','colG','colK'].forEach(id => { const el = document.getElementById(id); if(el) el.value = ""; }); document.getElementById('colM').value = "1"; document.getElementById('workTypeDisplay').innerText = "--"; editIndex = -1; pendingEdit = -1; renderPreview(); calc(); }
    function handleAccTrigger() { const h = document.getElementById('colH').value, i = document.getElementById('colI').value, fu = document.getElementById('colB'), tD = document.getElementById('workTypeDisplay'), cat = document.getElementById('colF'), freq = document.getElementById('colFreq'); if (!h || !i || h.includes("--") || i.includes("--")) return; const fAA = AA_LIST.includes(h), tAA = AA_LIST.includes(i); let valE = fAA && tAA ? "xfer" : (!fAA && tAA ? "In" : "zOut"); tD.innerText = valE; if (valE === "xfer") { const xf = Array.from(fu.options).find(o => o.value.startsWith('xf')); if(xf) fu.value = xf.value; const k = Array.from(freq.options).find(o => o.value.startsWith('K')); if(k) freq.value = k.value; cat.value = "Transfer"; } }
    function handleCatTrigger() { if (document.getElementById('colF').value.startsWith('S')) { const s = Array.from(document.getElementById('colB').options).find(o => o.value.startsWith('S')); if(s) document.getElementById('colB').value = s.value; } }
    function handleDateChange() { const dStr = document.getElementById('colC').value; if(!dStr) return; const [y, m, d] = dStr.split('-').map(Number); logTrace("Date Set: " + new Date(y, m-1, d).toDateString()); }
    function calc() { const t = parseFloat(document.getElementById('colT').value)||0, u = parseFloat(document.getElementById('colM').value)||1, v = parseFloat(document.getElementById('colV').value)||0; const tot = ((t * u) + v).toFixed(2); document.getElementById('totalDisp').innerText = tot; return tot; }
    function handleManualFU() { if(document.getElementById('colB').value.startsWith('xf')) document.getElementById('colF').value = "Transfer"; }
    function initiateEdit(idx) { if (pendingEdit === idx) { editIndex = idx; pendingEdit = -1; const d = JSON.parse(localStorage.getItem('ebs_trf'))[idx]; const setUI = (id, val, isDrop = false) => { const el = document.getElementById(id); if(!el) return; if(!isDrop) el.value = val; else { const code = val.split(' ')[0]; const o = Array.from(el.options).find(opt => opt.value.startsWith(code)); if(o) el.value = o.value; } }; setUI('colA', d[0], true); setUI('colB', d[1], true); setUI('colC', d[2]); setUI('colF', d[5], true); setUI('colG', d[6]); setUI('colH', d[7], true); setUI('colI', d[8], true); setUI('colK', d[10]); setUI('colFreq', d[11], true); setUI('colStatus', d[14], true); setUI('colT', d[19]); setUI('colM', d[20]); setUI('colV', d[21]); setUI('colX', d[23], true); setUI('colZ', d[25], true); handleDateChange(); handleAccTrigger(); calc(); } else { pendingEdit = idx; editIndex = -1; } renderPreview(); }
    function openNote(idx) { activeNoteIdx = idx; document.getElementById('modal_note_text').value = JSON.parse(localStorage.getItem('ebs_trf'))[idx][10] || ""; document.getElementById('note_modal').style.display = 'block'; }
    function closeNote() { document.getElementById('note_modal').style.display = 'none'; }
    function commitNote() { let d = JSON.parse(localStorage.getItem('ebs_trf')); d[activeNoteIdx][10] = document.getElementById('modal_note_text').value; localStorage.setItem('ebs_trf', JSON.stringify(d)); closeNote(); renderPreview(); }
    function saveRow(isOverwrite) { const fv = document.getElementById('colF').value; if (!fv) return; const r = Array(35).fill(""); r[0]=document.getElementById('colA').value; r[1]=document.getElementById('colB').value; r[2]=document.getElementById('colC').value; r[5]=document.getElementById('colF').value; r[6]=document.getElementById('colG').value; r[7]=document.getElementById('colH').value; r[8]=document.getElementById('colI').value; r[10]=document.getElementById('colK').value; r[11]=document.getElementById('colFreq').value; r[14]=document.getElementById('colStatus').value; r[19]=parseFloat(document.getElementById('colT').value||0).toFixed(2); r[20]=document.getElementById('colM').value; r[21]=parseFloat(document.getElementById('colV').value||0).toFixed(2); r[22]=calc(); r[23]=document.getElementById('colX').value; r[25]=document.getElementById('colZ').value; let d = JSON.parse(localStorage.getItem('ebs_trf') || '[]'); if (isOverwrite && editIndex > -1) { d[editIndex] = r; } else { d.push(r); } localStorage.setItem('ebs_trf', JSON.stringify(d)); localReset(); }
    function renderPreview() { const d = JSON.parse(localStorage.getItem('ebs_trf') || '[]'); let h = '<table><tr><th class="w-edit">E</th><th>Grp</th><th>F/U</th><th>Day</th><th>Date</th><th>Cat</th><th>sort</th><th>From</th><th>To</th><th class="w-note">Note</th><th class="w-freq">Frequency</th><th>Cur</th><th class="w-tot">Total</th><th>Mnth</th><th>Stat</th><th>Who</th><th class="w-del">Del</th></tr>'; d.forEach((r, i) => { let bS = pendingEdit === i ? "background:red" : (editIndex === i ? "background:#f39c12" : "background:#3498db"); h += `<tr><td><button onclick="initiateEdit(${i})" style="${bS};color:white;border:none;border-radius:4px;width:22px;">${pendingEdit===i?'...':(editIndex===i?'C':'E')}</button></td><td>${r[0]}</td><td>${r[1]}</td><td>Day</td><td>${r[2]}</td><td>${r[5]}</td><td>${r[6]}</td><td>${r[7]}</td><td>${r[8]}</td><td onclick="openNote(${i})">${r[10]?'üìÑ':'‚ñ´Ô∏è'}</td><td>${r[11]}</td><td>${r[23]}</td><td class="w-tot">${r[22]}</td><td>${r[25]}</td><td>${r[14]}</td><td></td><td><button onclick="deleteRow(${i})" style="background:red;color:white;border:none;">X</button></td></tr>`; }); document.getElementById('previewArea').innerHTML = h + '</table>'; }
    function deleteRow(i) { let d = JSON.parse(localStorage.getItem('ebs_trf') || '[]'); d.splice(i, 1); localStorage.setItem('ebs_trf', JSON.stringify(d)); renderPreview(); }
    async function handleSync() { const d = JSON.parse(localStorage.getItem('ebs_trf') || '[]'); if (!d.length) return; tokenClient.requestAccessToken(); }
    function cachePull() { const c = localStorage.getItem('ebs_cache_data'); if (c) { rawLookupData = JSON.parse(c); coordinateMap = JSON.parse(localStorage.getItem('ebs_cache_coords')); AA_LIST = JSON.parse(localStorage.getItem('ebs_cache_aa')); populateUI(rawLookupData); } }
    function cacheSave() { localStorage.setItem('ebs_cache_data', JSON.stringify(rawLookupData)); localStorage.setItem('ebs_cache_coords', JSON.stringify(coordinateMap)); localStorage.setItem('ebs_cache_aa', JSON.stringify(AA_LIST)); }
    function clearData() { if(!wipeConfirmed) { wipeConfirmed=true; document.getElementById('wipeBtn').innerText="CONFIRM?"; setTimeout(()=>{wipeConfirmed=false; document.getElementById('wipeBtn').innerText="Clear Staging records";},3000); } else { localStorage.removeItem('ebs_trf'); wipeConfirmed=false; renderPreview(); } }
    window.onload = () => { document.getElementById('colC').value = new Date().toISOString().split('T')[0]; gapiLoaded(); gisLoaded(); renderPreview(); };
</script>
</body>
</html>
