<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>EBS Entry v3-08</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js" async defer></script>
  <style>
    :root { --primary: #2c3e50; --accent: #27ae60; --danger: #c0392b; --bg: #f8f9fa; --bridge: #2980b9; --cache: #8e44ad; --test: #e67e22; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); margin: 0; padding: 10px; }
    .container { max-width: 960px; margin: auto; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    .branding-row { margin-bottom: 10px; font-size: 1.1rem; line-height: 1.1; color: var(--primary); }
    .branding-row b { font-weight: bold; }
    .branding-row span { font-weight: 400; font-size: 0.75rem; color: #7f8c8d; margin-left: 5px; }
    .header-wrap { display: flex; flex-direction: column; margin-bottom: 15px; gap: 8px; }
    .header-btns { display: flex; justify-content: space-between; gap: 4px; width: 100%; }
    .btn-lookup { padding: 2px; font-size: 0.72rem; border-radius: 6px; border: none; color: white; cursor: pointer; font-weight: 600; flex: 1; height: 50px; line-height: 1.1; text-align: center; display: flex; align-items: center; justify-content: center; min-width: 0; }
    .btn-pull { background: var(--cache); } .btn-refresh { background: var(--bridge); } .btn-save { background: var(--accent); } .btn-test { background: var(--test); } .btn-reset { background: var(--danger); }
    label { font-size: 0.7rem; font-weight: 700; display: block; margin-bottom: 2px; color: var(--primary); }
    input, select, textarea { width: 100%; padding: 8px; border: 1px solid #dcdde1; border-radius: 6px; font-size: 16px; box-sizing: border-box; height: 38px; -webkit-text-size-adjust: 100%; font-family: inherit; }
    .date-input-container { display: flex; align-items: center; gap: 5px; background: white; border: 1px solid #dcdde1; border-radius: 6px; padding: 0 8px; height: 38px; }
    .date-input-container input[type="date"] { border: none; padding: 0; height: 100%; font-size: 14px; flex-grow: 1; outline: none; background: transparent; }
    .flow-display { font-size: 0.85rem; font-weight: bold; color: var(--primary); text-align: center; height: 38px; line-height: 36px; border: 1px solid #dcdde1; border-radius: 6px; background: #f1f2f6; box-sizing: border-box; }
    .total-box { background: #e8f5e9; border: 2px dashed var(--accent); padding: 10px; border-radius: 8px; text-align: center; margin: 15px 0; }
    .total-val { font-size: 1.3rem; font-weight: bold; color: var(--accent); }
    .actions { display: grid; grid-template-columns: 1fr 1fr 1.2fr; gap: 8px; }
    button.action-main { padding: 10px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; color: white; font-size: 0.72rem; -webkit-font-smoothing: antialiased; }
    .preview-wrap { width: 100%; overflow-x: auto; margin-top: 15px; border: 1px solid #ddd; border-radius: 6px; }
    table { width: 1400px; border-collapse: collapse; font-size: 0.58rem; table-layout: fixed; font-family: inherit; }
    th, td { border: 1px solid #eee; padding: 6px 3px; text-align: left; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    th { background: #f2f2f2; font-weight: bold !important; color: var(--primary); font-size: 0.58rem !important; }
    .w-edit { width: 35px; text-align: center; } .w-day { width: 30px; text-align: center; } .w-date { width: 70px; }
    .w-flow { width: 40px; text-align: center; } .w-sort { width: 30px; text-align: center; }
    .w-note { width: 40px; text-align: center; cursor: pointer; font-size: 1rem; }
    .w-freq { width: 100px; } .w-month { width: 55px; text-align:center; }
    .w-tot { width: 80px; text-align: right; } .w-who { width: 45px; text-align:center; } .w-del { width: 30px; text-align: center; }

    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
    .modal-content { background: white; margin: 15% auto; padding: 20px; width: 88%; max-width: 420px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); }

    #auth_status { font-size: 0.75rem; margin-top: 10px; text-align: center; color: var(--primary); font-weight: 600; }
    #log_btn { margin-top: 15px; width: 100%; background: var(--primary); color: white; font-size: 0.7rem; border-radius: 6px; padding: 8px; border: none; font-weight: 600; display: block; }
    #trace_log { display: none; margin-top: 15px; padding: 10px; background: #2c3e50; color: #00ff00; font-family: "Courier New", monospace; font-size: 0.6rem; border-radius: 6px; max-height: 150px; overflow-y: auto; white-space: pre-wrap; cursor: pointer; }

    .calc-input-wrap { display: flex; align-items: center; gap: 4px; }
    .btn-calc-trigger { background: var(--bridge); color: white; border: none; border-radius: 4px; height: 38px; width: 30px; cursor: pointer; font-weight: bold; }

    /* v3-08: Calculator modal styling */
    .calc-row { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 8px; margin-top: 10px; }
    .calc-btn { padding: 12px 8px; border: none; border-radius: 8px; font-weight: 800; cursor: pointer; background: #f1f2f6; color: var(--primary); font-size: 1rem; }
    .calc-btn.op { background: #dfe6e9; }
    .calc-btn.danger { background: var(--danger); color: white; }
    .calc-btn.bridge { background: var(--bridge); color: white; }
    .calc-btn.accent { background: var(--accent); color: white; }
    .calc-display { font-size: 0.85rem; color: #7f8c8d; margin-top: 6px; }
    .calc-result { font-size: 1.2rem; font-weight: 900; color: var(--primary); margin-top: 4px; }

    .txt-center { text-align: center; }
  </style>
</head>
<body>
<div class="container">
  <div class="header-wrap">
    <div class="branding-row"><b>EBS Input</b> <span>v3-08</span></div>
    <div class="header-btns">
      <button class="btn-lookup btn-pull" onclick="checkEditState(() => cachePull())">Pull local<br>Lookups</button>
      <button class="btn-lookup btn-refresh" id="refresh_btn" onclick="checkEditState(() => initRefresh())">Refresh<br>Lookups<br>from Sheets</button>
      <button class="btn-lookup btn-save" onclick="checkEditState(() => cacheSave())">Save to<br>local Lookups</button>
      <button class="btn-lookup btn-test" onclick="checkEditState(() => useTestData())">Pull test<br>Lookups</button>
      <button class="btn-lookup btn-reset" id="resetBtn" onclick="handleResetConfirm()">Reset</button>
    </div>
  </div>

  <div style="display:grid; grid-template-columns: 0.8fr 1fr 1.2fr; gap:10px;">
    <div><label>Type</label><select id="colB" onchange="handleManualFU()"></select></div>
    <div><label>Grouping</label><select id="colA"></select></div>
    <div><label>Date</label>
      <div class="date-input-container" onclick="document.getElementById('colC').showPicker()">
        <span>ðŸ“…</span><input type="date" id="colC" onchange="handleDateChange()">
      </div>
      <div id="colCDisp" style="font-size:0.65rem; color:#7f8c8d; text-align:center; margin-top:2px;"></div>
    </div>
  </div>

  <div style="display:grid; grid-template-columns: 1fr 0.4fr 0.3fr; gap:10px; margin-top:10px;">
    <div><label>Category</label><select id="colF" required onchange="handleCatTrigger()"></select></div>
    <div><label style="text-align:center;">Flow</label><div id="flowDisplay" class="flow-display">--</div></div>
    <div><label>Sort</label><input type="number" id="colG" placeholder="0" onfocus="this.value=''"></div>
  </div>

  <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
    <div><label>From</label><select id="colH" required onchange="handleAccTrigger()"></select></div>
    <div><label>To</label><select id="colI" required onchange="handleAccTrigger()"></select></div>
  </div>

  <div style="margin-top:10px;"><label>Note</label><textarea id="colK" rows="2" style="font-size:16px;"></textarea></div>

  <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-top:10px;">
    <div><label>Frequency</label><select id="colFreq"></select></div>
    <div><label>Status</label><select id="colStatus"></select></div>
    <div><label>Month</label><select id="colZ"></select></div>
  </div>

  <div style="display:grid; grid-template-columns:1.2fr 1fr 1fr 1fr; gap:8px; margin-top:10px;">
    <div><label>Each</label>
      <div class="calc-input-wrap">
        <input type="number" id="colT" placeholder="0.00" step="0.01" onfocus="this.value=''" oninput="calc()">
        <button class="btn-calc-trigger" onclick="openCalculatorHook()">Â±</button>
      </div>
    </div>
    <div><label>Currency</label><select id="colX" onchange="calc()"></select></div>
    <div><label>Fees</label><input type="number" id="colV" placeholder="0.00" step="0.01" onfocus="this.value=''" oninput="calc()"></div>
    <div><label>Multiplier</label><input type="number" id="colM" value="1" step="0.01" oninput="calc()"></div>
  </div>

  <div class="total-box"><div class="total-val"><span id="symbol">Â£</span> <span id="totalDisp">0.00</span></div></div>

  <div class="actions">
    <button class="action-main" onclick="handleMainAction('create')" style="background:var(--accent);">Create Staging record</button>
    <button class="action-main" id="sync_btn" onclick="checkEditState(() => handleSync())" style="background:var(--bridge);">Send Staging records to Sheets</button>
    <button class="action-main" id="wipeBtn" onclick="handleWipeConfirm()" style="background:var(--danger); opacity: 0.85;">Clear Staging records</button>
  </div>

  <div class="preview-wrap" id="previewArea"></div>
  <div id="auth_status">iOS Sync Status: Idle</div>
  <button id="log_btn" onclick="toggleLog(true)">Display Trace Log</button>
  <div id="trace_log" onclick="toggleLog(false)">Trace: v3-08 Logic Circuit Breaker active.</div>
</div>

<div id="flow_modal" class="modal">
  <div class="modal-content">
    <label style="font-size:1rem; margin-bottom:15px;">Flow cannot be determined - select manually</label>
    <select id="modal_flow_select" style="margin-bottom:20px;">
      <option value="xfer">xfer</option>
      <option value="In">In</option>
      <option value="zOut">zOut</option>
    </select>
    <div style="display:flex; gap:10px;">
      <button onclick="commitFlowSelection()" style="flex:1; background:var(--accent); color:white; padding:10px; border-radius:6px; border:none; font-weight:bold;">OK</button>
      <button onclick="closeFlowModal()" style="flex:1; background:#7f8c8d; color:white; padding:10px; border-radius:6px; border:none; font-weight:bold;">Cancel</button>
    </div>
  </div>
</div>

<div id="note_modal" class="modal">
  <div class="modal-content">
    <label>Edit Transaction Note</label>
    <textarea id="modal_note_text" rows="4" style="margin-top:10px;"></textarea>
    <div style="display:flex; gap:10px; margin-top:15px;">
      <button onclick="commitNote()" style="flex:1; background:var(--accent); color:white; padding:10px; border-radius:6px; border:none; font-weight:bold;">Save Note</button>
      <button onclick="closeNote()" style="flex:1; background:#7f8c8d; color:white; padding:10px; border-radius:6px; border:none; font-weight:bold;">Cancel</button>
    </div>
  </div>
</div>

<!-- v3-08: Each-field calculator modal -->
<div id="calc_modal" class="modal">
  <div class="modal-content">
    <label style="font-size:1rem;">Calculator</label>
    <div class="calc-display">Expression</div>
    <input id="calc_expr" type="text" inputmode="decimal" autocomplete="off" spellcheck="false" style="margin-top:6px;">
    <div class="calc-display">Result</div>
    <div id="calc_result" class="calc-result">0.00</div>

    <div class="calc-row">
      <button class="calc-btn danger" onclick="calcClear()">C</button>
      <button class="calc-btn op" onclick="calcBack()">âŒ«</button>
      <button class="calc-btn op" onclick="calcAppend('(')">(</button>
      <button class="calc-btn op" onclick="calcAppend(')')">)</button>

      <button class="calc-btn" onclick="calcAppend('7')">7</button>
      <button class="calc-btn" onclick="calcAppend('8')">8</button>
      <button class="calc-btn" onclick="calcAppend('9')">9</button>
      <button class="calc-btn op" onclick="calcAppend('/')">Ã·</button>

      <button class="calc-btn" onclick="calcAppend('4')">4</button>
      <button class="calc-btn" onclick="calcAppend('5')">5</button>
      <button class="calc-btn" onclick="calcAppend('6')">6</button>
      <button class="calc-btn op" onclick="calcAppend('*')">Ã—</button>

      <button class="calc-btn" onclick="calcAppend('1')">1</button>
      <button class="calc-btn" onclick="calcAppend('2')">2</button>
      <button class="calc-btn" onclick="calcAppend('3')">3</button>
      <button class="calc-btn op" onclick="calcAppend('-')">âˆ’</button>

      <button class="calc-btn" onclick="calcAppend('0')">0</button>
      <button class="calc-btn" onclick="calcAppend('.')">.</button>
      <button class="calc-btn bridge" onclick="calcEquals()">=</button>
      <button class="calc-btn op" onclick="calcAppend('+')">+</button>
    </div>

    <div style="display:flex; gap:10px; margin-top:12px;">
      <button class="calc-btn" style="flex:1;" onclick="closeCalcModal()">Cancel</button>
      <button class="calc-btn accent" style="flex:1;" onclick="calcApply()">Apply</button>
    </div>
  </div>
</div>

<script>
  const SHEET_ID = '1DdjG4B8wB9llk7yOoRRO72G0XqHEgFkMIlLuusShA6E';
  const VER = "Excel Budget Sheet Input (v3-08)";

  const TOKEN_KEY = 'g_token';
  const TOKEN_EXP_KEY = 'g_token_exp_ms';
  const TOKEN_ISSUED_AT_KEY = 'g_token_issued_ms'; // v3-08: persisted issuance timestamp to avoid needless login prompts

  const STAGING_SHEET_NAME = 'EBSinput';
  const STAGING_END_COL = 'AI';
  const STAGING_COLS = 35;
  const STAGING_START_ROW = 2;

  let AA_LIST = [],
      coordinateMap = {},
      symbols = { "GBP": "Â£", "EUR": "â‚¬", "USD": "$", "ZAR": "R", "CHF": "Fr", "THB": "à¸¿", "RUR": "â‚½", "COP": "COL$" };

  let tokenClient,
      editIndex = -1,
      pendingEdit = -1,
      activeNoteIdx = -1,
      rawLookupData = [],
      wipeConfirmed = false,
      resetConfirmed = false,
      isRestoring = false;

  let flowModalContext = 'create';
  let gapiReady = false;

  let tokenPurpose = null;
  let tokenPromiseResolve = null;
  let tokenPromiseReject = null;

  let stagingSheetIdCache = null;

  let calcLastValue = null;

  function logTrace(msg) {
    console.log(msg);
    const log = document.getElementById('trace_log');
    const now = new Date().toLocaleTimeString();
    log.innerText += `\n[${now}] ${msg}`;
    log.scrollTop = log.scrollHeight;
  }

  function toggleLog(show) {
    document.getElementById('log_btn').style.display = show ? 'none' : 'block';
    document.getElementById('trace_log').style.display = show ? 'block' : 'none';
  }

  function gapiLoaded() {
    gapi.load('client', async () => {
      await gapi.client.init({ apiKey: 'AIzaSyDvZ1XZw5bZgWSB9zaU7h9Vtn7MhDGFMSM' });
      await gapi.client.load('sheets', 'v4');
      gapiReady = true;
      logTrace("GAPI Ready. (v3-08)");
    });
  }

  function gisLoaded() {
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: '23231735212-jtgur3sn2ndh798ke00pm2a1d5rkd4eu.apps.googleusercontent.com',
      scope: 'https://www.googleapis.com/auth/spreadsheets',
      callback: async (resp) => {
        if (resp && resp.error) {
          logTrace(`Token Error: ${resp.error} (v3-08)`);
          updateStatus("Token Error", "error");
          if (tokenPromiseReject) tokenPromiseReject(new Error(resp.error));
          tokenPromiseResolve = null; tokenPromiseReject = null; tokenPurpose = null;
          return;
        }

        if (resp && resp.access_token) {
          localStorage.setItem(TOKEN_KEY, resp.access_token);
          localStorage.setItem(TOKEN_ISSUED_AT_KEY, String(Date.now())); // v3-08

          // v3-08: expires_in is not always returned in all environments; default to 50 minutes when missing
          const expiresInSec = Number(resp.expires_in || 0);
          const fallbackMs = 50 * 60 * 1000;
          const expMs = (expiresInSec > 0)
            ? (Date.now() + Math.max(0, (expiresInSec * 1000) - 60000))
            : (Date.now() + fallbackMs);
          localStorage.setItem(TOKEN_EXP_KEY, String(expMs));

          if (gapi && gapi.client && typeof gapi.client.setToken === 'function') {
            gapi.client.setToken({ access_token: resp.access_token });
          }

          logTrace(`Token Received. expires_in=${expiresInSec}s Purpose=${tokenPurpose || 'none'} (v3-08)`);

          const p = tokenPurpose;
          tokenPurpose = null;

          if (tokenPromiseResolve) tokenPromiseResolve(resp.access_token);
          tokenPromiseResolve = null; tokenPromiseReject = null;

          if (p === 'refresh') fetchLookupRefs();
        }
      }
    });
    logTrace("GIS Ready. (v3-08)");
  }

  function updateStatus(label, state) {
    const el = document.getElementById('auth_status');
    el.innerText = `iOS Sync Status: ${label}`;
    const colors = { "idle": "#7f8c8d", "active": "#27ae60", "sync": "#e67e22", "error": "#c0392b" };
    el.style.color = colors[state] || colors.idle;
  }

  function checkEditState(onSuccess) {
    if (pendingEdit !== -1 || editIndex !== -1) { alert("Function locked during Edit."); return; }
    onSuccess();
  }

  function initRefresh() { tokenPurpose = 'refresh'; logTrace("Refresh requested: token prompt allowed. (v3-08)"); tokenClient.requestAccessToken({ prompt: 'consent' }); }

  function ensureToken(purpose, force = false) {
    // v3-08: Prevent unnecessary Google account chooser pop-ups.
    // Rule: if a cached token exists, attempt to use it without prompting; only prompt after a real auth failure (401).
    const existing = localStorage.getItem(TOKEN_KEY);
    const expMs = Number(localStorage.getItem(TOKEN_EXP_KEY) || 0);

    // v3-08: If expiry is unknown (0), treat token as usable and rely on 401 retry logic.
    const valid = !!existing && (expMs === 0 || Date.now() < expMs);

    if (!force && valid) {
      if (gapi && gapi.client && typeof gapi.client.setToken === 'function') {
        gapi.client.setToken({ access_token: existing });
      }
      logTrace("Using cached token (no prompt). (v3-08)");
      return Promise.resolve(existing);
    }

    return new Promise((resolve, reject) => {
      tokenPurpose = purpose;
      tokenPromiseResolve = resolve;
      tokenPromiseReject = reject;

      // v3-08: prompt="" attempts silent reuse; prompt="consent" is only used after auth failure retry.
      const promptMode = force ? 'consent' : '';
      tokenClient.requestAccessToken({ prompt: promptMode });
    });
  }

  function clearStoredToken() {
    localStorage.removeItem(TOKEN_KEY);
    localStorage.removeItem(TOKEN_EXP_KEY);
    localStorage.removeItem(TOKEN_ISSUED_AT_KEY); // v3-08
    if (gapi && gapi.client && typeof gapi.client.setToken === 'function') {
      gapi.client.setToken(null);
    }
  }

  async function fetchLookupRefs() {
    updateStatus("Fetching Refs...", "sync");
    const res = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SHEET_ID, range: 'LookupRefs!A2:C15' });
    res.result.values.forEach(r => {
      coordinateMap[r[0]] = {
        val: colToIndex(r[1].toUpperCase().replace(/[0-9]/g, '')),
        desc: (r[2] && r[2].toLowerCase() !== 'n/a') ? colToIndex(r[2]) : null
      };
    });
    fetchActiveAccounts();
  }

  function colToIndex(col) { let idx = 0; for (let i = 0; i < col.length; i++) idx = idx * 26 + (col.charCodeAt(i) - 64); return idx - 1; }

  async function fetchActiveAccounts() {
    const res = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SHEET_ID, range: 'ActiveAccounts!A2:A500' });
    AA_LIST = res.result.values ? res.result.values.flat().filter(v => v) : [];
    fetchActualData();
  }

  async function fetchActualData() {
    const res = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SHEET_ID, range: 'Lookups!A2:AC1000' });
    rawLookupData = res.result.values;
    populateUI(rawLookupData);
    updateStatus("Token Active", "active");
    alert("Refresh complete.");
  }

  function populateUI(data) {
    const pop = (id, key, def, p = null) => {
      const list = data.filter(r => r[coordinateMap[key].val]).map(r => {
        const v = r[coordinateMap[key].val], d = coordinateMap[key].desc !== null ? r[coordinateMap[key].desc] : null;
        return d ? `${v} ${d}` : v;
      });
      updateDropdown(id, list, def, p);
    };
    pop('colA','Grouping','Roy');
    pop('colB','F/U','v');
    pop('colF','Category',null,'--Select--');
    pop('colH','From',null,'--Select--');
    pop('colI','To',null,'--Select--');
    pop('colFreq','Frequency','A');
    pop('colStatus','Status','N');
    pop('colZ','Month','NEW');
    pop('colX','Currency','GBP');
    localReset();
  }

  function updateDropdown(id, vals, def, prompt) {
    const s = document.getElementById(id);
    let h = prompt ? `<option value="" disabled selected>${prompt}</option>` : '';
    h += vals.map(v => `<option value="${v}">${v}</option>`).join('');
    s.innerHTML = h;
    if (def) {
      const o = Array.from(s.options).find(opt => opt.value.startsWith(def));
      if (o) s.value = o.value;
    }
  }

  function useTestData() {
    if (!confirm("Load test set?")) return;
    AA_LIST = ["Santander P (AA)", "Revolut P (AA)"];
    coordinateMap = {"Grouping":{val:0},"F/U":{val:1},"Category":{val:2},"From":{val:3},"To":{val:4},"Frequency":{val:5},"Status":{val:6},"Month":{val:7},"Currency":{val:8}};
    rawLookupData = [["INIT"]];
    updateDropdown('colA', ["Roy", "Ev"], 'Roy');
    updateDropdown('colB', ["v Verified", "xf Transfer", "S Support"], 'v');
    updateDropdown('colF', ["Food", "Support Samara", "Transfer"], null, '--Select--');
    updateDropdown('colH', AA_LIST, null, '--Select--');
    updateDropdown('colI', AA_LIST, null, '--Select--');
    updateDropdown('colFreq', ["A Ad-hoc", "M Monthly"], 'A');
    updateDropdown('colStatus', ["N Pending"], 'N');
    updateDropdown('colZ', ["NEW"], 'NEW');
    updateDropdown('colX', ["GBP"], 'GBP');
    localReset();
  }

  function cacheSave() {
    if (rawLookupData.length === 0) { alert("Refresh Lookups First"); return; }
    if (!confirm("Snapshot values?")) return;
    localStorage.setItem('ebs_cache_data', JSON.stringify(rawLookupData));
    localStorage.setItem('ebs_cache_coords', JSON.stringify(coordinateMap));
    localStorage.setItem('ebs_cache_aa', JSON.stringify(AA_LIST));
  }

  function cachePull() {
    if (!confirm("Load local Lookups?")) return;
    const cached = localStorage.getItem('ebs_cache_data');
    if (cached) {
      rawLookupData = JSON.parse(cached);
      coordinateMap = JSON.parse(localStorage.getItem('ebs_cache_coords'));
      AA_LIST = JSON.parse(localStorage.getItem('ebs_cache_aa'));
      populateUI(rawLookupData);
    }
  }

  function localReset() {
    editIndex = -1;
    pendingEdit = -1;
    logTrace("UI Reset Invoked. (v3-08)");

    ['colT','colV','colG','colK'].forEach(id => { const el = document.getElementById(id); if (el) el.value = ""; });
    document.getElementById('colM').value = "1";
    document.getElementById('flowDisplay').innerText = "--";

    const rS = (id, def) => {
      const s = document.getElementById(id);
      if (!s) return;
      if (def) {
        const o = Array.from(s.options).find(opt => opt.value.startsWith(def));
        if (o) s.value = o.value;
      } else s.selectedIndex = 0;
    };

    rS('colA','Roy'); rS('colB','v'); rS('colF',null); rS('colH',null); rS('colI',null);
    rS('colFreq','A'); rS('colStatus','N'); rS('colZ','NEW'); rS('colX','GBP');

    calc();
    renderPreview();
    logTrace("UI Fields Reset. (v3-08)");
  }

  function handleResetConfirm() {
    const btn = document.getElementById('resetBtn');
    if (!resetConfirmed) {
      resetConfirmed = true;
      btn.innerText = "CONFIRM?";
      setTimeout(() => { resetConfirmed = false; btn.innerText = "Reset"; }, 3000);
    } else {
      localReset();
      resetConfirmed = false;
      btn.innerText = "Reset";
    }
  }

  function handleWipeConfirm() {
    const btn = document.getElementById('wipeBtn');
    if (!wipeConfirmed) {
      wipeConfirmed = true;
      btn.innerText = "CONFIRM?";
      setTimeout(() => { wipeConfirmed = false; btn.innerText = "Clear Staging records"; }, 3000);
    } else {
      localStorage.removeItem('ebs_trf');
      wipeConfirmed = false;
      btn.innerText = "Clear Staging records";
      renderPreview();
      logTrace("Staging wiped. (v3-08)");
    }
  }

  function handleAccTrigger() {
    if (isRestoring) return;
    const h = document.getElementById('colH').value, i = document.getElementById('colI').value, ty = document.getElementById('colB');
    const fAA = AA_LIST.includes(h), tAA = AA_LIST.includes(i);
    let valE = "zOut";
    if (fAA && tAA) valE = "xfer";
    else if (!fAA && tAA) valE = "In";
    document.getElementById('flowDisplay').innerText = valE;
    if (valE === "xfer") {
      const xf = Array.from(ty.options).find(o => o.value.startsWith('xf'));
      if (xf) ty.value = xf.value;
      document.getElementById('colF').value = "Transfer";
    }
  }

  function isSupportCategory(cat) { return (cat || "").toLowerCase().includes("support"); }

  function handleCatTrigger() {
    if (isRestoring) return;

    const cat = document.getElementById('colF').value || "";
    if (isSupportCategory(cat)) {
      const fu = document.getElementById('colB');
      const s = Array.from(fu.options).find(o => o.value.startsWith('S'));
      if (s) fu.value = s.value;

      const fr = document.getElementById('colFreq');
      const a = Array.from(fr.options).find(o => o.value && o.value.startsWith('A'));
      if (a) fr.value = a.value;
      logTrace("Support category selected: Frequency forced to Ad-hoc. (v3-08)");
    }
  }

  function handleManualFU() { }

  function handleDateChange() {
    const dStr = document.getElementById('colC').value;
    if (!dStr) { document.getElementById('colCDisp').innerText = ""; return; }
    const [y, m, d] = dStr.split('-').map(Number);
    const dt = new Date(y, m - 1, d);
    document.getElementById('colCDisp').innerText =
      `${['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][dt.getDay()]} ${dt.getDate()} ${['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][dt.getMonth()]} '${String(dt.getFullYear()).substr(-2)}`;
  }

  function calc() {
    const t = parseFloat(document.getElementById('colT').value) || 0,
          u = parseFloat(document.getElementById('colM').value) || 1,
          v = parseFloat(document.getElementById('colV').value) || 0;
    const tot = ((t * u) + v).toFixed(2);
    const curCode = document.getElementById('colX').value.split(' ')[0] || 'GBP';
    document.getElementById('symbol').innerText = symbols[curCode] || "Â£";
    document.getElementById('totalDisp').innerText = tot;
    return tot;
  }

  function buildFinalPackage() {
    const fv = document.getElementById('colF').value, hv = document.getElementById('colH').value, iv = document.getElementById('colI').value;
    if (!fv || !hv || !iv || fv.includes("--") || hv.includes("--") || iv.includes("--")) { alert("Missing data."); return null; }
    const flowV = document.getElementById('flowDisplay').innerText;
    if (flowV === "--") return { needsFlow: true };
    const whoV = isSupportCategory(fv) ? document.getElementById('colA').value : "";
    const finalPackage = [
      document.getElementById('colA').value, document.getElementById('colB').value, document.getElementById('colC').value,
      "", flowV, document.getElementById('colF').value, document.getElementById('colG').value,
      document.getElementById('colH').value, document.getElementById('colI').value, "",
      document.getElementById('colK').value, document.getElementById('colFreq').value, "", "",
      document.getElementById('colStatus').value, "", "", "", "",
      parseFloat(document.getElementById('colT').value || 0).toFixed(2), document.getElementById('colM').value,
      parseFloat(document.getElementById('colV').value || 0).toFixed(2), calc(),
      document.getElementById('colX').value, "", document.getElementById('colZ').value,
      "", "", "", "", "", "", "", whoV, VER
    ];
    return { needsFlow: false, finalPackage };
  }

  function handleMainAction(mode = 'create') {
    logTrace(`Action Triggered. Mode=${mode} (v3-08)`);
    if (rawLookupData.length === 0) { alert("Edit is only possible after Lookups are pulled or refreshed"); return; }

    const built = buildFinalPackage();
    if (!built) return;

    if (built.needsFlow) { flowModalContext = mode; openFlowModal(); return; }

    let masterList = JSON.parse(localStorage.getItem('ebs_trf') || '[]');
    if (mode === 'commit' && editIndex > -1) {
      masterList[editIndex] = built.finalPackage;
      logTrace(`Logic Update: Row ${editIndex} Overwritten (Commit). (v3-08)`);
    } else {
      masterList.push(built.finalPackage);
      logTrace("Logic Update: New Record Appended (Create). (v3-08)");
    }
    localStorage.setItem('ebs_trf', JSON.stringify(masterList));
    logTrace("Storage Synced. (v3-08)");
    localReset();
  }

  function initiateEdit(idx) {
    if (rawLookupData.length === 0) { alert("First Refresh Lookups or Pull local Lookups."); return; }
    const trs = document.getElementById('previewArea').getElementsByTagName('tr');
    const btn = trs[idx + 1].getElementsByTagName('button')[0];
    if (btn.innerText === 'C') { handleMainAction('commit'); return; }

    if (pendingEdit === idx) {
      isRestoring = true; editIndex = idx; pendingEdit = -1;
      const d = JSON.parse(localStorage.getItem('ebs_trf'))[idx];
      const setUI = (id, val, isDrop = false) => {
        const el = document.getElementById(id); if (!el) return;
        if (!isDrop) { el.value = val; return; }
        const opts = el.options;
        for (let i = 0; i < opts.length; i++) {
          if (opts[i].value === val || opts[i].text === val || opts[i].value === val + " (AA)") { el.selectedIndex = i; break; }
        }
      };
      setUI('colA', d[0], true); setUI('colB', d[1], true); setUI('colC', d[2]); setUI('colF', d[5], true);
      setUI('colG', d[6]); setUI('colH', d[7], true); setUI('colI', d[8], true); setUI('colK', d[10]);
      setUI('colT', d[19]); setUI('colV', d[21]); setUI('colM', d[20]); setUI('colZ', d[25], true);
      setUI('colFreq', d[11], true); setUI('colStatus', d[14], true);
      document.getElementById('flowDisplay').innerText = d[4] || "--";
      isRestoring = false; handleDateChange(); calc(); renderPreview();
      logTrace(`Active Edit: row ${idx + 1} (v3-08)`);
    } else { pendingEdit = idx; editIndex = -1; renderPreview(); }
  }

  function openFlowModal() { document.getElementById('flow_modal').style.display = 'block'; }
  function closeFlowModal() { document.getElementById('flow_modal').style.display = 'none'; }
  function commitFlowSelection() { const selected = document.getElementById('modal_flow_select').value; document.getElementById('flowDisplay').innerText = selected; closeFlowModal(); handleMainAction(flowModalContext); }

  function renderPreview() {
    const storageData = JSON.parse(localStorage.getItem('ebs_trf') || '[]');
    let h = '<table><tr>'
      + '<th class="w-edit">Edit</th><th>Grp</th><th>Type</th><th class="w-day">Day</th><th class="w-date">Date</th>'
      + '<th class="w-flow">Flow</th><th>Category</th><th class="w-sort">Sort</th><th>From</th><th>To</th>'
      + '<th class="w-note">Note</th><th class="w-freq">Frequency</th><th class="w-month">Month</th>'
      + '<th>Total</th><th class="w-who">Who</th><th class="w-del">Del</th></tr>';

    storageData.forEach((r, idx) => {
      let bS = (pendingEdit === idx) ? "background:red" : (editIndex === idx ? "background:#f39c12" : "background:#3498db");
      let bL = (pendingEdit === idx) ? "..." : (editIndex === idx ? "C" : "E");

      const parts = String(r[2] || "").split('-').map(Number);
      const y = parts[0], m = parts[1], dn = parts[2];
      const dt = (y && m && dn) ? new Date(y, m - 1, dn) : new Date();
      const dNam = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][dt.getDay()];
      const dStr = `${String(dt.getDate()).padStart(2,'0')} ${['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][dt.getMonth()]} '${String(dt.getFullYear()).substr(-2)}`;

      h += `<tr>
        <td class="w-edit"><button onclick="initiateEdit(${idx})" style="${b
